# Brainstorm应用案例：f-electron-scf项目优化

**日期：** 2026-02-11
**项目：** 稀土f电子SCF收敛问题解决方案
**方法：** 使用brainstorm hook进行风险驱动的任务分解优化

---

## 执行摘要

通过应用新实现的brainstorm hook系统，成功将f-electron-scf项目从原计划的7-9个月优化到5-6个月，节省约3个月时间。核心策略是**延迟高风险/高不确定性任务**，仅在验证显示必要时才执行。

---

## Brainstorm过程

### 1. 理解项目背景

**原始需求：**
- 解决ABACUS中稀土元素模守恒赝势的SCF收敛问题
- 覆盖多种应用场景（合金、磁性化合物、催化等）
- 涉及赝势生成、轨道优化、DFT+U算法、AI辅助初猜等

**原计划问题：**
- 赝势生成作为Phase 1阻塞一切（高风险、不可控）
- AI模型放在最后Phase 3（长关键路径）
- 所有功能全部实现（可能过度工程）
- 验证覆盖6个场景（学术完整性 vs 实际需求）

### 2. 风险识别

通过brainstorm对话，识别出以下高风险任务：

| 任务 | 风险类型 | 风险原因 |
|---|---|---|
| 赝势生成 | external_dependency | 依赖ONCVPSP工具，结果不确定，耗时数周 |
| NAO优化 | high_uncertainty | 不确定是否真正需要，可能默认设置已足够 |
| AI模型 | external_dependency + high_uncertainty | 需要大量训练数据，模型效果未知 |
| DFT+U全功能 | long_critical_path | 6个功能串行开发，可能部分不需要 |

### 3. 决策过程

对每个高风险任务，通过多轮问答确定策略：

**Q1: 赝势生成策略？**
- 选项A: 使用现有库，按需生成 ✓
- 选项B: Phase 1优先生成
- 选项C: 并行开发
- **决策：** A - 解耦算法开发和赝势不确定性

**Q2: AI初猜优先级？**
- 选项A: 完全延迟
- 选项B: Phase 3保持
- 选项C: 规则启发式先行 ✓
- **决策：** C - 简单规则可能已足够，避免过早ML

**Q3: NAO优化时机？**
- 选项A: 延迟到PW收敛后 ✓
- 选项B: Phase 1保持
- 选项C: 使用默认设置
- **决策：** C - 默认DZP先用，按需优化

**Q4: DFT+U开发节奏？**
- 选项A: 全部实现
- 选项B: 增量验证 ✓
- 选项C: 只做最高影响功能
- **决策：** B - 每个功能验证后再开发下一个

**Q5: 验证范围？**
- 选项A: 2-3代表系统 ✓
- 选项B: 全6场景
- 选项C: 用户需求驱动
- **决策：** C - 实际需求优先，避免学术完整性陷阱

**Q6: 项目时间线？**
- 选项A: 3-4个月
- 选项B: 5-6个月 ✓
- 选项C: 7-9个月
- **决策：** B - 平衡速度和生产就绪

### 4. 任务重组

基于决策，将任务重组为：

**活跃任务（19个）：**
- Phase 0: 代码集成+重构（4个）
- Phase 1: 基础收敛改进（4个）
- Phase 2: DFT+U策略（3个，增量验证）
- Phase 3: 用户场景验证（4个）
- Phase 4: 生产自动化（4个）

**延迟任务（8个）：**
- Category A: 自定义赝势（3个）→ 触发条件：验证误差>5%
- Category B: NAO优化（2个）→ 触发条件：LCAO偏差>3%
- Category C: ML模型（3个）→ 触发条件：规则失败率>20%

---

## Brainstorm Hook映射

### 任务状态映射

```python
# 活跃任务
Task(id="T0-1", status=TaskStatus.PENDING, risk_level="low")
Task(id="T1-1", status=TaskStatus.PENDING, risk_level="low")
...

# 延迟任务
Task(
    id="D-A1",
    status=TaskStatus.DEFERRED,
    risk_level="high",
    defer_trigger="T3-3:accuracy_below_threshold"
)
Task(
    id="D-C1",
    status=TaskStatus.DEFERRED,
    risk_level="high",
    defer_trigger="T1-4:failure_rate_above_20pct"
)
```

### 触发条件设计

| 延迟任务 | 触发条件 | 检查时机 |
|---|---|---|
| D-A1 (赝势生成) | T3-3:accuracy_below_threshold | T3-3完成后 |
| D-B1 (NAO优化) | T3-3:lcao_divergence_above_3pct | T3-3完成后 |
| D-C1 (ML数据) | T1-4:failure_rate_above_20pct | T1-4完成后 |
| D-A2 (自定义赝势) | D-A1:completed | D-A1完成后 |
| D-C2 (ML训练) | D-C1:completed | D-C1完成后 |

### 依赖关系处理

```python
# 原始依赖
T3-3.dependencies = ["T1-1", "T1-2", "T1-3", "T1-4", "T2-1", "T3-2"]

# 延迟任务的依赖被挂起
D-A2.dependencies = ["D-A1"]
D-A2.status = TaskStatus.DEFERRED
D-A2.suspended_dependencies = []  # 依赖也是延迟的，无需挂起

# 当D-A1被提升时，D-A2自动变为可执行
```

---

## 优化效果

### 时间节省

| 优化点 | 原计划 | 优化后 | 节省 |
|---|---|---|---|
| 赝势生成 | Phase 1阻塞（2个月） | 按需触发 | ~2个月 |
| NAO优化 | Phase 1串行（1个月） | 按需触发 | ~1个月 |
| AI模型 | Phase 3开发（2个月） | 规则先行 | ~2个月 |
| DFT+U | 全部实现（1个月） | 增量验证 | ~1个月 |
| 验证 | 6场景（1个月） | 用户驱动 | ~1个月 |
| **总计** | **7-9个月** | **5-6个月** | **~3个月** |

### 风险降低

| 风险 | 原计划 | 优化后 |
|---|---|---|
| 赝势质量不足 | 前期阻塞 | 后期按需处理 |
| AI模型效果差 | 后期发现 | 规则先行，ML可选 |
| 过度工程 | 全部实现 | 增量验证，按需开发 |
| 验证不足 | 学术完整 | 用户需求驱动 |

### 灵活性提升

- **适应性：** 可根据验证结果动态调整任务
- **可中断：** 每个Phase有明确门控，可随时停止
- **可扩展：** 延迟任务可在任何时候被提升

---

## 关键经验

### 1. YAGNI原则的应用

**You Aren't Gonna Need It** - 不要实现你不确定需要的功能

- 赝势生成：可能现有库已足够
- NAO优化：可能默认设置已足够
- AI模型：可能规则启发式已足够
- DFT+U全功能：可能部分功能已足够

**策略：** 延迟到验证显示确实需要时再实现

### 2. 风险驱动的优先级

**高风险任务特征：**
- 依赖外部工具/数据（external_dependency）
- 结果不确定（high_uncertainty）
- 阻塞大量下游任务（long_critical_path）

**策略：** 延迟高风险任务，优先低风险任务

### 3. 增量验证的价值

**传统方法：** 实现所有功能 → 一次性验证
**增量方法：** 实现一个功能 → 验证 → 决定是否继续

**优势：**
- 早期发现问题
- 避免无效工作
- 保持灵活性

### 4. 用户需求优先

**学术完整性陷阱：** 覆盖所有可能场景
**实际需求：** 只覆盖用户真正需要的场景

**策略：** 先调研用户需求，再选择验证场景

---

## Brainstorm Hook系统验证

### 功能验证

✓ **风险检测：** 成功识别8个高风险任务
✓ **任务延迟：** 正确设置defer_trigger
✓ **依赖管理：** 延迟任务的依赖链正确处理
✓ **触发条件：** 设计了5种不同的触发模式
✓ **状态序列化：** ProjectState正确保存/加载

### 实际应用价值

1. **时间节省：** 3个月（~40%）
2. **风险降低：** 高风险任务后置
3. **灵活性：** 可根据验证结果调整
4. **可追溯：** 所有决策有明确记录

---

## 后续工作

### 1. 执行Phase 0

- [ ] T0-1: 合并PW+LCAO DFT+U代码
- [ ] T0-2: 重构为可插拔架构
- [ ] T0-3: 建立回归测试
- [ ] T0-4: 收集现有赝势

### 2. 监控触发条件

在执行过程中，持续监控：
- T3-3验证精度（是否触发赝势生成）
- T1-4规则失败率（是否触发ML）
- LCAO vs PW偏差（是否触发NAO优化）

### 3. 记录Brainstorm结果

每次触发延迟任务时，记录：
```python
BrainstormResult(
    hook_name="after_task_complete",
    task_id="T3-3",
    question="Validation accuracy below threshold?",
    options=["defer", "promote"],
    answer="promote",
    action_taken="promoted D-A1, D-A2, D-A3",
    timestamp="2026-03-15T10:30:00"
)
```

---

## 结论

Brainstorm hook系统成功应用于f-electron-scf项目，通过风险驱动的任务延迟策略，将项目时间从7-9个月优化到5-6个月，节省约40%时间。关键成功因素：

1. **YAGNI原则：** 不实现不确定需要的功能
2. **风险识别：** 准确识别高风险/高不确定性任务
3. **增量验证：** 每个功能验证后再决定下一步
4. **用户驱动：** 实际需求优先于学术完整性
5. **灵活触发：** 明确的触发条件，可动态调整

这个案例验证了brainstorm hook系统的实用价值，为后续项目提供了可复用的模式。
