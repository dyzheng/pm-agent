# Specialist Plan-Execute Design

## Problem

The current `WorktreeSpecialist` passes entire tasks as a single `-p` prompt string to Claude Code. Complex tasks (multi-file C++ changes, pybind11 bindings) need to read dozens of files and make architectural decisions — a one-shot prompt can't handle this well. There's also no retry mechanism; partial success means starting from scratch.

Additionally, when tasks were dispatched via the Task tool (subagents), they shared the same Claude Code process context rather than running as truly independent processes.

## Solution

Refactor `WorktreeSpecialist` into a three-phase flow: **Prepare → Execute → Collect**.

- **Prepare**: Generate a detailed `PLAN.md` (step-by-step recipe) + `CLAUDE.md` (agent operating manual) in the worktree.
- **Execute**: Launch `claude -p "Read PLAN.md and execute it" --output-format json --cwd <worktree>`. Each task gets its own OS process — true parallelism with independent contexts.
- **Collect**: Parse `.pm-agent-result.json` from the worktree. If failed/partial, retry via `claude -p "feedback" --resume <session_id>`.

## Scope

Refactor `src/specialist.py` only. The existing pipeline (`scheduler.py`, `execute.py`, `hooks.py`) stays untouched. The `SpecialistBackend` protocol interface (`execute(brief) -> Draft`) is preserved.

## Architecture

### CLAUDE.md (same for all tasks)

Written into each worktree before agent launch. Tells the agent about conventions:

```markdown
# PM Agent Task Execution

You are an independent agent executing a task for the PM Agent orchestrator.

## Workflow
1. Read PLAN.md for your step-by-step instructions
2. Follow each step in order
3. Run tests as specified in the plan
4. Commit all changes with the commit message from the plan
5. Write `.pm-agent-result.json` before your final commit

## Result File Schema (.pm-agent-result.json)
{
  "status": "success" | "partial" | "failed",
  "commit_hash": "<HEAD after commit>",
  "changed_files": ["path/to/file.cpp", ...],
  "test_results": {"passed": N, "failed": N, "command": "...", "output": "..."},
  "summary": "One paragraph of what was done",
  "issues": ["unresolved issue 1", ...]
}

## Rules
- Do NOT modify files outside the scope listed in PLAN.md
- If a step fails, record it in issues and set status to "partial"
- Always commit, even if partial — the orchestrator handles retries
```

### PLAN.md (unique per task)

Generated by `PlanWriter` from `TaskBrief`. Structure:

```markdown
# Task: <title>

## Goal
<description>

## Step 1: Read existing code
- Read: <file paths>
- Understand: <what to look for>

## Step 2: Implement changes
- File: <path>
- <exact code or detailed instructions>

## Step 3: Write tests
- File: <test path>
- <test code or instructions>

## Step 4: Run tests and verify
- Command: <test command>
- Expected: all pass

## Commit Message
<conventional commit message>

## Acceptance Criteria
- [ ] <criterion 1>
- [ ] <criterion 2>
```

### Execution & Retry

```
1. create worktree (existing logic)
2. write CLAUDE.md + PLAN.md into worktree
3. launch: claude -p "Read PLAN.md and execute it step by step." \
              --output-format json --cwd <worktree_path>
4. parse JSON output → extract session_id
5. check worktree for .pm-agent-result.json
6. if result missing or status == "failed":
     retry up to max_retries via:
       claude -p "<feedback>" --resume <session_id> \
              --output-format json --cwd <worktree_path>
7. build Draft from result file + git state
```

- **Session ID**: `--output-format json` returns `{"session_id": "...", ...}`. Stored for `--resume`.
- **Retry feedback**: Includes what went wrong from the result file's `issues` field.
- **Timeout**: Configurable per attempt (default 600s). Timeout triggers retry.
- **Max retries**: Default 2 (up to 3 total attempts).
- **Fallback**: If all retries exhausted, return Draft with `explanation="FAILED: <issues>"`.

## Code Changes

| File | Action | ~Lines |
|------|--------|--------|
| `src/specialist.py` | Refactor WorktreeSpecialist, add PlanWriter | ~200 rewrite |
| `tests/test_specialist.py` | Add tests for launch/resume/collect flow | ~150 new |

### PlanWriter (new class, ~80 lines)

```python
class PlanWriter:
    CLAUDE_MD_TEMPLATE = "..."

    def write_plan(self, brief: TaskBrief, worktree_path: Path) -> None:
        self._write_claude_md(worktree_path)
        self._write_plan_md(brief, worktree_path)

    def _write_plan_md(self, brief: TaskBrief, path: Path) -> None:
        # Build step-by-step PLAN.md from TaskBrief fields
```

### WorktreeSpecialist (refactored, ~120 lines)

```python
class WorktreeSpecialist:
    def __init__(self, worktree_mgr, max_retries=2, timeout=600): ...

    def execute(self, brief: TaskBrief) -> Draft:
        # 1. create worktree
        # 2. PlanWriter.write_plan(brief, worktree_path)
        # 3. _launch_agent(worktree_path) → session_id
        # 4. _collect_result(worktree_path) → result dict
        # 5. retry loop if needed
        # 6. _build_draft(result, worktree_info) → Draft

    def _launch_agent(self, cwd: Path) -> tuple[str, str]: ...
    def _resume_agent(self, session_id: str, feedback: str, cwd: Path) -> str: ...
    def _collect_result(self, cwd: Path) -> dict | None: ...
    def _build_draft(self, result: dict, wt: WorktreeInfo) -> Draft: ...
```

## Testing

Mock `subprocess.run` to verify the flow without needing a real `claude` binary:

1. **test_plan_writer_generates_files**: PlanWriter creates CLAUDE.md + PLAN.md with correct content
2. **test_plan_writer_includes_all_brief_fields**: Plan includes audit context, deps, revision feedback
3. **test_launch_agent_captures_session_id**: Mocked claude returns JSON, session_id extracted
4. **test_collect_result_parses_json**: Result file parsed correctly
5. **test_collect_result_missing_file**: Returns None when no result file
6. **test_retry_on_failure**: Failed result triggers resume with feedback
7. **test_retry_on_timeout**: TimeoutExpired triggers resume
8. **test_max_retries_exhausted**: Returns FAILED draft after max retries
9. **test_success_no_retry**: Successful result returns Draft immediately
10. **test_build_draft_from_result**: Result JSON correctly mapped to Draft fields
11. **test_backward_compat_mock_specialist**: MockSpecialist still works unchanged
