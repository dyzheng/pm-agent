# QE DFPT Migration — 批判性分析报告

**日期：** 2026-02-21
**分析对象：** project_state.json（19 tasks, 6 phases）

---

## 问题 1：关键路径过长，串行链 12 步

**严重程度：HIGH**

从 DFPT-003 到 DFPT-501 形成了一条 12 步纯串行链：

```
DFPT-003 → 101 → 102 → 103 → 201 → 202 → 203 → 301 → 302 → 401 → 402 → 501
```

任何一个任务延迟都会 1:1 传导到项目交付日期。8 个 large 任务中有 3 个位于 depth≥8（DFPT-301, 402, 501），延迟风险极高。

**根因：** 依赖关系过于保守，把逻辑上可以并行的任务强制串行化了。

**建议：** 见问题 2 的依赖关系调整。

---

## 问题 2：4 条依赖关系值得质疑

### 2a. DFPT-301 (MPI并行) → DFPT-203 (电声耦合)

**现状：** MPI 并行化必须等电声耦合完成。
**问题：** k 点/q 点并行与 EPC 矩阵元计算无关。MPI 并行化的对象是 Sternheimer 求解器和 DFPT SCF，这些在 DFPT-202 完成后就已经可以并行化了。
**建议：** DFPT-301 改为依赖 DFPT-202。DFPT-203 与 DFPT-301 并行开发。

```
当前：  202 → 203 → 301 → 302  （串行 4 步）
建议：  202 → 301 → 302          （串行 3 步）
              ↘ 203 ↗            （203 与 301 并行，302 等两者都完成）
```

**关键路径影响：** 缩短 1 步。

### 2b. DFPT-401 (ESolver集成) → DFPT-302 (性能优化)

**现状：** ESolver 集成必须等性能优化完成。
**问题：** ESolver 是功能集成（把 DFPT 接入 ABACUS 主流程），与性能优化无关。先集成再优化是更常见的工程实践。
**建议：** DFPT-401 改为依赖 DFPT-301（并行化完成即可集成）。DFPT-302 与 DFPT-401 并行。

**关键路径影响：** 缩短 1 步。

### 2c. DFPT-302 (性能优化) → DFPT-301 (MPI并行)

**部分合理：** 并行性能优化确实需要并行化完成。但串行热点优化不需要。
**建议：** 保持依赖，但在 DFPT-201 完成后就开始串行性能 profiling（作为 DFPT-302 的前置工作，不需要改依赖）。

### 2d. DFPT-501 (集成测试) → DFPT-402 (q点工作流)

**现状：** 集成测试必须等 q 点工作流完成。
**问题：** 单 q 点的集成测试在 DFPT-401 完成后就可以开始。完整 q 网格测试才需要 DFPT-402。
**建议：** 拆分 DFPT-501 为 501a（单 q 点测试，依赖 401）和 501b（完整 q 网格测试，依赖 402）。或者保持现状但在 DFPT-401 后增加一个轻量级冒烟测试。

### 调整后的关键路径

```
当前（14 步）：
001 → 003 → 101 → 102 → 103 → 201 → 202 → 203 → 301 → 302 → 401 → 402 → 501 → 502

建议（12 步）：
001 → 003 → 101 → 102 → 103 → 201 → 202 → 301 → 401 → 402 → 501 → 502
                                              ↘ 203 ↗     ↘ 302 ↗
```

关键路径从 14 步缩短到 12 步，同时增加了 2 个并行化机会。

---

## 问题 3：DFPT-002 分支与主线完全脱钩

**严重程度：MEDIUM**

DFPT-002d 是叶子节点，没有任何主线任务依赖它。这意味着：

1. 代码审核工作流建好了，但没有机制强制主线任务使用它
2. 主线任务的验收标准写了"代码审核通过"，但这只是文字要求，不是依赖约束
3. 如果 DFPT-002 延迟或跳过，主线开发照常进行——审核质量无保障

**这是设计缺陷还是合理解耦？**

合理的一面：代码审核是质量保障手段，不应阻塞开发进度。
有问题的一面：如果审核工作流从未被实际使用，DFPT-002 的全部工作量就是浪费。

**建议：**
- 不改依赖关系（保持解耦）
- 在 DFPT-102/103/201/202 的验收标准中增加硬性要求："提交 code-review-agent 审查报告的 run_id"
- 在里程碑 M2/M3 的评审中检查审查报告是否存在

---

## 问题 4：验收标准质量参差不齐

**严重程度：MEDIUM**

8 个任务的验收标准存在问题：

| 任务 | 问题 |
|------|------|
| DFPT-001 | 缺少可测试标准（"设计文档通过技术评审"不可自动验证） |
| DFPT-103 | 缺少定量标准（"与 QE 参考结果一致"没有具体容差） |
| DFPT-201 | 缺少定量标准（"与 QE 收敛行为一致"没有具体指标） |
| DFPT-203 | 缺少定量标准（"与 QE 结果一致"没有具体容差） |
| DFPT-302 | 缺少可测试标准（"性能与 QE 相当或更优"没有具体比值） |
| DFPT-502 | 缺少可测试标准 |
| DFPT-503 | 缺少可测试标准 |

**建议补充的定量标准：**

- DFPT-103: "Sternheimer 求解器残差 < 1e-10，与 QE cgsolve_all 结果逐分量误差 < 1e-8"
- DFPT-201: "DFPT SCF 收敛到 drho < 1e-10 所需迭代次数与 QE 偏差 ≤ 2 次"
- DFPT-203: "EPC 矩阵元 |g| 与 QE 相对误差 < 1%，λ 与 QE 相对误差 < 5%"
- DFPT-302: "单 q 点计算时间 ≤ 1.2× QE，内存峰值 ≤ 1.5× QE"

---

## 问题 5：集成测试全部堆积在项目末期

**严重程度：HIGH**

DFPT-501（集成测试）位于 depth=12，是倒数第二层。所有端到端验证集中在项目最后阶段。

**风险：**
- 如果在 DFPT-501 阶段发现架构级问题（如数据流设计错误），修复成本极高
- 中间没有里程碑级别的集成验证点
- 单元测试能覆盖组件正确性，但无法验证组件间的集成

**建议：** 在 M2（核心 Kernel 完成）和 M3（声子计算完成）各增加一个轻量级集成冒烟测试：

- M2 冒烟测试：用 Si 体系跑一次 DVQPsiUS + Sternheimer，验证数据流通畅
- M3 冒烟测试：用 Si 体系跑一次完整 DFPT SCF + 动力学矩阵，验证声子频率

这不需要新增任务，可以作为 DFPT-103 和 DFPT-202 验收标准的一部分。

---

## 问题 6：两个任务的 type 标记不准确

**严重程度：LOW**

| 任务 | 当前 type | 问题 | 建议 |
|------|-----------|------|------|
| DFPT-002c | new | 描述中包含"迁移"关键词，实际是配置迁移工作流 | 保持 new（配置工作流确实是新建） |
| DFPT-103 | new | 标题是"迁移 Sternheimer 求解器"，实际是从 QE 移植 | 改为 extend（基于 QE 实现扩展到 ABACUS） |

DFPT-103 的 type=new 会误导优先级评估。移植工作的风险特征与全新开发不同——移植有参考实现，风险更可控，但需要更多的适配工作。

---

## 问题 7：DFPT-502/503 是低 ROI 叶子节点

**严重程度：LOW**

DFPT-502（用户文档）和 DFPT-503（开发者文档）是叶子节点，无下游依赖。如果项目进度紧张，这两个任务是最先被压缩的候选。

**建议：**
- 不删除，但标记为可延期（deferrable）
- 在开发过程中持续积累文档素材（每个任务完成时写简要笔记），降低最终文档编写的工作量
- 如果进度紧张，DFPT-503（开发者文档）优先于 DFPT-502（用户文档），因为开发者文档对后续维护更关键

---

## 问题汇总和建议优先级

| # | 问题 | 严重程度 | 建议动作 | 影响 |
|---|------|----------|----------|------|
| 1 | 串行链 12 步 | HIGH | 调整依赖关系（见 #2） | 关键路径缩短 2 步 |
| 2a | 301→203 不必要 | HIGH | 301 改为依赖 202 | 203 可并行 |
| 2b | 401→302 不必要 | HIGH | 401 改为依赖 301 | 302 可并行 |
| 3 | 002 与主线脱钩 | MEDIUM | 在 M2/M3 评审中检查审查报告 | 保障审核质量 |
| 4 | 验收标准缺定量 | MEDIUM | 补充 103/201/203/302 的定量标准 | 验收可执行 |
| 5 | 集成测试太晚 | HIGH | 在 M2/M3 增加冒烟测试 | 早期发现集成问题 |
| 6 | type 标记不准 | LOW | DFPT-103 改为 extend | 准确反映工作性质 |
| 7 | 文档任务低 ROI | LOW | 标记为可延期 | 进度紧张时有缓冲 |
