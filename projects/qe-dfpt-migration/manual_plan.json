{
  "project_id": "qe-dfpt-migration",
  "title": "QE PHonon DFPT Migration to ABACUS",
  "description": "将 Quantum ESPRESSO PHonon 包中的 DFPT 功能迁移到 ABACUS C++ 代码库",
  "phases": [
    {
      "id": "phase1",
      "name": "基础设施和架构设计",
      "tasks": [
        {
          "id": "DFPT-001",
          "title": "设计 ABACUS DFPT 模块架构",
          "layer": "infra",
          "type": "new",
          "description": "设计 DFPT 模块在 ABACUS 中的整体架构，包括：\n- 模块目录结构（module_dfpt/）\n- 与现有模块的接口（module_pw, module_hamilt_pw, module_elecstate）\n- 数据流设计（FFTGrid, WaveFunction, KPointData 等）\n- ESolver 扩展（ksdft_pw_dfpt）\n- 参考 dvqpsi_cpp 的成功经验",
          "dependencies": [],
          "acceptance_criteria": [
            "完成架构设计文档（DFPT_ARCHITECTURE.md）",
            "定义核心数据结构和接口",
            "明确与 ABACUS 现有模块的集成点",
            "设计文档通过技术评审"
          ],
          "files_to_touch": [
            "source/module_dfpt/README.md",
            "docs/DFPT_ARCHITECTURE.md"
          ],
          "estimated_scope": "medium",
          "specialist": "architect"
        },
        {
          "id": "DFPT-002",
          "title": "建立代码审核工作流",
          "layer": "infra",
          "type": "new",
          "description": "基于 /root/code-review-agent/ 建立 DFPT 迁移的代码审核流程：\n- 配置 6-agent 并发审核（单位、物理、算法、风格、调用链、防御）\n- 配置 3-agent 串行迁移工作流（源码分析、目标模式、差异适配）\n- 准备 ABACUS 领域知识文档（domain-knowledge/abacus-dfpt.md）\n- 设置审核 schema 和 prompt 模板",
          "dependencies": ["DFPT-001"],
          "acceptance_criteria": [
            "code-review-agent 配置完成",
            "ABACUS DFPT 领域知识文档就绪",
            "审核工作流测试通过（用 dvqpsi_cpp 代码验证）",
            "生成示例审核报告"
          ],
          "files_to_touch": [
            "tools/code-review/config.yaml",
            "tools/code-review/domain-knowledge/abacus-dfpt.md",
            "tools/code-review/prompts/review-dfpt-*.md"
          ],
          "estimated_scope": "medium",
          "specialist": "devops"
        },
        {
          "id": "DFPT-003",
          "title": "创建 DFPT 模块骨架和构建系统",
          "layer": "infra",
          "type": "new",
          "description": "在 ABACUS 中创建 module_dfpt 目录结构和 CMake 构建配置：\n- source/module_dfpt/ 目录结构\n- CMakeLists.txt 配置\n- 测试框架集成（GoogleTest）\n- 与主构建系统集成",
          "dependencies": ["DFPT-001"],
          "acceptance_criteria": [
            "module_dfpt 目录结构创建完成",
            "CMake 构建配置正确",
            "空模块可以成功编译",
            "测试框架集成完成"
          ],
          "files_to_touch": [
            "source/module_dfpt/CMakeLists.txt",
            "source/module_dfpt/test/CMakeLists.txt",
            "source/CMakeLists.txt"
          ],
          "estimated_scope": "small",
          "specialist": "build-engineer"
        }
      ]
    },
    {
      "id": "phase2",
      "name": "核心 DFPT Kernel 迁移",
      "tasks": [
        {
          "id": "DFPT-101",
          "title": "迁移数据结构适配层",
          "layer": "core",
          "type": "extend",
          "description": "创建 dvqpsi_cpp 和 ABACUS 之间的数据结构适配层：\n- FFTGrid ↔ PW_Basis\n- WaveFunction ↔ Psi<complex<double>>\n- KPointData ↔ K_Vectors\n- GVectorData ↔ PW_Basis\n- NonlocalData ↔ pseudopot_cell_vnl",
          "dependencies": ["DFPT-003"],
          "acceptance_criteria": [
            "适配器类实现完成",
            "单元测试覆盖所有转换",
            "性能开销 < 5%",
            "代码审核通过（6-agent review）"
          ],
          "files_to_touch": [
            "source/module_dfpt/dfpt_adapters.h",
            "source/module_dfpt/dfpt_adapters.cpp",
            "source/module_dfpt/test/test_adapters.cpp"
          ],
          "estimated_scope": "medium",
          "specialist": "cpp-developer"
        },
        {
          "id": "DFPT-102",
          "title": "迁移 DVQPsiUS 核心 kernel",
          "layer": "core",
          "type": "extend",
          "description": "将 dvqpsi_cpp 的核心 DFPT kernel 迁移到 ABACUS：\n- 局部势贡献（local potential）\n- 非局部赝势贡献（nonlocal pseudopotential）\n- 超软赝势增强（ultrasoft augmentation）\n- FFT 操作集成（使用 ABACUS 的 UFFT）\n- OpenMP 并行化",
          "dependencies": ["DFPT-101"],
          "acceptance_criteria": [
            "DVQPsiUS 类实现完成",
            "与 dvqpsi_cpp 数值结果一致（误差 < 1e-10）",
            "单元测试通过",
            "性能与 dvqpsi_cpp 相当",
            "代码审核通过（物理正确性、算法匹配）"
          ],
          "files_to_touch": [
            "source/module_dfpt/dvqpsi_us.h",
            "source/module_dfpt/dvqpsi_us.cpp",
            "source/module_dfpt/test/test_dvqpsi.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "physics-developer"
        },
        {
          "id": "DFPT-103",
          "title": "迁移 Sternheimer 求解器",
          "layer": "algorithm",
          "type": "new",
          "description": "实现 Sternheimer 方程求解器 (H-ε)·Δψ = -ΔV·ψ：\n- 共轭梯度（CG）求解器\n- 预条件器（diagonal preconditioning）\n- Hamiltonian 算符应用\n- 收敛判据和迭代控制",
          "dependencies": ["DFPT-102"],
          "acceptance_criteria": [
            "Sternheimer 求解器实现完成",
            "与 QE 参考结果一致",
            "收敛性测试通过",
            "性能基准达标",
            "代码审核通过"
          ],
          "files_to_touch": [
            "source/module_dfpt/sternheimer_solver.h",
            "source/module_dfpt/sternheimer_solver.cpp",
            "source/module_dfpt/cg_solver.h",
            "source/module_dfpt/cg_solver.cpp",
            "source/module_dfpt/test/test_sternheimer.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "algorithm-developer"
        }
      ]
    },
    {
      "id": "phase3",
      "name": "自洽场和声子计算",
      "tasks": [
        {
          "id": "DFPT-201",
          "title": "实现 DFPT 自洽场迭代",
          "layer": "algorithm",
          "type": "new",
          "description": "实现 DFPT 的 SCF 循环：\n- 电荷密度响应计算（Δρ）\n- 势能响应计算（ΔV_SCF = ΔV_H + ΔV_xc）\n- 势能混合（charge mixing）\n- 对称化操作\n- 收敛判据",
          "dependencies": ["DFPT-103"],
          "acceptance_criteria": [
            "DFPT SCF 循环实现完成",
            "与 QE 收敛行为一致",
            "支持多种混合方案（linear, Broyden）",
            "单元测试和集成测试通过",
            "代码审核通过"
          ],
          "files_to_touch": [
            "source/module_dfpt/dfpt_scf.h",
            "source/module_dfpt/dfpt_scf.cpp",
            "source/module_dfpt/potential_mixer.h",
            "source/module_dfpt/potential_mixer.cpp",
            "source/module_dfpt/test/test_dfpt_scf.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "physics-developer"
        },
        {
          "id": "DFPT-202",
          "title": "实现动力学矩阵计算",
          "layer": "algorithm",
          "type": "new",
          "description": "计算声子动力学矩阵：\n- 力常数矩阵计算\n- 对称化和约化\n- 本征值求解（声子频率）\n- 本征向量计算（声子模式）\n- LO-TO 劈裂处理（极性材料）",
          "dependencies": ["DFPT-201"],
          "acceptance_criteria": [
            "动力学矩阵计算正确",
            "声子频率与 QE 一致（误差 < 0.1 cm⁻¹）",
            "支持声学和规范和",
            "单元测试通过",
            "代码审核通过"
          ],
          "files_to_touch": [
            "source/module_dfpt/dynmat.h",
            "source/module_dfpt/dynmat.cpp",
            "source/module_dfpt/symmetry_dfpt.h",
            "source/module_dfpt/symmetry_dfpt.cpp",
            "source/module_dfpt/test/test_dynmat.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "physics-developer"
        },
        {
          "id": "DFPT-203",
          "title": "实现电声耦合计算",
          "layer": "algorithm",
          "type": "extend",
          "description": "计算电声耦合矩阵元和相关物理量：\n- EPC 矩阵元 g(k,q,ν)\n- 声子线宽 γ(q,ν)\n- Eliashberg 函数 α²F(ω)\n- 耦合常数 λ\n- Tc 估算（McMillan 公式）",
          "dependencies": ["DFPT-202"],
          "acceptance_criteria": [
            "EPC 计算实现完成",
            "与 QE 结果一致",
            "支持 Brillouin zone 积分",
            "单元测试通过",
            "代码审核通过"
          ],
          "files_to_touch": [
            "source/module_dfpt/elphon.h",
            "source/module_dfpt/elphon.cpp",
            "source/module_dfpt/bz_integration.h",
            "source/module_dfpt/bz_integration.cpp",
            "source/module_dfpt/test/test_elphon.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "physics-developer"
        }
      ]
    },
    {
      "id": "phase4",
      "name": "并行化和优化",
      "tasks": [
        {
          "id": "DFPT-301",
          "title": "实现 MPI 并行化",
          "layer": "infra",
          "type": "new",
          "description": "添加 MPI 并行支持：\n- k 点并行（pool parallelization）\n- q 点并行（image parallelization）\n- 不可约表示并行\n- 数据通信优化",
          "dependencies": ["DFPT-203"],
          "acceptance_criteria": [
            "MPI 并行实现完成",
            "并行效率 > 80%（16 进程）",
            "负载均衡良好",
            "并行测试通过",
            "代码审核通过"
          ],
          "files_to_touch": [
            "source/module_dfpt/dfpt_parallel.h",
            "source/module_dfpt/dfpt_parallel.cpp",
            "source/module_dfpt/test/test_parallel.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "hpc-developer"
        },
        {
          "id": "DFPT-302",
          "title": "性能优化和基准测试",
          "layer": "infra",
          "type": "new",
          "description": "性能优化和基准测试：\n- 热点分析和优化\n- 内存使用优化\n- 与 QE 性能对比\n- 生成性能基准报告",
          "dependencies": ["DFPT-301"],
          "acceptance_criteria": [
            "性能与 QE 相当或更优",
            "内存使用合理",
            "性能基准报告完成",
            "优化文档完成"
          ],
          "files_to_touch": [
            "docs/DFPT_PERFORMANCE.md",
            "benchmarks/dfpt_benchmark.cpp"
          ],
          "estimated_scope": "medium",
          "specialist": "performance-engineer"
        }
      ]
    },
    {
      "id": "phase5",
      "name": "ESolver 集成和用户接口",
      "tasks": [
        {
          "id": "DFPT-401",
          "title": "创建 ESolver_DFPT 类",
          "layer": "workflow",
          "type": "new",
          "description": "创建 DFPT ESolver 并集成到 ABACUS 主流程：\n- 实现 ESolver_DFPT 类\n- 集成到 Driver 流程\n- 输入参数处理\n- 输出文件生成",
          "dependencies": ["DFPT-302"],
          "acceptance_criteria": [
            "ESolver_DFPT 实现完成",
            "可通过 INPUT 文件调用",
            "输出格式与 ABACUS 一致",
            "集成测试通过"
          ],
          "files_to_touch": [
            "source/module_esolver/esolver_dfpt.h",
            "source/module_esolver/esolver_dfpt.cpp",
            "source/module_esolver/esolver.cpp",
            "source/driver.cpp"
          ],
          "estimated_scope": "medium",
          "specialist": "integration-engineer"
        },
        {
          "id": "DFPT-402",
          "title": "实现 q 点网格和工作流",
          "layer": "workflow",
          "type": "new",
          "description": "实现完整的声子计算工作流：\n- q 点网格生成\n- q 点循环驱动\n- 对称性约化\n- 恢复/检查点机制\n- 后处理工具（q2r, matdyn 等效功能）",
          "dependencies": ["DFPT-401"],
          "acceptance_criteria": [
            "q 点网格工作流实现完成",
            "支持恢复中断的计算",
            "后处理工具可用",
            "端到端测试通过"
          ],
          "files_to_touch": [
            "source/module_dfpt/qpoint_grid.h",
            "source/module_dfpt/qpoint_grid.cpp",
            "source/module_dfpt/phonon_driver.h",
            "source/module_dfpt/phonon_driver.cpp",
            "tools/dfpt_postprocess.cpp"
          ],
          "estimated_scope": "large",
          "specialist": "workflow-developer"
        }
      ]
    },
    {
      "id": "phase6",
      "name": "测试和文档",
      "tasks": [
        {
          "id": "DFPT-501",
          "title": "创建集成测试套件",
          "layer": "validation",
          "type": "test",
          "description": "创建完整的集成测试套件：\n- 简单系统测试（Si, Al 等）\n- 与 QE 结果对比验证\n- 极性材料测试（LO-TO 劈裂）\n- 金属系统测试\n- 电声耦合测试\n- 集成到 abacustest 框架",
          "dependencies": ["DFPT-402"],
          "acceptance_criteria": [
            "集成测试套件完成（≥10 个测试用例）",
            "所有测试通过",
            "与 QE 结果一致性验证完成",
            "测试文档完成"
          ],
          "files_to_touch": [
            "tests/integrate/dfpt_*/",
            "tests/integrate/CASES_DFPT.txt",
            "docs/DFPT_TESTING.md"
          ],
          "estimated_scope": "large",
          "specialist": "test-engineer"
        },
        {
          "id": "DFPT-502",
          "title": "编写用户文档",
          "layer": "validation",
          "type": "new",
          "description": "编写完整的用户文档：\n- 用户手册（如何使用 DFPT 功能）\n- 输入参数说明\n- 示例计算\n- 常见问题解答\n- 与 QE 的差异说明",
          "dependencies": ["DFPT-501"],
          "acceptance_criteria": [
            "用户文档完成",
            "示例计算可复现",
            "文档评审通过"
          ],
          "files_to_touch": [
            "docs/DFPT_USER_GUIDE.md",
            "docs/DFPT_INPUT_PARAMETERS.md",
            "examples/dfpt_*/README.md"
          ],
          "estimated_scope": "medium",
          "specialist": "technical-writer"
        },
        {
          "id": "DFPT-503",
          "title": "编写开发者文档",
          "layer": "validation",
          "type": "new",
          "description": "编写开发者文档：\n- 架构设计文档\n- 算法实现细节\n- 代码审核报告汇总\n- 性能分析报告\n- 未来扩展建议",
          "dependencies": ["DFPT-501"],
          "acceptance_criteria": [
            "开发者文档完成",
            "代码审核报告汇总完成",
            "文档评审通过"
          ],
          "files_to_touch": [
            "docs/DFPT_DEVELOPER_GUIDE.md",
            "docs/DFPT_ALGORITHM_DETAILS.md",
            "docs/DFPT_CODE_REVIEW_SUMMARY.md"
          ],
          "estimated_scope": "medium",
          "specialist": "technical-writer"
        }
      ]
    }
  ],
  "metadata": {
    "total_tasks": 18,
    "estimated_duration": "6-9 months",
    "critical_path": [
      "DFPT-001",
      "DFPT-003",
      "DFPT-101",
      "DFPT-102",
      "DFPT-103",
      "DFPT-201",
      "DFPT-202",
      "DFPT-203",
      "DFPT-301",
      "DFPT-302",
      "DFPT-401",
      "DFPT-402",
      "DFPT-501"
    ],
    "key_risks": [
      "物理正确性验证（需要与 QE 详细对比）",
      "性能达标（需要与 QE 性能相当）",
      "MPI 并行化复杂度",
      "对称性操作的正确性"
    ]
  }
}
