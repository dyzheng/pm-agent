# DZ-008: 回复 NO 配体电荷/磁性控制问题并提供工作流建议

## Objective

GitHub Issue #6824。用户在 Cu-Histidine-Fe(CN)₅NO 体系的自旋极化 DFT (LCAO, PBE) 计算中，无法控制 NO 配体的电荷态和磁性。relax 过程中 NO⁺ 自发弯曲并获得自旋密度（变为 NO⁰/NO⁻），DFT+U 无法收敛。需要调研 ABACUS 现有能力并提供技术回复。

## Reference Code

### Source Code (ABACUS 约束磁性能力)

**DeltaSpin — 自旋约束 DFT（已实现）**

**`/root/abacus-develop/source/source_lcao/module_deltaspin/spin_constrain.h`**
- Line 235: `lambda_` — Lagrange 乘子 (Ry/uB)
- Line 236: `target_mag_` — 目标磁矩 (uB)
- Line 250: `constrain_[]` — 每原子约束标志 (0=不约束)
- Line 239: `escon_` — 自旋约束能量

**`/root/abacus-develop/source/source_lcao/module_deltaspin/spin_constrain.cpp`**
- Lines 29-31: 约束能量 `escon_ -= lambda_[iat].x * Mi_[iat].x` (+ y, z)
- `cal_escon()`:67 — 计算总约束能量

**`/root/abacus-develop/source/source_lcao/module_deltaspin/lambda_loop.cpp`** (282 lines)
- Lambda 优化循环，迭代调整 Lagrange 乘子直到磁矩收敛到目标值

**`/root/abacus-develop/source/source_lcao/module_deltaspin/cal_mw_from_lambda.cpp`** (543 lines)
- 从 lambda 计算原子磁矩

**`/root/abacus-develop/source/source_lcao/module_operator_lcao/dspin_lcao.cpp`** (531 lines)
- DeltaSpin 算符：将约束项贡献到 Hamiltonian

**ScAtomData 结构** (`spin_constrain.h`:278-287):
```cpp
struct ScAtomData {
    int index;
    std::vector<double> lambda;        // Lagrange 乘子
    std::vector<double> target_mag;    // 目标磁矩
    std::vector<int> constrain;        // 约束标志
    int mag_type;
    double target_mag_val, target_mag_angle1, target_mag_angle2;
};
```

### DFT+U 实现

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 lines)
- `Plus_U` 类
- `U[]`, `U0[]`: Hubbard U 参数
- `orbital_corr[]`: 轨道关联
- `uramping`: U 渐进参数（可能有助于收敛）
- `omc`: 占据矩阵控制
- `mixing_dftu`: DFT+U 混合标志

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.cpp`** (482 lines)
- DFT+U 核心实现

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_yukawa.cpp`** (295 lines)
- Yukawa 势自动计算 U 值

### 磁性计算

**`/root/abacus-develop/source/source_estate/magnetism.h`** (lines 16-39)
- `tot_mag`: 总磁矩
- `abs_mag`: 绝对磁矩
- `compute_mag()`: 从电荷密度计算磁矩

## Implementation Guide

### 调研要点

1. **DeltaSpin 是否适用于此场景？**
   - DeltaSpin 可以约束每个原子的磁矩方向和大小
   - 用户可以将 NO 上的 N 和 O 原子的目标磁矩设为 0（强制非磁性 → NO⁺）
   - 需要确认 DeltaSpin 是否支持 relax（几何优化）过程中的约束

2. **DFT+U 不收敛的可能原因**
   - `uramping` 参数：从小 U 逐步增大到目标 U，改善收敛
   - `mixing_dftu`: 占据矩阵混合可能需要调整
   - 过渡金属 + NO 体系的电子结构复杂，可能需要更保守的 SCF 参数

3. **替代工作流建议**
   - 固定 NO 几何（线性）进行 SCF，确认电子态后再 relax
   - 使用 `init_chg=file` 从已知好的电子态重启
   - 分步优化：先优化除 NO 外的原子，再放开 NO

### 回复模板

```markdown
## 技术回复

### 1. 局域磁矩约束 — DeltaSpin

ABACUS 已实现 DeltaSpin (constrained DFT) 功能，可以约束每个原子的磁矩：
- 在 INPUT 中设置 `sc_mag_switch 1`
- 在 STRU 中为 N/O 原子设置 `constrain 1 1 1` 和 `target_mag 0 0 0`
- 这将通过 Lagrange 乘子强制 NO 配体保持非磁性（NO⁺ 态）

### 2. DFT+U 收敛建议

- 尝试 `uramping` 参数，从 U=0 逐步增大
- 调整 `mixing_beta` 到更小的值（如 0.1）
- 使用 `mixing_dftu 1` 启用占据矩阵混合

### 3. 推荐工作流

1. 先固定 NO 几何（线性），用 DeltaSpin 约束磁矩为 0
2. 确认 SCF 收敛到 NO⁺ 态
3. 保存密度矩阵（init_chg=dm 输出）
4. 放开 NO 几何，用保存的密度矩阵重启（init_chg=dm）
5. 使用较小的 relax 步长（force_thr_ev 较大值开始）
```

### Critical Implementation Details

- DeltaSpin 目前仅支持 LCAO 基组（用户已在用 LCAO，匹配）
- DeltaSpin 在 relax 中的行为需要验证 — 约束是否在每个离子步都生效
- 用户的体系包含 Cu, Fe, C, N, O, H 多种元素，DFT+U 通常只加在 Cu(3d) 和 Fe(3d) 上
- NO 配体的电子态切换是 DFT 的已知难题，不是 ABACUS 特有的

## TDD Test Plan

### Tests to Write FIRST

```python
# 这是一个用户支持任务，不需要代码测试
# 但需要验证建议的工作流是否可行

# test_deltaspin_relax.py (验证 DeltaSpin + relax 兼容性)

def test_deltaspin_with_relax():
    """Verify DeltaSpin constraints are maintained during relax."""
    result = run_abacus(
        calculation="relax",
        sc_mag_switch=1,
        # 约束某原子磁矩为 0
    )
    for step in result.ionic_steps:
        assert abs(step.atom_mag[constrained_atom]) < 0.1  # uB
```

## Acceptance Criteria

- [ ] 在 issue 中提供详细的技术回复
- [ ] 说明 ABACUS 当前支持的局域磁矩/电荷约束方法（DeltaSpin）
- [ ] 提供至少一种可行的工作流建议
- [ ] 如果发现 DFT+U 收敛 bug，创建单独的 issue 跟踪
