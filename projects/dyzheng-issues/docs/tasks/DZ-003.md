# DZ-003: 诊断并修复 OpenMPI v4 toolchain 编译问题

## Objective

GitHub Issue #6195。用户使用 toolchain 中的 openmpi-v4 编译 ABACUS LTS v3.10.0 时遇到 OFI Libfabric 错误：`fi_endpoint` 调用失败，`Failed to modify UD QP to INIT on mlx5_0: Operation not permitted`。需要诊断根因并提供解决方案。

## Reference Code

### Source Code (Toolchain 编译脚本)

**`/root/abacus-develop/toolchain/scripts/stage1/install_openmpi.sh`**
- Lines 33-37: OpenMPI 版本定义
  - 主版本: 5.0.8
  - 备选版本: 4.1.6
- Lines 94-106: configure 和编译
  ```bash
  ./configure --prefix=${pkg_install_dir} --libdir="${pkg_install_dir}/lib" \
              --with-libevent=internal
  ```
  - 注意：未指定 `--with-ofi` 或 `--with-ucx` 传输层选项
- Lines 116-120: MPI 编译器检测 (mpicc, mpicxx, mpifort)
- Lines 181-203: 环境变量设置

**`/root/abacus-develop/toolchain/scripts/common_vars.sh`**
- Line 31: `MPI_MODE=${MPI_MODE:-openmpi}` — 默认使用 OpenMPI
- 支持模式: openmpi, mpich, intelmpi

**`/root/abacus-develop/CMakeLists.txt`**
- Line 13: `option(ENABLE_MPI "Enable MPI" ON)`
- Line 326: `find_package(MPI REQUIRED)`

### Target Code (ELPA 依赖)

**`/root/abacus-develop/toolchain/scripts/stage3/install_elpa.sh`**
- Line 50: ELPA 需要 MPI
- Lines 146-154: ELPA configure 使用 MPI 编译器

## Implementation Guide

### Architecture Decisions

- 这很可能是**环境配置问题**而非 ABACUS 代码 bug
- `mlx5_0` 是 Mellanox ConnectX-5 InfiniBand 网卡驱动
- `Failed to modify UD QP to INIT` 表示 InfiniBand 权限不足
- `fi_endpoint` 失败表示 OFI (Open Fabrics Interface) 传输层初始化失败

### 诊断步骤

1. **确认错误发生阶段**: 编译时 vs 运行时
   - 如果是运行时：与 ABACUS 编译无关，是 MPI 运行环境问题
   - 如果是编译时（configure 阶段的 MPI 测试）：需要调整 configure 参数

2. **检查 InfiniBand 权限**:
   ```bash
   # 检查 IB 设备权限
   ls -la /dev/infiniband/
   ibstat
   # 检查用户是否有 IB 访问权限
   id  # 确认用户组
   ```

3. **绕过 OFI/IB 传输层**:
   ```bash
   # 方法 1: 强制使用 TCP 传输
   export OMPI_MCA_btl=tcp,self
   export OMPI_MCA_mtl=^ofi

   # 方法 2: 编译 OpenMPI 时禁用 OFI
   ./configure --prefix=... --without-ofi --with-ucx=no

   # 方法 3: 使用 UCX 替代 OFI
   ./configure --prefix=... --with-ucx=/path/to/ucx
   ```

4. **检查 toolchain 脚本是否需要修改**:
   - `install_openmpi.sh` 的 configure 行未指定传输层
   - 可以添加 `--with-ofi=no` 作为 InfiniBand 环境的 fallback 选项

### Critical Implementation Details

- OpenMPI 4.x 默认启用 OFI (libfabric) 传输层
- 在没有正确配置 InfiniBand 权限的环境中，OFI 会尝试使用 mlx5 provider 并失败
- 这不影响 TCP 传输，但 OpenMPI 默认优先选择高性能传输
- 解决方案应该是文档级别的，而非修改 ABACUS 代码

### 建议的 Toolchain 改进

```bash
# install_openmpi.sh 中添加可选参数
if [ "${OPENMPI_OFI:-yes}" = "no" ]; then
    EXTRA_CONFIGURE="--without-ofi"
fi
./configure --prefix=${pkg_install_dir} ${EXTRA_CONFIGURE} ...
```

## TDD Test Plan

### Tests to Write FIRST

```bash
# 验证脚本（非代码测试，而是环境验证）

# 1. 检查 OpenMPI 编译是否成功
mpicc --version
mpicxx --version

# 2. 检查传输层
ompi_info --parsable --all | grep btl
ompi_info --parsable --all | grep mtl

# 3. 简单 MPI 程序测试
cat > /tmp/test_mpi.cpp << 'EOF'
#include <mpi.h>
#include <stdio.h>
int main(int argc, char** argv) {
    MPI_Init(&argc, &argv);
    int rank;
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);
    printf("Rank %d OK\n", rank);
    MPI_Finalize();
    return 0;
}
EOF
mpicxx -o /tmp/test_mpi /tmp/test_mpi.cpp
mpirun -np 2 --mca btl tcp,self /tmp/test_mpi
```

## Acceptance Criteria

- [ ] 确认问题根因（ABACUS 代码 vs 环境配置）
- [ ] 如果是环境问题，提供解决方案文档
- [ ] 如果是 toolchain 问题，修复编译脚本
- [ ] 在 issue 中回复用户解决方案
