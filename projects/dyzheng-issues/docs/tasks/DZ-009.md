# DZ-009: 评估并规划 constrained DFT / 局域磁矩约束功能

## Objective

基于 #6824 (DZ-008) 用户需求，评估 ABACUS 现有 DeltaSpin 实现的完整性，对比 VASP/QE 的约束磁性方案，识别功能缺口，并输出改进建议或新功能设计文档。

## Reference Code

### Source Code (ABACUS DeltaSpin 现有实现)

**核心模块: `/root/abacus-develop/source/source_lcao/module_deltaspin/`** (2,629 lines)

| 文件 | 行数 | 功能 |
|------|------|------|
| `spin_constrain.h` | ~300 | 主类定义，Lagrange 乘子、目标磁矩、约束标志 |
| `spin_constrain.cpp` | ~500 | 核心实现，约束能量计算 |
| `lambda_loop.cpp` | 282 | Lambda 优化循环 |
| `cal_mw_from_lambda.cpp` | 543 | 从 lambda 计算原子磁矩 |
| `lambda_loop_helper.cpp` | 182 | 辅助函数 |

**算符: `/root/abacus-develop/source/source_lcao/module_operator_lcao/`**

| 文件 | 行数 | 功能 |
|------|------|------|
| `dspin_lcao.h` | 157 | DeltaSpin 算符头文件 |
| `dspin_lcao.cpp` | 531 | Hamiltonian 贡献 |
| `dspin_force_stress.hpp` | 394 | 力/应力计算 |

**关键数据结构** (`spin_constrain.h`):
- `lambda_[]`: Lagrange 乘子 (Vector3<double>)，单位 Ry/uB
- `target_mag_[]`: 目标磁矩 (Vector3<double>)，单位 uB
- `constrain_[]`: 约束标志 (Vector3<int>)，0=不约束
- `sc_thr_`: 收敛阈值

**约束能量**: `E_con = -Σ λᵢ · Mᵢ`

### 对比参考 (VASP / QE)

**VASP constrained magnetism:**
- `I_CONSTRAINED_M = 1`: 约束方向，`2`: 约束方向+大小
- `LAMBDA = value`: 惩罚函数强度
- `M_CONSTR`: 每原子目标磁矩
- 支持 relax 和 MD

**QE constrained_magnetization:**
- `constrained_magnetization = 'atomic'` 或 `'total'`
- `lambda = value`: 惩罚函数强度
- `fixed_magnetization`: 固定总磁矩
- 支持 relax

### DFT+U 参考

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`**
- `uramping`: U 渐进参数
- `mixing_dftu`: 占据矩阵混合
- `Yukawa`: 自动 U 计算

## Implementation Guide

### 评估维度

**1. 功能完整性对比**

| 功能 | ABACUS DeltaSpin | VASP | QE |
|------|-----------------|------|-----|
| 约束原子磁矩方向 | ✅ | ✅ | ✅ |
| 约束原子磁矩大小 | ✅ | ✅ | ✅ |
| 约束总磁矩 | ❓ 需确认 | ✅ | ✅ |
| SCF 中约束 | ✅ | ✅ | ✅ |
| relax 中约束 | ❓ 需验证 | ✅ | ✅ |
| MD 中约束 | ❓ 需验证 | ✅ | ❌ |
| 力/应力修正 | ✅ (dspin_force_stress.hpp) | ✅ | ✅ |
| PW 基组支持 | ❌ (仅 LCAO) | ✅ | ✅ |
| 非共线支持 | ✅ (nspin=4) | ✅ | ✅ |
| 共线支持 | ❓ 需确认 (nspin=2) | ✅ | ✅ |

**2. 需要验证的问题**

- DeltaSpin 在 `calculation=relax` 时是否每个离子步都重新优化 lambda？
- DeltaSpin 是否支持 nspin=2（共线约束）？
- 约束力是否正确传递到离子优化器？
- 是否支持约束总磁矩（而非逐原子约束）？

**3. 功能缺口识别**

- PW 基组支持：当前 DeltaSpin 仅在 LCAO 中实现
- 文档：DeltaSpin 的用户文档是否完整？
- 示例：是否有 DeltaSpin 的示例输入文件？

### 如果决定实施新功能

**优先级排序:**
1. 验证 DeltaSpin + relax 的正确性（低成本，高价值）
2. 添加 DeltaSpin 用户文档和示例（低成本，高价值）
3. 支持 nspin=2 的约束（中等成本）
4. PW 基组支持（高成本，可延后）

### Critical Implementation Details

- DeltaSpin 使用 Lagrange 乘子法，与 VASP 的惩罚函数法不同
  - Lagrange 乘子法：精确约束，但需要额外的 lambda 优化循环
  - 惩罚函数法：近似约束，但实现更简单
- ABACUS 的 DeltaSpin 实现参考了 Ma & Dudarev (PRB 2015) 的方法
- 力/应力修正已实现（dspin_force_stress.hpp），理论上 relax 应该可以工作

## TDD Test Plan

### Tests to Write FIRST

```python
# test_deltaspin_capabilities.py

def test_deltaspin_scf_constrains_moment():
    """Basic: DeltaSpin constrains atomic moment in SCF."""
    result = run_abacus(
        calculation="scf",
        nspin=4, noncolin=True,
        sc_mag_switch=1,
        target_mag={"Fe": [0, 0, 2.0]},
        constrain={"Fe": [1, 1, 1]},
    )
    assert result.converged
    assert abs(result.atom_mag["Fe"][2] - 2.0) < 0.1

def test_deltaspin_relax_maintains_constraint():
    """DeltaSpin constraint maintained during relax."""
    result = run_abacus(
        calculation="relax",
        nspin=4, noncolin=True,
        sc_mag_switch=1,
        target_mag={"N": [0, 0, 0]},  # force NO to be non-magnetic
        constrain={"N": [1, 1, 1]},
    )
    for step in result.ionic_steps:
        assert abs(step.atom_mag["N_magnitude"]) < 0.1

def test_deltaspin_nspin2():
    """DeltaSpin with nspin=2 (collinear constraint)."""
    result = run_abacus(
        calculation="scf",
        nspin=2,
        sc_mag_switch=1,
        target_mag={"Fe": [0, 0, 3.0]},
        constrain={"Fe": [0, 0, 1]},
    )
    assert result.converged
```

## Acceptance Criteria

- [ ] 完成技术可行性评估文档
- [ ] 对比 VASP/QE 的实现方案
- [ ] 给出 ABACUS 实现的推荐方案和工作量估计
- [ ] 如果决定实施，输出详细的任务分解
