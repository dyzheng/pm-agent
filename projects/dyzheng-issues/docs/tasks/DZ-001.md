# DZ-001: 修复 nspin=4 noncolin=0 时磁矩解析错误

## Objective

GitHub Issue #5021。当 STRU 中设置初始 xyz 磁矩（如 `1 1 1`），INPUT 中设 nspin=4 但未设 noncolin=1 时，ABACUS 错误地将非共线磁矩旋转到 Z 轴，输出 `0 0 1.732`。需要修复 STRU 解析逻辑，使 nspin=4 时正确处理磁矩初始化。

## Reference Code

### Source Code (Bug 所在位置)

**`/root/abacus-develop/source/source_cell/read_atoms_helper.cpp`** (核心 bug)
- `process_magnetization()`:302-309 — nspin==4 时的磁矩处理逻辑
  - 当前行为：`noncolin=false` 时将 x,y 分量置零，仅保留 z 分量
  - Bug：nspin=4 本身就意味着非共线，不应该丢弃 x,y 分量
- `parse_atom_properties()`:349-486 — 解析 `mag`/`magmom`/`angle1`/`angle2` 关键字

**`/root/abacus-develop/source/source_cell/read_atoms.cpp`**
- `unitcell::read_atom_positions()`:21-121 — STRU 解析入口，调用 `process_magnetization()`

**`/root/abacus-develop/source/source_cell/atom_spec.h`** (数据结构)
- Line 46-49: `mag[]` (标量), `angle1[]`/`angle2[]` (球坐标), `m_loc_[]` (笛卡尔 mx,my,mz)

### Target Code (需要修改)

**`/root/abacus-develop/source/source_cell/read_atoms_helper.cpp`**
- Lines 302-309: `process_magnetization()` 中的 noncolin 判断逻辑
- 需要修改：nspin==4 时，无论 noncolin 设置如何，都应保留 xyz 磁矩分量
- 或者：nspin==4 且 noncolin==false 时，自动将 noncolin 设为 true 并发出警告

### Prior Art

**自动磁矩初始化逻辑** (`read_atoms_helper.cpp`:82-132):
- nspin=4 默认: `m_loc_ = (1.0, 1.0, 1.0)`, `mag = sqrt(3)`
- nspin=2 默认: `mag = 1.0`, `m_loc_ = (0, 0, 1.0)`

**磁矩球坐标↔笛卡尔转换**:
- `m_z = mag * cos(angle1)`
- `m_x = mag * sin(angle1) * cos(angle2)`
- `m_y = mag * sin(angle1) * sin(angle2)`

## Implementation Guide

### Architecture Decisions

- **方案 A（推荐）**: nspin=4 时自动启用 noncolin=true，并输出 WARNING 日志
  - 理由：nspin=4 的物理含义就是非共线，noncolin=0 是用户误设
  - 影响最小，不改变任何物理行为
- **方案 B**: nspin=4 + noncolin=0 时保留 xyz 分量但按共线方式处理（仅用 z 分量做 SCF）
  - 风险：可能导致后续模块行为不一致

### 当前行为映射

| nspin | noncolin | x,y 分量 | z 分量 | 行为 |
|-------|----------|----------|--------|------|
| 1 | - | 置零 | 置零 | 非磁性 |
| 2 | - | 置零 | 保留 | 共线 |
| 4 | false | **置零 (BUG)** | 保留 | 共线（但 nspin=4 不应该是共线） |
| 4 | true | 保留 | 保留 | 非共线 |

### Critical Implementation Details

- `process_magnetization()` 中的条件判断 `if (!noncolin)` 在 nspin==4 时不应丢弃 x,y 分量
- 修改后需确保 `angle1`/`angle2` 的球坐标↔笛卡尔转换仍然正确
- 注意 `Magnetism` 类中 `ux_[3]`（磁化方向）的初始化不受影响
- 后续 SCF 中 `magnetism.cpp`:20-106 的 `tot_mag_nc[i] = sum(rho[i+1])` 依赖正确的初始磁矩

## TDD Test Plan

### Tests to Write FIRST

```cpp
// test_read_atoms_magnetization.cpp

TEST_F(ReadAtomsTest, Nspin4NoncolinFalse_PreservesXYZ) {
    // nspin=4, noncolin=false, STRU 中设置 mag (1, 1, 1)
    // 期望：m_loc_ = (1, 1, 1)，而非 (0, 0, 1.732)
    setup_nspin(4);
    setup_noncolin(false);
    set_atom_mag(0, 1.0, 1.0, 1.0);
    process_magnetization();
    EXPECT_NEAR(atom.m_loc_[0].x, 1.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].y, 1.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].z, 1.0, 1e-10);
}

TEST_F(ReadAtomsTest, Nspin4NoncolinTrue_PreservesXYZ) {
    // nspin=4, noncolin=true — 回归测试，行为不变
    setup_nspin(4);
    setup_noncolin(true);
    set_atom_mag(0, 1.0, 1.0, 1.0);
    process_magnetization();
    EXPECT_NEAR(atom.m_loc_[0].x, 1.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].y, 1.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].z, 1.0, 1e-10);
}

TEST_F(ReadAtomsTest, Nspin2_OnlyZComponent) {
    // nspin=2 回归测试 — x,y 应为零
    setup_nspin(2);
    set_atom_mag(0, 0.0, 0.0, 2.0);
    process_magnetization();
    EXPECT_NEAR(atom.m_loc_[0].x, 0.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].y, 0.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].z, 2.0, 1e-10);
}

TEST_F(ReadAtomsTest, Nspin1_AllZero) {
    // nspin=1 回归测试 — 非磁性
    setup_nspin(1);
    process_magnetization();
    EXPECT_NEAR(atom.m_loc_[0].x, 0.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].y, 0.0, 1e-10);
    EXPECT_NEAR(atom.m_loc_[0].z, 0.0, 1e-10);
}
```

## Acceptance Criteria

- [ ] nspin=4 noncolin=0 时初始磁矩 (1,1,1) 正确保留为 (1,1,1) 而非 (0,0,1.732)
- [ ] 添加单元测试覆盖 nspin=4 + noncolin=0/1 两种情况
- [ ] 不影响 nspin=1/2 的现有行为
- [ ] CI 全部通过
