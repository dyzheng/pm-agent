# DZ-005: 审查并改进非共线磁性初始化流程

## Objective

综合 #5021 (DZ-001) 和 #6974 (DZ-004) 的修复经验，对 ABACUS 的磁性初始化流程进行整体审查和改进。统一 nspin=1/2/4 + noncolin + SOC 各种组合下的磁矩初始化逻辑，对不合理的参数组合给出清晰的警告或错误信息。

## Reference Code

### Source Code (磁矩初始化全流程)

**`/root/abacus-develop/source/source_cell/read_atoms_helper.cpp`**
- `process_magnetization()`:302-309 — nspin/noncolin 条件分支（DZ-001 修复点）
- `parse_atom_properties()`:349-486 — 解析 `mag`/`magmom`/`angle1`/`angle2`
- 自动磁矩初始化:82-132 — nspin=4 默认 (1,1,1), nspin=2 默认 (0,0,1)

**`/root/abacus-develop/source/source_cell/read_atoms.cpp`**
- `unitcell::read_atom_positions()`:21-121 — STRU 解析入口

**`/root/abacus-develop/source/source_cell/atom_spec.h`** (数据结构)
- `mag[]`: 标量磁矩
- `angle1[]`, `angle2[]`: 球坐标角度
- `m_loc_[]`: 笛卡尔磁矩向量 (mx, my, mz)

### Target Code (磁性计算)

**`/root/abacus-develop/source/source_estate/magnetism.h`** (lines 16-39)
- `start_mag[]`: 元素级默认磁矩
- `tot_mag`: 总磁矩 (nspin=2)
- `tot_mag_nc[3]`: 非共线磁矩向量 (nspin=4)
- `ux_[3]`: 磁化方向

**`/root/abacus-develop/source/source_estate/magnetism.cpp`** (lines 20-106)
- `compute_mag()`: 从电荷密度计算磁矩
  - nspin=2: `tot_mag = Σ(rho_up - rho_down)`
  - nspin=4: `tot_mag_nc[i] = Σ(rho[i+1])`

### 参数验证

**`/root/abacus-develop/source/source_io/module_parameter/input_parameter.h`**
- `nspin`: 1, 2, 4
- `noncolin`: bool
- `lspinorb`: bool (SOC)

### DeltaSpin 约束磁性

**`/root/abacus-develop/source/source_lcao/module_deltaspin/spin_constrain.h`** (line 250)
- `constrain_[]`: 每原子约束标志
- `target_mag_[]`: 目标磁矩
- `lambda_[]`: Lagrange 乘子

## Implementation Guide

### Architecture Decisions

- 建立参数组合合法性矩阵，在参数读取阶段统一校验
- 对不合法/不推荐的组合给出明确的 WARNING 或 ERROR
- 不改变物理行为，只改善用户体验和错误提示

### 参数组合矩阵

| nspin | noncolin | lspinorb | 合法性 | 行为 | 建议 |
|-------|----------|----------|--------|------|------|
| 1 | false | false | OK | 非磁性 | - |
| 1 | true | - | ERROR | 无意义 | 报错 |
| 2 | false | false | OK | 共线自旋极化 | - |
| 2 | true | - | ERROR | 无意义 | 报错：nspin=2 不支持非共线 |
| 2 | false | true | ERROR | 无意义 | 报错：SOC 需要 nspin=4 |
| 4 | false | false | WARNING | 共线但用 4 分量 | 警告：建议用 nspin=2 |
| 4 | true | false | OK | 非共线 | - |
| 4 | false | true | WARNING | SOC+共线 | 自动设 noncolin=true |
| 4 | true | true | OK | 非共线+SOC | - |

### 实现步骤

1. 在参数读取阶段（`read_input_item_system.cpp`）添加组合校验
2. 对 nspin=4 + noncolin=false 自动设置 noncolin=true 并 WARNING
3. 对 nspin=2 + noncolin=true 报 ERROR
4. 对 nspin=2 + lspinorb=true 报 ERROR
5. 更新文档说明各参数含义和推荐用法

### Critical Implementation Details

- 校验应在参数读取后、STRU 解析前执行
- 自动修正（如 noncolin=false→true）必须输出 WARNING 日志
- 不能破坏现有的 CI 测试用例 — 检查是否有测试依赖 nspin=4+noncolin=0

## TDD Test Plan

### Tests to Write FIRST

```cpp
// test_parameter_validation.cpp

TEST(ParamValidation, Nspin4NoncolinFalse_AutoCorrect) {
    // nspin=4 + noncolin=false → 自动设为 true + WARNING
    set_param(nspin=4, noncolin=false, lspinorb=false);
    validate_spin_params();
    EXPECT_TRUE(PARAM.inp.noncolin);  // 自动修正
    EXPECT_TRUE(has_warning("noncolin"));
}

TEST(ParamValidation, Nspin2NoncolinTrue_Error) {
    set_param(nspin=2, noncolin=true);
    EXPECT_THROW(validate_spin_params(), std::runtime_error);
}

TEST(ParamValidation, Nspin2SOC_Error) {
    set_param(nspin=2, lspinorb=true);
    EXPECT_THROW(validate_spin_params(), std::runtime_error);
}

TEST(ParamValidation, Nspin4NoncolinTrue_OK) {
    set_param(nspin=4, noncolin=true, lspinorb=false);
    EXPECT_NO_THROW(validate_spin_params());
}

TEST(ParamValidation, Nspin4SOC_OK) {
    set_param(nspin=4, noncolin=true, lspinorb=true);
    EXPECT_NO_THROW(validate_spin_params());
}
```

```python
# test_magnetization_matrix.py (集成测试)

import pytest

@pytest.mark.parametrize("nspin,noncolin,mag_input,expected_mag", [
    (1, False, (0,0,0), (0,0,0)),
    (2, False, (0,0,2), (0,0,2)),
    (4, True, (1,1,1), (1,1,1)),
    (4, False, (1,1,1), (1,1,1)),  # 自动修正后应保留
])
def test_magnetization_init(nspin, noncolin, mag_input, expected_mag):
    result = run_stru_parse(nspin=nspin, noncolin=noncolin, mag=mag_input)
    assert_mag_equal(result.m_loc, expected_mag, tol=1e-10)
```

## Acceptance Criteria

- [ ] nspin/noncolin/soc 所有合法组合的磁矩初始化行为正确且一致
- [ ] 不合法组合给出明确错误信息
- [ ] 添加参数组合的集成测试矩阵
- [ ] 更新用户文档
