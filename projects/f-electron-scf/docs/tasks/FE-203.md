# FE-203: 占据矩阵退火策略

## Objective

[TERMINATED] 实现占据退火：(1) 初始阶段使用高 smearing 温度（如 0.1 Ry），使占据矩阵平滑化，(2) 逐步降低 smearing 到目标值（如 0.01 Ry），(3) 与 U-ramping 协同：先 ramping U 到目标值，再退火 smearing。在 dftu_occup.cpp 中实现退火调度器。

终止原因：见 plans/2026-02-16-critical-review.md

## Reference Code

### Source Code (to migrate from)

本任务不涉及外部代码迁移，属于 ABACUS 内部新功能开发。参考以下已有的调度机制：

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 行) — `Plus_U` 类定义
- `uramping` (静态成员, 第 62 行): U-ramping 步长，控制 U 参数逐步增大的速率
- `uramping_update()` (第 55 行): 每步更新 U 值的方法，退火调度器需要与之协同

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.cpp`** (482 行) — U-ramping 实现
- `init()` (第 45 行): DFT+U 初始化，包含 `U0[]` (目标 U) 和 `U[]` (当前 U) 的设置
- `uramping_update()` (第 394 行): U-ramping 核心逻辑 — 每步将 `U[i] += uramping` 直到达到 `U0[i]`，退火调度器需要检测此过程是否完成

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 行) — 占据矩阵操作
- `mix_locale()` (第 85 行): 占据矩阵混合，退火过程中 smearing 变化会影响混合稳定性
- `copy_locale()` (第 9 行): 保存当前占据矩阵
- `zero_locale()` (第 47 行): 清零占据矩阵

### Target Code (to integrate with)

**`/root/abacus-develop/source/source_io/module_parameter/input_parameter.h`** (704 行) — 输入参数
- `smearing_sigma` (第 98 行): 当前 smearing 宽度参数，退火需要动态修改此值
- `mixing_beta` (第 101 行): 电荷混合系数，退火过程中可能需要协同调整

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.cpp`** (259 行) — 电荷混合
- `set_mixing()` (第 30 行): 设置混合参数
- `init_mixing()` (第 107 行): 初始化混合器
- `mix_reset()` (第 198 行): 重置混合历史，smearing 大幅变化时可能需要调用

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 行) — PW 基 SCF 循环
- `iter_init()` (第 170 行): SCF 每步初始化，退火调度器的调用点
- `iter_finish()` (第 273 行): SCF 每步结束，检查退火状态

**`/root/abacus-develop/source/source_esolver/esolver_ks_lcao.cpp`** (572 行) — LCAO 基 SCF 循环
- `iter_init()` (第 320 行): LCAO 版本的 SCF 每步初始化
- `iter_finish()` (第 463 行): LCAO 版本的 SCF 每步结束

### Prior Art / Related Implementations

**QE `starting_ns_eigenvalue`**: 允许用户指定初始占据矩阵本征值，间接控制初始占据分布。不支持动态退火。

**VASP SIGMA 参数**: 全局 smearing 宽度，用户可手动分步降低。无自动退火机制。

**Elk 温度退火**: 在 SCF 迭代中逐步降低电子温度，与本任务最为接近。采用指数衰减策略。

**ABACUS U-ramping** (`dftu.cpp:394`): 已有的调度模式 — 每步线性增加 U 直到目标值。退火调度器可复用此模式的"每步更新 + 完成检测"设计。

## Implementation Guide

### Architecture Decisions

1. **新建 `AnnealingScheduler` 类**: 放在 `source/source_lcao/module_dftu/` 目录下，与 DFT+U 模块紧密关联。独立头文件 `annealing_scheduler.h` 便于单元测试。

2. **指数衰减策略**: `sigma(t) = sigma_target + (sigma_high - sigma_target) * exp(-t/tau)`。选择指数衰减而非线性衰减，因为：(a) 初期快速降温有助于跳出浅局域极小，(b) 后期缓慢降温避免电荷震荡。

3. **与 U-ramping 的两阶段协同**:
   - 阶段一 (U-ramping): `U` 从 0 逐步增大到 `U0`，此时 `sigma` 保持 `sigma_high` 不变
   - 阶段二 (退火): U-ramping 完成后，`sigma` 从 `sigma_high` 指数衰减到 `sigma_target`
   - 通过检查 `U[i] >= U0[i]` (对所有 i) 判断 U-ramping 是否完成

4. **不修改 `smearing_sigma` 全局参数**: 退火使用独立的 `annealing_sigma` 变量，仅在 DFT+U 占据矩阵计算中使用。避免影响 Fermi 面计算和其他依赖 smearing 的模块。

### Data Structure Mapping

| 组件 | 变量/方法 | 用途 |
|------|-----------|------|
| `AnnealingScheduler` | `sigma_high_` | 初始高 smearing (默认 0.1 Ry) |
| `AnnealingScheduler` | `sigma_target_` | 目标 smearing (默认 0.01 Ry) |
| `AnnealingScheduler` | `tau_` | 衰减时间常数 (默认 30 步) |
| `AnnealingScheduler` | `uramping_done_` | U-ramping 完成标志 |
| `AnnealingScheduler` | `annealing_step_` | 退火开始后的步数计数 |
| `AnnealingScheduler` | `get_sigma(step)` | 返回当前步的 sigma 值 |
| `AnnealingScheduler` | `set_uramping_done(bool)` | 设置 U-ramping 完成状态 |
| `Plus_U` | `annealing_scheduler_` | 调度器实例 (可选成员) |
| `ESolver_KS::iter_init()` | 调用点 | 每步更新退火状态 |

### Critical Implementation Details

1. **Smearing 影响全局**: `smearing_sigma` 不仅影响 f 电子占据，还影响 Fermi 能级和所有电子的占据数。因此退火 sigma 应仅用于 DFT+U 占据矩阵的平滑化，不应修改全局 `PARAM.inp.smearing_sigma`。

2. **退火速度与电荷震荡**: sigma 变化过快会导致占据数突变，引发电荷密度震荡。建议 `tau >= 20` 步。当检测到能量震荡时（连续两步 ΔE 符号交替），应暂停退火。

3. **混合历史失效**: sigma 大幅变化后，Pulay 混合的历史向量可能不再有效。当 `|sigma(t) - sigma(t-1)| / sigma(t-1) > 0.1` 时，考虑调用 `mix_reset()` 清除混合历史。

4. **SCF 重启**: 退火状态（当前 sigma、步数、U-ramping 完成标志）需要保存到 checkpoint 文件，以支持 SCF 重启后继续退火。

5. **终止条件**: 当 `sigma` 已衰减到 `sigma_target` 的 1.01 倍以内时，锁定为 `sigma_target`，避免浮点精度问题导致的无限逼近。

## TDD Test Plan

### Tests to Write FIRST

```cpp
#include <gtest/gtest.h>
#include <cmath>
#include "module_dftu/annealing_scheduler.h"

class AnnealingTest : public testing::Test
{
  protected:
    void SetUp() override {}
};

// 测试指数衰减基本行为
TEST_F(AnnealingTest, SigmaDecaysExponentially)
{
    AnnealingScheduler sched(/*sigma_high=*/0.1, /*sigma_target=*/0.01, /*tau=*/30);
    sched.set_uramping_done(true);

    // 初始值等于 sigma_high
    EXPECT_NEAR(sched.get_sigma(0), 0.1, 1e-10);

    // t=tau 时衰减到 sigma_target + (sigma_high - sigma_target) * exp(-1)
    double expected_at_tau = 0.01 + (0.1 - 0.01) * std::exp(-1.0);
    EXPECT_NEAR(sched.get_sigma(30), expected_at_tau, 1e-6);

    // 大步数后接近但不低于 sigma_target
    EXPECT_GT(sched.get_sigma(100), 0.01 - 1e-10);
}

// 测试 U-ramping 未完成时退火不启动
TEST_F(AnnealingTest, CoordinatesWithURamping)
{
    AnnealingScheduler sched(0.1, 0.01, 30);
    sched.set_uramping_done(false);

    // U-ramping 未完成，sigma 保持 sigma_high
    EXPECT_NEAR(sched.get_sigma(50), 0.1, 1e-10);

    // U-ramping 完成后开始退火
    sched.set_uramping_done(true);
    EXPECT_LT(sched.get_sigma(50), 0.1);
}

// 测试 sigma 永远不低于目标值
TEST_F(AnnealingTest, NeverBelowTarget)
{
    AnnealingScheduler sched(0.1, 0.01, 30);
    sched.set_uramping_done(true);

    for (int step = 0; step < 1000; step++)
    {
        EXPECT_GE(sched.get_sigma(step), 0.01 - 1e-10);
    }
}

// 测试 sigma_high == sigma_target 时无退火
TEST_F(AnnealingTest, NoAnnealingWhenEqual)
{
    AnnealingScheduler sched(0.05, 0.05, 30);
    sched.set_uramping_done(true);

    for (int step = 0; step < 100; step++)
    {
        EXPECT_NEAR(sched.get_sigma(step), 0.05, 1e-10);
    }
}

// 测试退火步数计数器在 U-ramping 完成后才开始
TEST_F(AnnealingTest, AnnealingStepCountsFromURampingDone)
{
    AnnealingScheduler sched(0.1, 0.01, 30);
    sched.set_uramping_done(false);

    // 模拟 100 步 U-ramping
    for (int step = 0; step < 100; step++)
    {
        sched.get_sigma(step);
    }
    // 此时退火步数应为 0
    sched.set_uramping_done(true);
    // 退火刚开始，sigma 应接近 sigma_high
    double sigma_start = sched.get_sigma(100);
    EXPECT_NEAR(sigma_start, 0.1, 0.005);
}
```

## Acceptance Criteria

- [ ] 实现 smearing 温度退火
- [ ] 与 U-ramping 协同
- [ ] EuO 等多极小值体系的收敛成功率提升>50%
- [ ] 验证收敛率改善
