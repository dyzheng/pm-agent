# FE-305: 收敛可靠性测试

## Objective

对每个验证体系运行10次不同随机种子的计算，统计收敛率和能量一致性。

## Reference Code

### SCF 循环与收敛判据

**`/root/abacus-develop/source/source_esolver/esolver_ks.cpp`** (349 行) — KS 求解器基类
- SCF 主循环逻辑
- 收敛判据：`drho < scf_thr`（电荷密度变化小于阈值）
- `scf_nmax`: 最大 SCF 迭代步数

### 电荷密度混合

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.cpp`** (259 行) — 混合算法实现
- Pulay 混合（默认）、Broyden 混合
- `mixing_beta`: 混合参数，影响收敛速度和稳定性
- `mixing_ndim`: 混合历史维度

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.h`** (213 行) — 混合参数定义
- `mixing_beta_mag`: 磁化密度混合参数（磁性体系关键）

### DFT+U 占据矩阵混合

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 行) — 占据矩阵处理
- 占据矩阵的初始化和更新
- 占据矩阵混合影响 f 电子收敛
- 不同随机种子导致不同初始占据，可能收敛到不同局域极小

### 输入参数

**`/root/abacus-develop/source/source_io/module_parameter/input_parameter.h`** (704 行) — 输入参数定义
- `scf_nmax`: 最大 SCF 步数（默认 100，f 电子体系建议 200-500）
- `scf_thr`: SCF 收敛阈值（默认 1e-9，可适当放宽到 1e-7）
- `init_chg`: 初始电荷密度来源（`atomic` / `file` / `random`）
- `mixing_beta`: 电荷混合参数
- `mixing_beta_mag`: 磁化密度混合参数

## Implementation Guide

### 测试设计

对每个验证体系运行 10 次独立计算，通过改变初始条件引入随机性：

1. **随机性来源**
   - `init_chg=atomic` + 不同初始磁矩扰动（±10%）
   - 不同 `mixing_beta` 微扰（基准值 ±0.05）
   - 不同 `smearing_sigma` 微扰
   - 目的：测试 SCF 收敛对初始条件的敏感性

2. **测试体系（按难度递增）**

| 体系 | 难度 | 预期收敛率 | 关键挑战 |
|------|------|-----------|----------|
| CeO2 PBE | 简单 | >95% | 无 f 电子问题 |
| CeO2 PBE+U | 中等 | >90% | f 电子局域化 |
| GdN PBE+U | 中等 | >85% | 磁性 + f 电子 |
| NdFeB PBE+U | 困难 | >70% | 大体系 + 磁性 + f 电子 |

3. **统计指标**

| 指标 | 计算方法 | Pass 标准 |
|------|----------|-----------|
| 收敛率 | 收敛次数 / 总次数 | ≥ 90%（简单）, ≥ 70%（困难） |
| 平均 SCF 步数 | 收敛计算的平均迭代步数 | 记录即可 |
| 能量标准差 | 收敛计算的总能量 std dev | < 1 meV/atom |
| 占据矩阵标准差 | 收敛计算的 f 电子占据 std dev | < 0.05 |
| 最大能量偏差 | max(E) - min(E) | < 5 meV/atom |

### 自动化脚本架构

```
reliability_test.py
├── run_single(system, seed, params) -> result_dict
├── run_batch(system, n_runs=10) -> list[result_dict]
├── analyze_results(results) -> statistics_dict
└── generate_report(all_stats) -> reliability_report.md
```

- `run_single`: 调用 subprocess 运行 ABACUS，解析输出文件提取能量、磁矩、SCF 步数
- `run_batch`: 并行运行 10 次计算（可用 multiprocessing）
- `analyze_results`: 计算统计指标
- `generate_report`: 生成 Markdown 报告

### 失败诊断

对于未收敛的计算，记录：
- 最终 drho 值（距收敛阈值多远）
- 能量振荡模式（单调下降 / 振荡 / 发散）
- 占据矩阵变化趋势
- 建议的参数调整（减小 mixing_beta、增加 scf_nmax 等）

## TDD Test Plan

### Tests to Write FIRST

```python
import json

def test_reliability_results():
    """验证可靠性测试结果文件存在且格式正确"""
    with open("projects/f-electron-scf/validation/reliability_results.json") as f:
        results = json.load(f)
    for system in results:
        assert results[system]["n_runs"] >= 10, \
            f"{system}: only {results[system]['n_runs']} runs (need >=10)"
        assert "convergence_rate" in results[system], \
            f"{system}: missing convergence_rate"
        assert "energy_std_meV" in results[system], \
            f"{system}: missing energy_std_meV"

def test_convergence_rate_acceptable():
    """验证收敛率在可接受范围内"""
    with open("projects/f-electron-scf/validation/reliability_results.json") as f:
        results = json.load(f)
    for system in results:
        rate = results[system]["convergence_rate"]
        assert rate >= 0.7, f"{system}: convergence rate {rate} < 70%"

def test_energy_consistency():
    """验证收敛计算的能量一致性"""
    with open("projects/f-electron-scf/validation/reliability_results.json") as f:
        results = json.load(f)
    for system in results:
        std = results[system].get("energy_std_meV", float("inf"))
        assert std < 5.0, f"{system}: energy std {std} meV > 5 meV"

def test_failed_runs_diagnosed():
    """验证失败计算有诊断信息"""
    with open("projects/f-electron-scf/validation/reliability_results.json") as f:
        results = json.load(f)
    for system in results:
        n_failed = results[system]["n_runs"] - int(
            results[system]["convergence_rate"] * results[system]["n_runs"]
        )
        if n_failed > 0:
            assert "failed_diagnostics" in results[system], \
                f"{system}: {n_failed} failed runs without diagnostics"

def test_reliability_report_exists():
    """验证可靠性报告已生成"""
    import os
    assert os.path.exists("projects/f-electron-scf/validation/reliability_report.md")
```

## Acceptance Criteria

- [ ] 每个体系运行10次（不同随机种子）
- [ ] 收敛率>90%
- [ ] 收敛结果能量标准差<1 meV
- [ ] 记录失败案例的诊断信息
