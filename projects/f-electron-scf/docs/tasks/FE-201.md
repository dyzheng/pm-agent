# FE-201: 分通道 mixing_beta 实现

## Objective

在 charge_mixing 中实现按角动量通道分别设置 mixing_beta 的能力。f 电子通道使用更小的 mixing_beta（如 0.05-0.1），s/p/d 通道使用正常值（0.3-0.7）。实现方式：在实空间投影到原子轨道分量后分别 mixing，或在密度矩阵 mixing（LCAO）中按 l 分通道。

## Reference Code

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.h`** (213 lines)
- `Charge_Mixing` 类
- `mixing_beta` — 当前为标量，需扩展为 per-channel
- `mixing_beta_mag` — 磁性通道的 mixing_beta

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing_rho.cpp`** (613 lines)
- `mix_rho()` — 电荷密度 mixing，需添加分通道逻辑

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing_dmr.cpp`** (226 lines)
- `mix_dmr()` — 密度矩阵 mixing（LCAO），更适合按 l 分通道
- 密度矩阵天然按轨道索引，可直接按 l 值分组

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 lines)
- `mix_locale()` — 占据矩阵 mixing，已按 l 分通道
- 可参考其 per-l mixing 的实现模式

### Prior Art

**VASP AMIX/BMIX**: VASP 对电荷和磁矩使用不同的 mixing 参数，但不按 l 分通道。
**Elk**: Elk 的 `mixtype` 支持按 muffin-tin 和 interstitial 分别 mixing。

## Implementation Guide

### Architecture Decisions

- **方案选择**: 在密度矩阵 mixing（`mix_dmr()`）中按 l 分通道，而非在实空间电荷密度中分通道
  - 理由: 密度矩阵天然按轨道索引，分通道简单且精确
  - 实空间分通道需要投影/反投影，计算开销大且不精确
- **PW 基组**: PW 下没有密度矩阵 mixing，改为在 `mix_locale()`（占据矩阵 mixing）中按 l 分通道
- 新增输入参数: `mixing_beta_f`（f 通道 mixing_beta），默认 0.1

### 实现路径

```
LCAO 路径:
  mix_dmr() → 按 l 值分组 → f 通道用 mixing_beta_f → 其他通道用 mixing_beta

PW 路径:
  mix_rho() → 不变（全局 mixing_beta）
  mix_locale() → 按 l 值分组 → f 通道用 mixing_beta_f → 其他通道用 mixing_beta
```

### Critical Implementation Details

- **l 值获取**: 从 `LCAO_Orbitals` 或 `UnitCell` 获取每个轨道的 l 值
- **密度矩阵索引**: `DensityMatrix<TK, double>` 的矩阵元素按 (μ,ν) 索引，需要映射到 (l_μ, l_ν)
- **交叉项**: l_μ ≠ l_ν 的交叉项使用 max(β_μ, β_ν) 或 geometric mean
- **Broyden 历史**: 分通道 mixing 需要独立的 Broyden 历史，或使用加权方案
- **向后兼容**: `mixing_beta_f` 未设置时使用全局 `mixing_beta`

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(ChannelMixingTest, FChannelSmallerBeta) {
    // f 通道应使用更小的 mixing_beta
    setup_ceo2_lcao();
    set_mixing_beta_f(0.1);
    auto beta_s = get_effective_beta(/*l=*/0);
    auto beta_f = get_effective_beta(/*l=*/3);
    EXPECT_GT(beta_s, beta_f);
    EXPECT_NEAR(beta_f, 0.1, 1e-10);
}

TEST_F(ChannelMixingTest, NonFSystemUnaffected) {
    // 无 f 电子体系不受影响
    setup_si_lcao();
    set_mixing_beta_f(0.1);
    // Si 没有 f 轨道，所有通道用 mixing_beta
    auto beta = get_effective_beta(/*l=*/1);
    EXPECT_NEAR(beta, default_mixing_beta, 1e-10);
}

TEST_F(ChannelMixingTest, ConvergenceImproved) {
    // CeO2 分通道 mixing 应改善收敛
    auto steps_uniform = run_scf_uniform_beta("CeO2", 0.3);
    auto steps_channel = run_scf_channel_beta("CeO2", 0.3, 0.1);
    EXPECT_LT(steps_channel, steps_uniform);
}
```

## Acceptance Criteria

- [ ] 识别 f 通道并单独设置 mixing_beta
- [ ] 改善 f 电子体系收敛稳定性
- [ ] 含 f 电子体系的 SCF 收敛性改善
- [ ] 不影响无 f 电子体系的性能
