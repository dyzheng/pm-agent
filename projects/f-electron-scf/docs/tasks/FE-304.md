# FE-304: 跨代码验证（ABACUS vs VASP）

## Objective

对选定的验证体系，运行 ABACUS 和 VASP 计算，对比晶格常数、磁矩、带隙、形成能等关键性质。如果误差>5%且可追溯到赝势，触发 FE-D-A1。

## Reference Code

### SCF 求解器

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 行) — PW 基组 KS 求解器
- `cal_energy()`:388 — 总能量计算
- `cal_force()`:394 — 原子力计算
- `cal_stress()`:408 — 应力张量计算

**`/root/abacus-develop/source/source_esolver/esolver_ks_lcao.cpp`** (572 行) — LCAO 基组 KS 求解器
- LCAO 基组下 DFT+U 功能更完整

### DFT+U 模块

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 行) — DFT+U 核心接口
- `cal_energy_correction()`: Hubbard U 能量修正
- 跨代码对比时需确保 U 参数和投影方式一致

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_io.cpp`** (538 行) — DFT+U 输入输出
- 占据矩阵输出：用于对比两个代码的 f 电子占据

### 赝势兼容性

**`/root/abacus-develop/source/source_cell/read_pp.h`** (130 行) — 赝势读取
- `read_pp_upf()`: UPF 格式赝势
- ABACUS 使用 NCPP（模守恒赝势），VASP 使用 PAW（投影缀加波）
- 赝势差异是跨代码偏差的主要来源

### 收敛与 EOS 测试工具

**`/root/abacus-test/abacustest/lib_model/model_001_Conv.py`** (130 行) — 收敛性测试
- 截断能收敛、k 点收敛测试
- 确保两个代码使用等效精度的计算参数

**`/root/abacus-test/abacustest/lib_model/model_004_Eos.py`** (404 行) — EOS 拟合
- Birch-Murnaghan 状态方程拟合
- 提取平衡体积和体模量

## Implementation Guide

### 系统对比协议

跨代码对比的核心原则：尽可能消除非赝势因素的差异。

1. **参数等效性**

| 参数 | ABACUS | VASP | 等效说明 |
|------|--------|------|----------|
| 截断能 | ecutwfc=80 Ry (1088 eV) | ENCUT=600 eV | ABACUS 偏高以补偿 NCPP vs PAW |
| k 点 | kpoints=6x6x6 | KPOINTS=6x6x6 | 相同 |
| 展宽 | smearing_sigma=0.01 Ry | SIGMA=0.01 eV | 注意单位换算 |
| U 值 | hubbard_u Ce=4.5 | LDAUU Ce=4.5 | 相同数值 |
| 自旋 | nspin=2 | ISPIN=2 | 相同 |

2. **对比性质与容差**

| 性质 | 容差 | 超标处理 |
|------|------|----------|
| 晶格常数 (Å) | <2% | 检查赝势 |
| 体模量 (GPa) | <10% | 检查 EOS 拟合质量 |
| 带隙 (eV) | <0.3 eV 或定性一致 | 检查 U 投影方式 |
| 磁矩 (μB) | <0.1 μB | 检查占据矩阵 |
| 形成能 (eV/atom) | <50 meV/atom | 检查参考态能量 |

3. **误差归因流程**

当偏差 > 5% 时：
- 步骤1：检查计算参数是否等效（截断能收敛、k 点收敛）
- 步骤2：对比占据矩阵（f 电子占据是否一致）
- 步骤3：运行 FE-306 全电子参考计算
- 步骤4：如果 ABACUS 偏离全电子结果但 VASP 接近，则归因于 NCPP 赝势
- 步骤5：如果两者都偏离全电子结果，则归因于赝势近似本身
- 步骤6：如果仅 ABACUS 偏离且非赝势原因，则归因于算法实现

### 输出格式

`comparison.json` 结构：
```json
{
  "CeO2_PBE+U": {
    "abacus": {"lattice_constant_A": 5.48, "band_gap_eV": 2.8, "magnetic_moment_uB": 0.0},
    "vasp": {"lattice_constant_A": 5.47, "band_gap_eV": 3.0, "magnetic_moment_uB": 0.0},
    "deviation": {"lattice_constant_pct": 0.18, "band_gap_eV": 0.2, "max_pct": 0.18},
    "attribution": null
  }
}
```

`comparison_report.md`：包含对比表格、偏差分析、误差归因结论。

## TDD Test Plan

### Tests to Write FIRST

```python
import json

def test_cross_code_comparison():
    """验证跨代码对比数据完整"""
    with open("projects/f-electron-scf/validation/cross_code/comparison.json") as f:
        data = json.load(f)
    for system in data:
        assert "abacus" in data[system], f"{system}: missing ABACUS data"
        assert "vasp" in data[system], f"{system}: missing VASP data"
        assert "deviation" in data[system], f"{system}: missing deviation"

def test_error_attribution():
    """验证偏差>5%的体系有误差归因"""
    with open("projects/f-electron-scf/validation/cross_code/comparison.json") as f:
        data = json.load(f)
    for system in data:
        if data[system].get("deviation", {}).get("max_pct", 0) > 5.0:
            assert "attribution" in data[system], \
                f"{system}: >5% deviation without attribution"
            assert data[system]["attribution"] is not None, \
                f"{system}: attribution is null despite >5% deviation"

def test_parameter_equivalence_documented():
    """验证计算参数等效性已记录"""
    with open("projects/f-electron-scf/validation/cross_code/comparison.json") as f:
        data = json.load(f)
    for system in data:
        assert "parameters" in data[system] or "parameter_equivalence" in data[system], \
            f"{system}: missing parameter documentation"

def test_comparison_report_exists():
    """验证对比报告已生成"""
    import os
    assert os.path.exists("projects/f-electron-scf/validation/cross_code/comparison_report.md")

def test_all_validation_systems_covered():
    """验证所有选定验证体系均已对比"""
    with open("projects/f-electron-scf/validation/cross_code/comparison.json") as f:
        data = json.load(f)
    # 至少包含 CeO2（来自 FE-302）和一个来自 FE-301 的体系
    system_names = " ".join(data.keys())
    assert "CeO2" in system_names, "CeO2 not in comparison"
```

## Acceptance Criteria

- [ ] ABACUS vs VASP 结构性质误差<2%
- [ ] 能量误差<10%
- [ ] 磁矩误差<0.1 μB
- [ ] 如果误差>5%且可追溯到赝势，触发 FE-D-A1
