# FE-202: 占据矩阵随机初始化 + 多起点探索

## Objective

在 dftu.cpp 中实现：(1) 随机占据矩阵初始化（在合理物理约束内随机），(2) 基于氧化态的化学直觉初始化（如 Ce4+ → f^0, Ce3+ → f^1），(3) 多起点并行探索接口（运行 N 个不同初始化的 SCF，选最低能量）。新增输入参数：omc_random, omc_nstart, omc_seed。

## Reference Code

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 lines)
- `Plus_U` 类
- `omc` — 现有的 occupation matrix control（从文件读取目标占据矩阵）
- `locale[iat][l][n][spin]` — 占据矩阵

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.cpp`** (482 lines)
- `init()` — DFT+U 初始化，locale 初始化在此处
- 需添加随机初始化和化学直觉初始化逻辑

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 lines)
- `copy_locale()`, `zero_locale()` — locale 操作工具
- 需添加 `random_locale()` 和 `chemical_locale()` 方法

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_io.cpp`** (538 lines)
- `read_occup_m()` — 从文件读取占据矩阵（现有 omc 功能）
- 可参考其格式用于多起点结果保存

### Prior Art

**VASP LDAUPRINT=2 + OCCMATRIX**: VASP 支持从文件读取初始占据矩阵。
**QE starting_ns_eigenvalue**: QE 支持指定初始 d/f 轨道占据。
**Elk fixspin**: Elk 支持固定自旋磁矩的 SCF。

## Implementation Guide

### Architecture Decisions

- **三种初始化模式**: 通过 `omc_mode` 参数选择
  - `file`: 从文件读取（现有 omc 功能）
  - `random`: 随机初始化
  - `chemical`: 基于氧化态的化学直觉
- **多起点**: `omc_nstart > 1` 时运行 N 个 SCF，每个使用不同随机种子
- **多起点实现**: 串行运行 N 次（简单），或通过 MPI images 并行（高级）

### 随机初始化约束

```
locale[iat][l][n][spin] 的约束:
1. Hermitian: locale[m,m'] = conj(locale[m',m])
2. 正定: 所有本征值 ∈ [0, 1]
3. 迹约束: Tr(locale) ≈ n_target（如果指定）
4. 物理合理: 对角元素 ∈ [0, 1]

生成方法:
1. 生成随机 Hermitian 矩阵 H
2. 对角化: H = U·D·U†
3. 将本征值映射到 [0, 1]: d_i → sigmoid(d_i)
4. 缩放使 Tr = n_target
5. 重构: locale = U·D'·U†
```

### 化学直觉初始化

| 氧化态 | f 电子数 | locale 对角元素 | 说明 |
|--------|---------|----------------|------|
| Ce4+ | 0 | 全 0 | CeO2 中的 Ce |
| Ce3+ | 1 | 一个 1，其余 0 | Ce2O3 中的 Ce |
| Gd3+ | 7 | 全 1（半满） | GdN 中的 Gd |
| Nd3+ | 3 | 3 个 1，其余 0 | NdFeB 中的 Nd |

### Critical Implementation Details

- **随机种子**: `omc_seed` 控制可重复性，默认使用时间戳
- **多起点输出**: 每个起点的能量和占据矩阵保存到 `omc_start_{i}.dat`
- **最低能量选择**: 所有起点完成后，选择总能量最低的结果
- **与 mixing_dftu 的交互**: 随机初始化后的前几步建议开启 mixing_dftu
- **MPI 并行**: 多起点可通过 `-ni` (images) 并行，每个 image 运行一个起点

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(OmcRandomTest, RandomLocaleHermitian) {
    // 随机 locale 应为 Hermitian
    auto locale = generate_random_locale(/*l=*/3, /*seed=*/42);
    for (int m = 0; m < 7; m++)
        for (int mp = 0; mp < 7; mp++)
            EXPECT_NEAR(locale[m][mp].real(), locale[mp][m].real(), 1e-10);
}

TEST_F(OmcRandomTest, RandomLocalePositiveSemidefinite) {
    // 随机 locale 的本征值应在 [0, 1]
    auto locale = generate_random_locale(/*l=*/3, /*seed=*/42);
    auto eigenvalues = diagonalize(locale);
    for (auto ev : eigenvalues) {
        EXPECT_GE(ev, -1e-10);
        EXPECT_LE(ev, 1.0 + 1e-10);
    }
}

TEST_F(OmcRandomTest, ChemicalInitCe4Plus) {
    // Ce4+ 应初始化为 f^0
    auto locale = generate_chemical_locale("Ce", 4);
    double trace = 0;
    for (int m = 0; m < 7; m++) trace += locale[m][m].real();
    EXPECT_NEAR(trace, 0.0, 0.1);
}

TEST_F(OmcRandomTest, MultiStartSelectsLowest) {
    // 多起点应选择最低能量
    auto results = run_multi_start("CeO2", /*nstart=*/3);
    double min_energy = *min_element(results.energies.begin(), results.energies.end());
    EXPECT_NEAR(results.selected_energy, min_energy, 1e-10);
}
```

## Acceptance Criteria

- [ ] 添加 omc_mode=random 选项
- [ ] 支持多起点并行运行
- [ ] 自动选择最低能量结果
- [ ] CeO2 的 DFT+U 计算能通过多起点找到正确基态（与 VASP 一致）
