# FE-303: 合金与磁性化合物验证

## Objective

中等难度验证：(1) NdFeB/SmCo5 合金的磁矩和磁各向异性，(2) GdN/EuO 的磁序和交换耦合，(3) TbMnO3 的多铁性。重点关注 DFT+U 参数敏感性和 SCF 收敛可靠性。

## Reference Code

### SCF 求解器

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 行) — PW 基组 KS 求解器
- `cal_energy()`:388 — 总能量计算
- `cal_force()`:394 — 原子力计算
- `cal_stress()`:408 — 应力张量计算

**`/root/abacus-develop/source/source_esolver/esolver_ks_lcao.cpp`** (572 行) — LCAO 基组 KS 求解器
- LCAO 基组下 DFT+U 功能更完整，磁性体系优先使用 LCAO

### DFT+U 模块

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 行) — DFT+U 核心接口
- `cal_energy_correction()`: Hubbard U 能量修正
- `cal_force_correction()`: Hubbard U 力修正
- 磁性体系需要仔细调节 U 参数

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_io.cpp`** (538 行) — DFT+U 输入输出
- 占据矩阵输出：分析 4f 电子自旋极化占据

### 磁性计算模块

**`/root/abacus-develop/source/source_lcao/module_deltaspin/spin_constrain.h`** (291 行) — 自旋约束
- `SpinConstrain` 类：约束磁矩方向和大小
- 用于非共线磁性计算（MAE 需要 nspin=4）
- `lambda_loop()`: 约束场迭代

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.h`** (213 行) — 电荷/磁化密度混合
- `mixing_beta`: 电荷密度混合参数
- `mixing_beta_mag`: 磁化密度混合参数（磁性体系关键参数）
- 磁性体系通常需要较小的 `mixing_beta_mag`（0.1-0.4）以保证收敛

## Implementation Guide

### 磁性体系计算策略

磁性体系的 SCF 收敛是主要挑战，需要分层验证：

1. **GdN（rocksalt 结构，FM）— 最简单的磁性验证**
   - 空间群 Fm-3m，2 原子/单胞
   - nspin=2（共线铁磁）
   - Gd 4f 磁矩预期 ~7 μB（半满 4f7）
   - U 参数：Gd 4f U=6.0 eV（文献常用值）
   - 参考：实验 Gd 磁矩 7.63 μB，交换分裂 ~0.9 eV

2. **NdFeB（Nd2Fe14B，P42/mnm）— 中等难度**
   - 56 原子/单胞，计算量较大
   - nspin=2（共线 FM 作为起点）
   - Nd 4f 磁矩预期 ~3.3 μB
   - Fe 3d 磁矩预期 ~2.2 μB
   - U 参数：Nd 4f U=5.0 eV

3. **DFT+U 参数敏感性扫描**
   - 对 GdN 扫描 U = 2, 3, 4, 5, 6, 7, 8 eV
   - 记录：晶格常数、带隙、磁矩 vs U 曲线
   - 确定最优 U 值（与实验最佳匹配）

### 收敛策略

磁性 f 电子体系 SCF 收敛困难，推荐策略：

| 参数 | GdN | NdFeB | 说明 |
|------|-----|-------|------|
| `mixing_beta` | 0.3 | 0.1 | 大体系需更小混合参数 |
| `mixing_beta_mag` | 0.2 | 0.1 | 磁化密度单独控制 |
| `scf_nmax` | 200 | 500 | 允许更多迭代步 |
| `scf_thr` | 1e-7 | 1e-6 | 大体系可适当放宽 |
| `smearing_sigma` | 0.01 Ry | 0.02 Ry | 金属体系需要展宽 |

- 利用 FE-204 能量监控器跟踪 SCF 收敛过程
- 利用 FE-112 振荡检测器识别磁矩振荡

### 对比指标

| 性质 | GdN 预期 | NdFeB 预期 | 容差 |
|------|----------|------------|------|
| Gd/Nd 4f 磁矩 (μB) | ~7.0 | ~3.3 | <10% |
| 总磁矩 (μB/f.u.) | ~7.0 | ~37.5 | <10% |
| 晶格常数 (Å) | 4.974 | a=8.80, c=12.20 | <2% |
| 带隙 (eV) | ~0.9 (半金属) | 金属 | 定性一致 |

## TDD Test Plan

### Tests to Write FIRST

```python
import json

def test_magnetic_benchmark_results():
    """验证磁性体系基准结果文件存在且包含必要性质"""
    with open("projects/f-electron-scf/validation/magnetic_benchmark/results.json") as f:
        results = json.load(f)
    for system in ["GdN"]:  # GdN 为最低要求
        assert system in results, f"Missing system: {system}"
        assert "magnetic_moment_uB" in results[system], f"{system}: missing magnetic_moment_uB"

def test_gdn_magnetic_moment():
    """验证 GdN 中 Gd 磁矩在合理范围内"""
    with open("projects/f-electron-scf/validation/magnetic_benchmark/results.json") as f:
        results = json.load(f)
    gd_moment = results["GdN"]["magnetic_moment_uB"]["Gd"]
    assert 6.0 < gd_moment < 8.0, f"Gd moment {gd_moment} outside expected range [6.0, 8.0]"

def test_u_sensitivity_scan():
    """验证 DFT+U 参数敏感性扫描已完成"""
    with open("projects/f-electron-scf/validation/magnetic_benchmark/results.json") as f:
        results = json.load(f)
    scan = results.get("GdN", {}).get("u_scan", {})
    assert len(scan) >= 4, f"U scan has only {len(scan)} points (need >=4)"

def test_scf_convergence_for_magnetic():
    """验证磁性体系 SCF 收敛成功"""
    with open("projects/f-electron-scf/validation/magnetic_benchmark/results.json") as f:
        results = json.load(f)
    for system in results:
        if system.startswith("_"):
            continue
        converged = results[system].get("scf_converged", False)
        assert converged, f"{system}: SCF did not converge"

def test_vasp_comparison_exists():
    """验证与 VASP 的对比数据存在"""
    with open("projects/f-electron-scf/validation/magnetic_benchmark/results.json") as f:
        results = json.load(f)
    for system in ["GdN"]:
        assert "vasp_reference" in results[system], f"{system}: missing VASP reference"
        vasp_moment = results[system]["vasp_reference"].get("magnetic_moment_uB", {}).get("Gd")
        assert vasp_moment is not None, f"{system}: missing VASP Gd moment"
```

## Acceptance Criteria

- [ ] 磁矩与 VASP/实验值偏差<10%
- [ ] SCF 收敛成功率>90%
