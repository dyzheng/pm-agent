# FE-104: DFT+U PW stress

## Objective

PW 基组下 DFT+U 应力的计算。适配 stress_onsite.cpp 到 Plus_U 接口。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/onsite_proj_tools.cpp`**
- `cal_stress_dftu(ik, npm, stress, orbital_corr, vu, size_vu, h_wg)`:914 — DFT+U 应力计算
  - 使用 `dbecp_s`（becp 对应变的导数）
  - 应力 = -2 Re[ Σ_ib wg * Σ_m,m' vu(m,m') * dbecp_s*(ib,m,ipol,jpol) * becp(ib,m') ]
  - 需要先调用 `cal_dbecp_s(ik, npm, ipol, jpol)` 计算 d⟨β|ψ⟩/dε_{ipol,jpol}

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/stress_onsite.cpp`** (124 lines)
- `stress_onsite()` — 调用入口
  - 双循环 ipol, jpol (0..2) → 调用 `cal_stress_dftu()`
  - 应力张量对称化: σ_{ij} = (σ_{ij} + σ_{ji}) / 2

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_proj_tools.cpp`** (1020 lines)
- `cal_stress_dftu()`:914 — 已有函数签名
- `cal_dbecp_s(ik, npm, ipol, jpol)` — becp 对应变的导数

**`/root/abacus-develop/source/source_pw/module_pwdft/stress_onsite.cpp`** (124 lines)
- `stress_onsite()` — 需确保正确调用并传递 Plus_U 数据

### Prior Art

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_force.cpp`** (579 lines)
- `cal_stress_k()`, `cal_stress_gamma()` — LCAO 版本应力计算

## Implementation Guide

### Architecture Decisions

- 应力通过 `Onsite_Proj_tools::cal_stress_dftu()` 计算
- 需要 6 个独立分量（对称张量）：xx, yy, zz, xy, xz, yz
- 实际计算 9 个分量（ipol×jpol），然后对称化

### Data Structure Mapping

| 量 | 变量 | 说明 |
|----|------|------|
| dbecp_s | `Onsite_Proj_tools::dbecp` | d⟨β\|ψ⟩/dε_{ipol,jpol} |
| 应力 | `stress[ipol*3+jpol]` | 3×3 张量，展平为 9 元素 |

### Critical Implementation Details

- **应力公式**: σ_U(ipol,jpol) = -1/Ω × 2 Re[ Σ_k Σ_ib wg * Σ_m,m' V_U * d⟨β_m|ψ⟩/dε * ⟨β_m'|ψ⟩ ]
- **体积因子**: 应力需除以晶胞体积 Ω
- **对称化**: 最终 σ_{ij} = (σ_{ij} + σ_{ji}) / 2
- **与力的关系**: 应力使用 `dbecp_s`（应变导数），力使用 `dbecp_f`（位移导数）

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(DftuPwStressTest, StressSymmetry) {
    // 应力张量应对称: σ_{ij} = σ_{ji}
    run_dftu_pw_scf("CeO2_nspin4");
    auto stress = cal_stress();
    for (int i = 0; i < 3; i++)
        for (int j = i+1; j < 3; j++)
            EXPECT_NEAR(stress[i][j], stress[j][i], 1e-10);
}

TEST_F(DftuPwStressTest, StressVsLCAO) {
    auto stress_pw = run_pw_stress("CeO2");
    auto stress_lcao = run_lcao_stress("CeO2");
    for (int i = 0; i < 3; i++)
        for (int j = 0; j < 3; j++)
            EXPECT_NEAR(stress_pw[i][j], stress_lcao[i][j], 1e-4);  // kbar 级别
}
```

## Acceptance Criteria

- [ ] CeO2 PW DFT+U 应力与 LCAO 一致
- [ ] 应力张量对称性正确
