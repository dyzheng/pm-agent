# FE-110: DeltaSpin force/stress（LCAO + PW）

## Objective

DeltaSpin 的力和应力计算，覆盖 LCAO 和 PW 两种基组。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/onsite_proj_tools.cpp`**
- `cal_force_dspin(ik, npm, force, lambda, h_wg)`:860 — PW DeltaSpin 力
  - F_dspin = -2 Re[ Σ_ib wg * λ·σ * d⟨β|ψ⟩/dτ * ⟨β|ψ⟩ ]
- `cal_stress_dspin(ik, npm, stress, lambda, h_wg)`:964 — PW DeltaSpin 应力

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/forces_onsite.cpp`** (81 lines)
- `cal_force_onsite()` — 同时调用 `cal_force_dftu()` 和 `cal_force_dspin()`

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/stress_onsite.cpp`** (124 lines)
- `stress_onsite()` — 同时调用 `cal_stress_dftu()` 和 `cal_stress_dspin()`

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_proj_tools.cpp`** (1020 lines)
- `cal_force_dspin()`:860 — 已有函数签名
- `cal_stress_dspin()`:964 — 已有函数签名

**`/root/abacus-develop/source/source_pw/module_pwdft/forces_onsite.cpp`** (81 lines)
**`/root/abacus-develop/source/source_pw/module_pwdft/stress_onsite.cpp`** (124 lines)

### Prior Art

**FE-103/FE-104** — DFT+U 力/应力的实现模式完全相同，只是使用 lambda 而非 vu。

## Implementation Guide

### Architecture Decisions

- DeltaSpin 力/应力与 DFT+U 共享 `forces_onsite.cpp` / `stress_onsite.cpp` 入口
- 两者使用相同的 becp/dbecp 基础设施，只是势不同（λ·σ vs V_U）
- LCAO 路径通过 `dspin_force_stress.hpp` 模板实现

### Data Structure Mapping

| 量 | DFT+U | DeltaSpin | 说明 |
|----|-------|-----------|------|
| 势 | `vu` (complex 矩阵) | `lambda` (Vector3<double>) | DeltaSpin 用 3 分量向量 |
| 力函数 | `cal_force_dftu()` | `cal_force_dspin()` | 同一文件 |
| 应力函数 | `cal_stress_dftu()` | `cal_stress_dspin()` | 同一文件 |

### Critical Implementation Details

- **lambda 参数**: `Vector3<double>* lambda` 是 per-atom 的 3 分量拉格朗日乘子
- **σ 矩阵**: Pauli 矩阵 σ_x, σ_y, σ_z 用于将 λ 向量转换为 2×2 自旋矩阵
- **LCAO 力**: 通过 `dspin_force_stress.hpp` 模板函数，使用 overlap 矩阵导数
- **PW 力**: 通过 `Onsite_Proj_tools::cal_force_dspin()`，使用 becp 导数

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(DeltaSpinForceTest, PwForceSymmetry) {
    run_deltaspin_pw("NiO_nspin4");
    auto force = cal_force_dspin();
    double total[3] = {0, 0, 0};
    for (int iat = 0; iat < nat; iat++)
        for (int i = 0; i < 3; i++) total[i] += force[iat][i];
    for (int i = 0; i < 3; i++)
        EXPECT_NEAR(total[i], 0.0, 1e-8);
}

TEST_F(DeltaSpinForceTest, PwVsLcaoForce) {
    auto force_pw = run_pw_dspin_force("NiO");
    auto force_lcao = run_lcao_dspin_force("NiO");
    for (int i = 0; i < 3*nat; i++)
        EXPECT_NEAR(force_pw[i], force_lcao[i], 1e-3);
}
```

## Acceptance Criteria

- [ ] DeltaSpin 力/应力与数值微分一致
- [ ] PW 力与 LCAO 一致（< 1 mRy/Bohr）
- [ ] 力的总和为零
- [ ] 应力张量对称
