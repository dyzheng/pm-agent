# FE-302: 简单氧化物验证（CeO2, Gd2O3, La2O3）

## Objective

基准验证：ABACUS vs VASP PAW 对比 CeO2/Gd2O3/La2O3 的晶格常数、体模量、带隙、磁矩（如适用）。PBE 和 PBE+U 两种泛函。记录 SCF 收敛步数和计算时间。

## Reference Code

### SCF 求解器

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 行) — PW 基组 KS 求解器
- `cal_energy()`:388 — 总能量计算
- `cal_force()`:394 — 原子力计算
- `cal_stress()`:408 — 应力张量计算（EOS 拟合需要）
- `before_scf()` / `after_scf()` — SCF 生命周期钩子

**`/root/abacus-develop/source/source_esolver/esolver_ks_lcao.cpp`** (572 行) — LCAO 基组 KS 求解器
- 与 PW 求解器相同的接口，用于 LCAO 基组验证
- LCAO 基组下 DFT+U 功能更完整

### DFT+U 模块

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 行) — DFT+U 核心接口
- `cal_energy_correction()`: Hubbard U 能量修正
- `cal_force_correction()`: Hubbard U 力修正
- U 参数设置：Ce 4f U=4.5 eV, Gd 4f U=6.0 eV

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_io.cpp`** (538 行) — DFT+U 输入输出
- 占据矩阵输出：用于分析 f 电子占据
- `write_occupation()`: 输出占据矩阵到文件

### EOS 拟合工具

**`/root/abacus-test/abacustest/lib_model/model_004_Eos.py`** (404 行) — 状态方程拟合
- Birch-Murnaghan EOS 拟合，提取平衡体积和体模量
- 输入：体积-能量数据点
- 输出：V0, E0, B0, B0'

## Implementation Guide

### 计算矩阵

3 个体系 x 2 种泛函 x 2 个代码 = 12 组计算：

| 体系 | 泛函 | 代码 | 关键参数 |
|------|------|------|----------|
| CeO2 (Fm-3m) | PBE | ABACUS | ecutwfc=80 Ry, kpoints=6x6x6 |
| CeO2 (Fm-3m) | PBE+U (Ce 4f, U=4.5 eV) | ABACUS | 同上 + dft_plus_u=1 |
| CeO2 (Fm-3m) | PBE | VASP | ENCUT=600 eV, KPOINTS=6x6x6 |
| CeO2 (Fm-3m) | PBE+U (Ce 4f, U=4.5 eV) | VASP | 同上 + LDAU=.TRUE. |
| Gd2O3 (Ia-3) | PBE | ABACUS | nspin=2, ecutwfc=80 Ry |
| Gd2O3 (Ia-3) | PBE+U (Gd 4f, U=6.0 eV) | ABACUS | 同上 + dft_plus_u=1 |
| Gd2O3 (Ia-3) | PBE / PBE+U | VASP | 对应参数 |
| La2O3 (P-3m1) | PBE | ABACUS | La 无 4f 价电子，作为无 U 基线 |
| La2O3 (P-3m1) | PBE | VASP | 对应参数 |

### EOS 拟合流程

1. 对每个体系，在平衡体积附近取 7 个体积点（±3%，步长 1%）
2. 每个体积点做固定体积弛豫（relax atomic positions only）
3. 收集 V-E 数据，用 Birch-Murnaghan 方程拟合
4. 提取：平衡晶格常数 a0、体模量 B0

### 对比表格式

```
| 性质 | 体系 | ABACUS | VASP | 偏差(%) | 实验值 | Pass/Fail |
|------|------|--------|------|---------|--------|-----------|
| a (Å) | CeO2 PBE | 5.48 | 5.47 | 0.2 | 5.411 | PASS |
| B (GPa) | CeO2 PBE | 185 | 190 | 2.6 | 220 | PASS |
```

Pass 标准：ABACUS vs VASP 偏差 < 2%（结构）、< 10%（体模量）、带隙定性一致。

### 关键注意事项

- CeO2 PBE 会给出金属性结果（带隙=0），PBE+U 才能打开带隙，这是预期行为
- Gd2O3 需要 nspin=2，初始磁矩设置影响收敛
- La2O3 的 La 没有 4f 价电子，PBE+U 中 U=0，作为无 f 电子基线
- VASP 使用 PAW，ABACUS 使用 NCPP，赝势差异是主要误差来源

## TDD Test Plan

### Tests to Write FIRST

```python
import json
import os

def test_oxide_benchmark_results():
    """验证三个氧化物体系的基准结果文件存在且包含必要性质"""
    with open("projects/f-electron-scf/validation/oxide_benchmark/results.json") as f:
        results = json.load(f)
    for system in ["CeO2", "Gd2O3", "La2O3"]:
        assert system in results, f"Missing system: {system}"
        for prop in ["lattice_constant_A", "bulk_modulus_GPa", "band_gap_eV"]:
            assert prop in results[system], f"{system}: missing {prop}"

def test_oxide_deviation_acceptable():
    """验证 ABACUS vs VASP 偏差在可接受范围内"""
    with open("projects/f-electron-scf/validation/oxide_benchmark/results.json") as f:
        results = json.load(f)
    for system in results:
        for prop, data in results[system].items():
            if "deviation_pct" in data:
                assert data["deviation_pct"] < 10.0, \
                    f"{system}/{prop}: {data['deviation_pct']}% deviation exceeds 10%"

def test_eos_data_complete():
    """验证 EOS 拟合数据完整（每个体系至少7个体积点）"""
    with open("projects/f-electron-scf/validation/oxide_benchmark/results.json") as f:
        results = json.load(f)
    for system in results:
        if "eos_points" in results[system]:
            assert len(results[system]["eos_points"]) >= 7, \
                f"{system}: only {len(results[system]['eos_points'])} EOS points (need >=7)"

def test_both_functionals_computed():
    """验证 PBE 和 PBE+U 两种泛函均已计算"""
    with open("projects/f-electron-scf/validation/oxide_benchmark/results.json") as f:
        results = json.load(f)
    for system in ["CeO2", "Gd2O3"]:
        assert "PBE" in results[system].get("functionals", {}), f"{system}: missing PBE"
        assert "PBE+U" in results[system].get("functionals", {}), f"{system}: missing PBE+U"

def test_scf_convergence_recorded():
    """验证 SCF 收敛步数和计算时间已记录"""
    with open("projects/f-electron-scf/validation/oxide_benchmark/results.json") as f:
        results = json.load(f)
    for system in results:
        assert "scf_steps" in results[system], f"{system}: missing scf_steps"
        assert "wall_time_s" in results[system], f"{system}: missing wall_time_s"
```

## Acceptance Criteria

- [ ] 晶格常数误差<1%
- [ ] 体模量误差<10%
- [ ] 带隙定性一致
- [ ] SCF 收敛步数和计算时间记录
