# FE-109: DeltaSpin PW 支持

## Objective

在 PW 基组下支持 DeltaSpin。在 esolver_ks_pw.cpp 集成 lambda loop，添加 cal_Mi_pw 等 PW 相关方法。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_esolver/esolver_ks_pw.cpp`**
- `hamilt2rho_single()`:223-240 — 调用 `sc.run_lambda_loop()` 进行 DeltaSpin 优化
  - 在 Hamiltonian diagonalization 后、电荷密度更新前调用
  - lambda loop 内部迭代: 调整 λ → 重新求解 → 检查磁矩收敛

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/cal_mw.cpp`**
- `cal_mi_pw()` — PW 基组下的局域磁矩计算
  - 使用 onsite projector 的 becp 计算 Tr[ρ_i · σ]

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/lambda_loop.cpp`** (282 lines)
- `run_lambda_loop(outer_step, rerun)` — λ 优化主循环
  - 迭代: cal_mw_from_lambda() → 检查 |M_i - M_target| → 更新 λ
  - 收敛条件: RMS error < sc_thr_

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/op_pw_proj.cpp`**
- `OnsiteProj::act()`:416-431 — `cal_ps_delta_spin()` 将 λ·σ 约束势应用到波函数

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `hamilt2rho_single()` — 需添加 DeltaSpin lambda loop 调用
- `before_scf()` — 需添加 DeltaSpin 初始化（`init_sc()`）

**`/root/abacus-develop/source/source_lcao/module_deltaspin/cal_mw.cpp`** (172 lines)
- 已有 `cal_mi_lcao()`，需添加 `cal_mi_pw()`

**`/root/abacus-develop/source/source_pw/module_pwdft/op_pw_proj.cpp`**
- `OnsiteProj::act()` — 已有 `cal_ps_delta_spin()` 框架

### Prior Art

**FE-100** — onsite_projector nspin=1/2 支持，提供了 PW 下 becp 计算的基础。

## Implementation Guide

### Architecture Decisions

- DeltaSpin PW 通过 `OnsiteProj` 算符将 λ·σ 势应用到波函数
- lambda loop 在 `hamilt2rho_single()` 中调用，位于 diag 和 charge update 之间
- `cal_mi_pw()` 使用 onsite projector 的 becp 计算局域磁矩

### Data Flow

```
ESolver_KS_PW::hamilt2rho_single()
  → HSolver::solve() (diag, OnsiteProj applies λ·σ to ψ)
  → SpinConstrain::run_lambda_loop()
    → cal_mw_from_lambda()
      → update_psi_charge() (re-solve KS with updated λ)
      → cal_mi_pw() (compute M_i from new ψ)
    → check convergence |M_i - M_target|
    → update λ (gradient descent)
  → update charge density
```

### Critical Implementation Details

- **lambda_coeff 数组**: 存储每个投影子的 λ·σ 系数，供 GPU kernel 使用
- **init_sc() 调用**: 需要在 `before_scf()` 中初始化 SpinConstrain，传入 PW 相关指针
- **nspin=4 要求**: DeltaSpin 需要 nspin=4（非共线磁性），nspin=1/2 不支持
- **与 DFT+U 的交互**: 如果同时启用，OnsiteProj::act() 中两者都会被调用

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(DeltaSpinPwTest, CalMiPw) {
    setup_nio_nspin4_pw();
    auto& sc = SpinConstrain<complex<double>>::getScInstance();
    sc.cal_mi_pw();
    auto mi = sc.get_Mi(iat_Ni);
    double mag = std::sqrt(mi.x*mi.x + mi.y*mi.y + mi.z*mi.z);
    EXPECT_GT(mag, 0.5);   // Ni 应有显著磁矩
    EXPECT_LT(mag, 3.0);   // 但不超过 3 μB
}

TEST_F(DeltaSpinPwTest, LambdaLoopConverges) {
    setup_nio_nspin4_pw();
    auto& sc = SpinConstrain<complex<double>>::getScInstance();
    sc.set_target_mag(iat_Ni, {0, 0, 1.8});
    sc.run_lambda_loop(1);
    EXPECT_LT(sc.get_rms_error(), sc.get_sc_thr());
}
```

## Acceptance Criteria

- [ ] PW DeltaSpin SCF 可运行
- [ ] 磁矩约束有效
- [ ] lambda loop 在 50 步内收敛
- [ ] PW 磁矩与 LCAO 定性一致
