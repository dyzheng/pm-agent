# FE-306: CeO2 全电子参考计算 (FHI-aims/Elk)

## Objective

用 FHI-aims 或 Elk 对 CeO2 做全电子 DFT+U 参考计算。提供赝势近似误差的绝对参考。消除'ABACUS ≠ VASP 时无法区分算法问题还是赝势问题'的歧义。对比项：晶格常数、体模量、带隙、Ce 4f 占据数、磁矩。

## Reference Code

### 被验证的赝势近似

**`/root/abacus-develop/source/source_cell/pseudo.h`** (91 行) — 赝势数据结构
- `Pseudopot_upf` 类：存储赝势信息（截断半径、局域/非局域分量）
- 全电子计算的目的是量化此赝势近似引入的误差

**`/root/abacus-develop/source/source_cell/read_pp.h`** (130 行) — 赝势读取
- `read_pp_upf()`: UPF 格式赝势读取
- Ce 的 NCPP 赝势对 4f 电子的描述是误差的主要来源

### 被验证的 DFT+U 实现

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 行) — DFT+U 核心接口
- 全电子 DFT+U 结果作为"真值"，用于分离赝势误差和算法误差
- 对比项：Hubbard U 能量修正、占据矩阵

### 全电子方法参考

FHI-aims 全电子 DFT+U：
- NAO（数值原子轨道）基组，无赝势近似
- tier-2 基组提供接近完备基组极限的精度
- 标量相对论（atomic ZORA）处理重元素

Elk 全势 LAPW+lo DFT+U：
- LAPW+lo（线性缀加平面波+局域轨道）基组
- 全势方法，无形状近似
- 可选全相对论（含 SOC）处理

## Implementation Guide

### CeO2 计算设置

CeO2 萤石结构参数：
- 空间群：Fm-3m (No. 225)
- 实验晶格常数：a = 5.411 Å
- Ce 位置：(0, 0, 0)，O 位置：(0.25, 0.25, 0.25)
- 3 原子/原胞（1 Ce + 2 O）

### FHI-aims 计算方案

```
# control.in 关键参数
xc                 pbe
spin               collinear
relativistic       atomic_zora scalar
plus_u             Ce 2 4.5   # l=2 (f 轨道在 FHI-aims 中), U=4.5 eV

# 基组
species_defaults   tight/tier-2

# k 点
k_grid             8 8 8

# 收敛
sc_accuracy_rho    1e-6
sc_accuracy_eev    1e-4
sc_accuracy_etot   1e-6
```

EOS 拟合：7 个体积点（a = 5.25, 5.30, 5.35, 5.40, 5.45, 5.50, 5.55 Å）

### Elk 计算方案（备选）

```
! elk.in 关键参数
tasks
  0        ! ground state

xctype
  20       ! PBE

spinpol
  .true.

! DFT+U: Ce 4f, U=4.5 eV, J=0 eV
dft+u
  1 3 4.5 0.0   ! species 1, l=3 (f), U, J

! k 点
ngridk
  8 8 8

! 相对论
! 默认标量相对论，可开启 SOC
```

### 三方对比流程

1. 运行 FHI-aims（或 Elk）全电子 DFT+U 计算
2. 从 FE-302 获取 ABACUS 和 VASP 结果
3. 构建三方对比表：

| 性质 | 全电子 | ABACUS (NCPP) | VASP (PAW) | ABACUS 误差 | VASP 误差 |
|------|--------|---------------|------------|-------------|-----------|
| a (Å) | 参考值 | — | — | — | — |
| B (GPa) | 参考值 | — | — | — | — |
| Eg (eV) | 参考值 | — | — | — | — |
| Ce 4f 占据 | 参考值 | — | — | — | — |

4. 误差分析：
   - 如果 VASP 误差 << ABACUS 误差：NCPP 赝势质量不足，需改进
   - 如果 VASP 误差 ≈ ABACUS 误差：赝势近似的固有限制
   - 如果两者误差都很小（<1%）：赝势方法可靠

### 关键注意事项

- FHI-aims 的 DFT+U 实现中，f 轨道的角量子数标记可能与 ABACUS/VASP 不同，需确认
- Elk 使用 AMF (around mean field) 双计数校正作为默认，需切换到 FLL (fully localized limit) 以与 ABACUS/VASP 一致
- 全电子计算的 Ce 4f 占据数是最可靠的参考，赝势方法的占据数可能因投影方式不同而有系统偏差
- 体模量对 EOS 拟合范围敏感，三个代码需使用相同的体积范围

## TDD Test Plan

### Tests to Write FIRST

```python
import json

def test_all_electron_reference():
    """验证全电子参考数据完整"""
    with open("projects/f-electron-scf/validation/all_electron_reference/reference.json") as f:
        ref = json.load(f)
    assert "CeO2" in ref, "Missing CeO2 data"
    for prop in ["lattice_constant_A", "bulk_modulus_GPa", "band_gap_eV", "Ce_4f_occupation"]:
        assert prop in ref["CeO2"], f"Missing {prop}"

def test_pp_error_quantified():
    """验证赝势误差已量化"""
    with open("projects/f-electron-scf/validation/all_electron_reference/pp_error.json") as f:
        err = json.load(f)
    for code in ["ABACUS", "VASP"]:
        assert code in err, f"Missing {code} error data"
        for prop in ["lattice_constant_A", "band_gap_eV"]:
            assert prop in err[code], f"{code}: missing {prop} error"

def test_all_electron_eos():
    """验证全电子 EOS 拟合数据完整"""
    with open("projects/f-electron-scf/validation/all_electron_reference/reference.json") as f:
        ref = json.load(f)
    eos = ref["CeO2"].get("eos_points", [])
    assert len(eos) >= 7, f"Only {len(eos)} EOS points (need >=7)"

def test_pp_error_reasonable():
    """验证赝势误差在合理范围内（非异常值）"""
    with open("projects/f-electron-scf/validation/all_electron_reference/pp_error.json") as f:
        err = json.load(f)
    for code in ["ABACUS", "VASP"]:
        lat_err = abs(err[code]["lattice_constant_A"]["deviation_pct"])
        assert lat_err < 5.0, f"{code}: lattice constant PP error {lat_err}% > 5%"

def test_three_way_comparison_exists():
    """验证三方对比报告已生成"""
    import os
    assert os.path.exists(
        "projects/f-electron-scf/validation/all_electron_reference/three_way_comparison.md"
    )
```

## Acceptance Criteria

- [ ] CeO2 全电子 DFT+U 计算完成
- [ ] 与 ABACUS 和 VASP 结果三方对比
- [ ] 赝势近似误差量化
