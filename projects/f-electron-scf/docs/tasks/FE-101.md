# FE-101: DFT+U PW SCF（nspin=4）

## Objective

在 PW 基组下支持 DFT+U SCF 计算（先 nspin=4）。核心工作：(1) 移植 zdy-tmp dftu_pw.cpp 的 PW 占据矩阵计算到 develop 的 Plus_U 类，(2) 添加 eff_pot_pw/cal_VU_pot_pw 等 PW 相关方法，(3) 在 esolver_ks_pw.cpp 集成 DFT+U 调用。适配要点：DFTU→Plus_U 类名、GlobalC::ucell→参数传递、GlobalV::NSPIN→PARAM.inp.nspin。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_lcao/module_dftu/dftu_pw.cpp`** (219 lines)
- `cal_occ_pw(iter, psi_in, wg_in, cell, mixing_beta)` — PW 占据矩阵计算
  - 循环 k-points → 调用 `onsite_p->overlap_proj_psi()` 计算 becp
  - 从 becp 构建 locale 矩阵（4×4 分量 for nspin=4）
  - 调用 `mix_locale()` 进行 Broyden mixing（如果 mixing_dftu=true）
  - 调用 `cal_energy_correction()` 计算 DFT+U 能量修正
- `cal_VU_pot_pw(spin)` — 计算 DFT+U 有效势 V_U
  - 从 locale 和 U 参数构建 vu_iat 矩阵
  - 存入 `eff_pot_pw` 数组供 Hamiltonian 算符使用

**`/root/abacus-zdy-tmp/source/source_esolver/esolver_ks_pw.cpp`**
- `iter_init()`:~190 — 调用 `Plus_U::get_instance().cal_occ_pw()`
- `before_scf()` — DFT+U 初始化（U-ramping 等）
- `after_scf()` — DFT+U 输出

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/op_pw_proj.cpp`**
- `OnsiteProj::act()`:416-431 — 将 V_U 应用到波函数
  - 调用 `cal_ps_dftu()` 计算 V_U|ψ⟩
  - 通过 GEMM 累加到 hpsi

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 lines)
- `Plus_U` 类（原 DFTU）— 静态成员设计
- 已有 `eff_pot_pw`, `eff_pot_pw_index` 成员（但 PW 方法未实现）
- 已有 `cal_occ_pw()` 声明但实现为空或仅 LCAO

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_pw.cpp`** (219 lines)
- 已有框架代码，需要填充 PW 占据矩阵计算逻辑

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `ModuleESolver::ESolver_KS_PW<T, Device>` — 模板类
- `iter_init()`:190 — 需添加 DFT+U cal_occ_pw 调用
- `before_scf()` — 需添加 DFT+U 初始化
- `after_scf()` — 需添加 DFT+U 输出

**`/root/abacus-develop/source/source_pw/module_pwdft/op_pw_proj.cpp`**
- `OnsiteProj::act()` — 需确保 DFT+U 势正确应用

### Prior Art

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 lines)
- LCAO 版本的占据矩阵计算（`cal_occup_m_k()`, `cal_occup_m_gamma()`）
- 可参考 locale 矩阵的构建逻辑

## Implementation Guide

### Architecture Decisions

- **Plus_U 静态成员**: develop 使用 `Plus_U::get_instance()` 单例模式（已移除 zdy-tmp 的全局变量）
- **cal_occ_pw 签名变化**: zdy-tmp 用 `Charge_Mixing*` 参数，develop 改为 `double mixing_beta`
- **ESolver 集成**: 在 `iter_init()` 中调用 `cal_occ_pw()`，在 Hamiltonian 构建时通过 `OnsiteProj` 算符应用 V_U

### Data Structure Mapping

| zdy-tmp | develop | 说明 |
|---------|---------|------|
| `ModuleDFTU::DFTU` | `Plus_U` | 类名变更，单例模式 |
| `GlobalC::ucell` | `UnitCell& cell` 参数 | 去全局化 |
| `GlobalV::NSPIN` | `PARAM.inp.nspin` | 参数化 |
| `cal_occ_pw(..., Charge_Mixing*)` | `cal_occ_pw(..., double mixing_beta)` | 简化接口 |
| `locale[iat][l][n][spin]` | 同 | 4D 占据矩阵，不变 |
| `eff_pot_pw[index]` | 同 | V_U 势数组，不变 |
| `FS_Nonlocal_tools` | `Onsite_Proj_tools` | 投影工具类名 |

### Critical Implementation Details

- **becp → locale 映射**: nspin=4 时 becp 有 2*nkb 分量（npol=2），需正确映射到 locale 的 4 个自旋分量
- **能量权重**: `wg(ik, ib)` 已包含 k-point 权重和占据数，直接用于累加
- **MPI 归约**: locale 矩阵需要跨 k-point pool 归约（`Parallel_Reduce::reduce_pool()`）
- **eff_pot_pw 索引**: `eff_pot_pw_index[iat]` 记录每个原子在 eff_pot_pw 数组中的起始位置
- **U-ramping**: 如果启用 uramping，U 值在 SCF 过程中逐步增大，需在 `before_scf()` 中调用 `uramping_update()`

## TDD Test Plan

### Tests to Write FIRST

```cpp
// test_dftu_pw_scf.cpp
TEST_F(DftuPwTest, CalOccPwNspin4) {
    // 验证 PW 占据矩阵计算
    // 输入: CeO2 nspin=4 的波函数和 k-point 权重
    Plus_U::get_instance().cal_occ_pw(1, psi, wg, cell, 0.7);
    // locale 矩阵应非零
    auto& locale = Plus_U::get_instance().locale;
    double trace = 0.0;
    for (int m = 0; m < 2*l+1; m++) trace += locale[iat][l][n][m*dim+m].real();
    EXPECT_GT(trace, 0.0);  // f 电子占据数 > 0
    EXPECT_LT(trace, 14.0); // f 电子占据数 < 14
}

TEST_F(DftuPwTest, CalVUPotPw) {
    // 验证 V_U 势的计算
    Plus_U::get_instance().cal_VU_pot_pw(0);
    // eff_pot_pw 应非零
    bool has_nonzero = false;
    for (int i = 0; i < eff_pot_size; i++) {
        if (std::abs(Plus_U::get_instance().eff_pot_pw[i]) > 1e-10)
            has_nonzero = true;
    }
    EXPECT_TRUE(has_nonzero);
}

TEST_F(DftuPwTest, EnergyCorrection) {
    // DFT+U 能量修正应为负值（稳定化）
    Plus_U::get_instance().cal_occ_pw(1, psi, wg, cell, 0.7);
    Plus_U::get_instance().cal_energy_correction(cell, 0);
    EXPECT_LT(Plus_U::energy_u, 0.0);
}
```

## Acceptance Criteria

- [ ] CeO2 nspin=4 PW DFT+U SCF 可收敛
- [ ] 能量与 LCAO DFT+U 定性一致
- [ ] 编译通过，现有测试不受影响
- [ ] nspin=1/2/4 的能量权重和对角系数单元测试
- [ ] set_locale() 的 uom_array→locale 拷贝单元测试
