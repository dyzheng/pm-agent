# FE-112: SCF 震荡检测 + 自动回退

## Objective

检测 SCF 能量震荡并自动调整策略。震荡体系自动调整 mixing 参数，不影响正常收敛体系。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_estate/module_charge/chgmixing.cpp`** (120-172)
- `chgmixing_ks_pw()` — 电荷 mixing 协调点
  - mixing_restart 逻辑: 当 U-ramping 更新或 DeltaSpin 收敛时触发 mixing restart
  - 震荡检测可在此处集成

**`/root/abacus-zdy-tmp/source/source_esolver/esolver_ks_pw.cpp`**
- `iter_finish()` — SCF 迭代结束时检查收敛/震荡
- 能量历史记录用于震荡检测

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_estate/module_charge/chgmixing.cpp`**
- `chgmixing_ks_pw()` — 需添加震荡检测逻辑

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.cpp`** (259 lines)
- `Charge_Mixing::set_mixing()` — mixing 参数设置
- `Charge_Mixing::mix_reset()` — mixing 重置

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `iter_finish()` — 需添加震荡检测和自动回退

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing_rho.cpp`** (613 lines)
- `mix_rho()` — 实际执行 mixing 的地方

### Prior Art

**VASP 的 AMIX 自适应**: VASP 在检测到震荡时自动减小 AMIX。
**QE 的 adaptive mixing**: QE 在 `mix_pot.f90` 中有类似的自适应逻辑。

## Implementation Guide

### Architecture Decisions

- 震荡检测作为独立模块，不侵入现有 mixing 代码
- 检测算法: 滑动窗口检测能量变化符号交替
- 回退策略: 减小 mixing_beta → 重置 Broyden 历史 → 回退到上一个低能量状态
- 不影响正常收敛: 只在检测到震荡模式时触发

### 震荡检测算法

```
energy_history = [E_1, E_2, ..., E_n]
delta = [E_2-E_1, E_3-E_2, ..., E_n-E_{n-1}]
signs = [sign(d) for d in delta]

# 震荡: 连续 N 次符号交替 (+,-,+,- 或 -,+,-,+)
oscillating = all(signs[i] != signs[i+1] for i in range(len(signs)-1))
             and len(signs) >= 3

# 发散: 连续 N 次能量上升
diverging = all(d > 0 for d in delta[-3:])
```

### 回退策略

| 触发条件 | 动作 | 参数变化 |
|----------|------|----------|
| 轻度震荡（3步交替） | 减小 mixing_beta | β → β × 0.5 |
| 重度震荡（5步交替） | 重置 Broyden + 减小 β | β → β × 0.3, 清空历史 |
| 能量发散（3步上升） | 回退 + 重置 | 恢复上一低能量状态，β → β × 0.2 |
| 震荡 + DFT+U | 自动开启 mixing_dftu | mixing_dftu = true |

### Critical Implementation Details

- **能量历史存储**: 在 `ESolver_KS_PW` 中添加 `vector<double> energy_history`
- **最小 mixing_beta**: 设置下限（如 0.01），防止 β 过小导致收敛极慢
- **回退状态**: 需要保存上一步的电荷密度和波函数（内存开销）
- **与 mixing_restart 的交互**: 震荡回退触发 mixing_restart
- **日志输出**: 震荡检测和回退动作需要清晰的日志信息

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(OscillationTest, DetectOscillation) {
    // 能量序列: 交替上下
    vector<double> energies = {-100.0, -99.5, -100.1, -99.4, -100.2};
    OscillationDetector detector;
    for (auto e : energies) detector.add(e);
    EXPECT_TRUE(detector.is_oscillating());
    EXPECT_FALSE(detector.is_diverging());
}

TEST_F(OscillationTest, DetectDivergence) {
    vector<double> energies = {-100.0, -99.5, -99.0, -98.5};
    OscillationDetector detector;
    for (auto e : energies) detector.add(e);
    EXPECT_FALSE(detector.is_oscillating());
    EXPECT_TRUE(detector.is_diverging());
}

TEST_F(OscillationTest, NormalConvergenceUnaffected) {
    // 正常收敛: 单调下降
    vector<double> energies = {-100.0, -100.5, -100.8, -100.9, -100.95};
    OscillationDetector detector;
    for (auto e : energies) detector.add(e);
    EXPECT_FALSE(detector.is_oscillating());
    EXPECT_FALSE(detector.is_diverging());
}

TEST_F(OscillationTest, AutoReduceMixingBeta) {
    simulate_oscillating_scf(5);
    EXPECT_LT(get_mixing_beta(), initial_mixing_beta);
}
```

## Acceptance Criteria

- [ ] 震荡体系自动检测并调整 mixing 参数
- [ ] 不影响正常收敛体系
- [ ] 能量发散时自动回退
- [ ] 日志清晰记录检测和回退动作
