# FE-005: 赝势质量前置验证

## Objective

用现有赝势（SG15/PseudoDojo）对 CeO2、Gd2O3 分别跑 ABACUS 和 VASP 对比。量化偏差：晶格常数、体模量、带隙、磁矩。Go/No-Go 门控：偏差 >5% 则标记赝势不可用，通知项目 f-electron-multiscale 启动赝势生成任务。此任务在 Phase 0 执行，目的是提前暴露赝势质量风险，避免在 Phase 3 才发现问题。

## Reference Code

### 赝势读取代码

**`/root/abacus-develop/source/source_cell/read_pp.h`** (130 lines)
- `Pseudopot_upf` 类 — 赝势读取主类
- `init_pseudo_reader()` — 初始化赝势读取器，自动检测 UPF 版本
- `read_pseudo_upf()` — UPF v1.0 格式读取
- `read_pseudo_upf201()` — UPF v2.0.1 格式读取

**`/root/abacus-develop/source/source_cell/read_pp.cpp`** (497 lines)
- 赝势读取主逻辑，解析 header、mesh、nlcc、local、nonlocal 等段
- 验证赝势时需确认 ABACUS 能正确读取所有 f 电子相关投影子

**`/root/abacus-develop/source/source_cell/read_pp_upf100.cpp`** (530 lines)
- UPF v1.0 格式解析器（部分 PSlibrary 赝势）

**`/root/abacus-develop/source/source_cell/read_pp_upf201.cpp`** (927 lines)
- UPF v2.0.1 格式解析器（PseudoDojo、SG15 赝势）

**`/root/abacus-develop/source/source_cell/pseudo.h`** (91 lines)
- `pseudo` 基类：`lmax`, `zv`, `nchi`, `nbeta`
- 验证时需检查 `lmax >= 3`（f 电子）且 beta 投影子完整

**`/root/abacus-develop/source/source_cell/atom_pseudo.h`** (53 lines)
- `Atom_pseudo` 类，SOC 支持：`has_so`, `jchi[]`, `jjj[]`

### 计算引擎

**`/root/abacus-develop/source/source_cell/unitcell.h`** (265 lines)
- `UnitCell` 类 — 晶胞定义
- `nat` — 总原子数，`ntype` — 原子类型数
- `lat0` — 晶格常数（Bohr），`latvec` — 晶格矢量
- EOS 拟合需要对 `lat0` 做系列缩放

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `ESolver_KS_PW` — PW 基组 SCF 求解器
- 赝势验证使用 PW 基组（与 VASP 对比更直接）

### 测试框架

**`/root/abacus-test/abacustest/lib_model/model_004_Eos.py`**
- abacustest 状态方程模型
- 自动执行体积缩放 → SCF 计算 → Birch-Murnaghan 拟合
- 输出：平衡晶格常数 a₀、体模量 B₀、B₀'

## Implementation Guide

### Architecture Decisions

- **测试矩阵**: {CeO2, Gd2O3} × {SG15, PseudoDojo} × {ABACUS, VASP}，共 8 组计算
- **PW 基组优先**: 赝势验证使用 PW 基组，与 VASP（纯 PW）对比更公平
- **EOS 拟合**: 使用 Birch-Murnaghan 状态方程拟合体模量，7 个体积点（±3%）
- **Go/No-Go 门控**: 任一关键物理量偏差 >5% 即标记该赝势为不可用

### 测试体系参数

**CeO2（萤石结构，Fm-3m）**

| 参数 | ABACUS | VASP |
|------|--------|------|
| 结构 | a=5.411 Å, Ce(0,0,0), O(0.25,0.25,0.25) | 同左 |
| k 点 | 6×6×6 MP | 同左 |
| 截断能 | 80 Ry (1088 eV) | 550 eV |
| 泛函 | PBE | PBE |
| 赝势 | SG15/PseudoDojo UPF | PAW_PBE |
| nspin | 1 | 1 |

**Gd2O3（立方 bixbyite，Ia-3）**

| 参数 | ABACUS | VASP |
|------|--------|------|
| 结构 | a=10.813 Å, 80 atoms/cell | 同左 |
| k 点 | 2×2×2 MP | 同左 |
| 截断能 | 80 Ry (1088 eV) | 550 eV |
| 泛函 | PBE+U (U=6.0 eV on Gd-4f) | PBE+U (同) |
| nspin | 2 | 2 |

### EOS 拟合流程

```
对每个 (体系, 赝势, 代码) 组合:
  1. 生成 7 个体积点: V/V0 = 0.97, 0.98, 0.99, 1.00, 1.01, 1.02, 1.03
  2. 对每个体积点运行 SCF 计算
  3. 收集 E(V) 数据
  4. Birch-Murnaghan 拟合:
     E(V) = E0 + (9/16)·B0·V0·[(V0/V)^(2/3)-1]^3·B0'
                + (9/16)·B0·V0·[(V0/V)^(2/3)-1]^2·[6-4·(V0/V)^(2/3)]
  5. 提取: a0 (平衡晶格常数), B0 (体模量), B0' (体模量压力导数)
```

### 对比物理量与阈值

| 物理量 | 单位 | Go/No-Go 阈值 | 说明 |
|--------|------|---------------|------|
| 晶格常数 a₀ | Å | 偏差 < 1% | 最基本的结构参数 |
| 体模量 B₀ | GPa | 偏差 < 5% | 对赝势质量敏感 |
| 带隙 E_gap | eV | 偏差 < 0.3 eV | 绝对偏差（非百分比） |
| 磁矩 M | μB | 偏差 < 0.1 μB | 仅 Gd2O3 |

### Go/No-Go 判定逻辑

```python
def go_nogo(comparison: dict) -> str:
    """
    判定赝势是否可用。
    返回: "GO", "CONDITIONAL", "NO-GO"
    """
    failures = []
    if comparison["lattice_constant"]["deviation_pct"] > 1.0:
        failures.append("lattice_constant")
    if comparison["bulk_modulus"]["deviation_pct"] > 5.0:
        failures.append("bulk_modulus")
    if abs(comparison["band_gap"]["abacus"] - comparison["band_gap"]["vasp"]) > 0.3:
        failures.append("band_gap")

    if len(failures) == 0:
        return "GO"
    elif len(failures) == 1 and "bulk_modulus" in failures:
        return "CONDITIONAL"  # 体模量偏差可接受，需记录
    else:
        return "NO-GO"
```

### 目录结构

```
projects/f-electron-scf/validation/pseudopotential_precheck/
├── comparison.json             # 汇总对比结果
├── go_nogo_report.md           # Go/No-Go 判定报告
├── CeO2/
│   ├── SG15/
│   │   ├── abacus/             # ABACUS 输入/输出
│   │   │   ├── INPUT, STRU, KPT
│   │   │   └── eos_data/       # 7 个体积点的计算结果
│   │   └── vasp/               # VASP 输入/输出
│   │       ├── INCAR, POSCAR, KPOINTS
│   │       └── eos_data/
│   └── PseudoDojo/
│       ├── abacus/
│       └── vasp/
├── Gd2O3/
│   ├── SG15/
│   │   ├── abacus/
│   │   └── vasp/
│   └── PseudoDojo/
│       ├── abacus/
│       └── vasp/
├── run_precheck.py             # 自动化运行脚本
└── analyze_results.py          # 结果分析 + Go/No-Go 判定
```

### Critical Implementation Details

- **截断能一致性**: ABACUS 用 Ry，VASP 用 eV，需确保等效截断能（80 Ry ≈ 1088 eV，VASP 用 550 eV 因 PAW 需要更低截断能）
- **赝势差异**: ABACUS 用 NC/SG15 赝势，VASP 用 PAW 赝势，本身存在系统偏差。阈值设定已考虑此因素
- **Gd2O3 磁序**: Gd2O3 基态为反铁磁序，需正确设置初始磁矩方向，否则可能收敛到亚稳态
- **大体系开销**: Gd2O3 原胞 80 原子，7 个体积点 × 2 代码 × 2 赝势 = 28 次 SCF，需要 HPC 资源
- **abacustest 集成**: `model_004_Eos` 可自动化 ABACUS 端的 EOS 计算，VASP 端需单独脚本
- **结果可重复性**: 记录所有计算的 ABACUS 版本、commit hash、编译选项，确保结果可追溯

## TDD Test Plan

### Tests to Write FIRST

```python
# test_pp_precheck.py
import pytest
import json
import os

PRECHECK_BASE = "projects/f-electron-scf/validation/pseudopotential_precheck"
COMPARISON_FILE = os.path.join(PRECHECK_BASE, "comparison.json")

def test_comparison_table_exists():
    """对比结果文件存在"""
    assert os.path.exists(COMPARISON_FILE), f"Missing: {COMPARISON_FILE}"

def test_all_systems_covered():
    """所有测试体系均有结果"""
    with open(COMPARISON_FILE) as f:
        data = json.load(f)
    for system in ["CeO2", "Gd2O3"]:
        assert system in data, f"Missing system: {system}"

def test_all_pp_sources_covered():
    """每个体系覆盖 SG15 和 PseudoDojo"""
    with open(COMPARISON_FILE) as f:
        data = json.load(f)
    for system in ["CeO2", "Gd2O3"]:
        for source in ["SG15", "PseudoDojo"]:
            assert source in data[system], (
                f"{system}: missing PP source {source}"
            )

def test_required_properties_present():
    """每组对比包含必要物理量"""
    with open(COMPARISON_FILE) as f:
        data = json.load(f)
    required_props = ["lattice_constant", "bulk_modulus", "band_gap"]
    for system in data:
        for source in data[system]:
            if source == "go_nogo":
                continue
            for prop in required_props:
                assert prop in data[system][source], (
                    f"{system}/{source}: missing property '{prop}'"
                )
                entry = data[system][source][prop]
                assert "abacus" in entry, f"{system}/{source}/{prop}: missing ABACUS value"
                assert "vasp" in entry, f"{system}/{source}/{prop}: missing VASP value"

def test_deviation_calculated():
    """偏差百分比已计算"""
    with open(COMPARISON_FILE) as f:
        data = json.load(f)
    for system in data:
        for source in data[system]:
            if source == "go_nogo":
                continue
            for prop in ["lattice_constant", "bulk_modulus"]:
                if prop in data[system][source]:
                    entry = data[system][source][prop]
                    assert "deviation_pct" in entry, (
                        f"{system}/{source}/{prop}: missing deviation_pct"
                    )

def test_go_nogo_decision():
    """每个体系有 Go/No-Go 判定"""
    with open(COMPARISON_FILE) as f:
        data = json.load(f)
    for system in ["CeO2", "Gd2O3"]:
        assert "go_nogo" in data[system], f"{system}: missing go/no-go decision"
        decision = data[system]["go_nogo"]
        assert decision in ["GO", "CONDITIONAL", "NO-GO"], (
            f"{system}: invalid go/no-go value '{decision}'"
        )

def test_input_files_exist():
    """ABACUS 输入文件存在"""
    for system in ["CeO2", "Gd2O3"]:
        for source in ["SG15", "PseudoDojo"]:
            abacus_dir = os.path.join(PRECHECK_BASE, system, source, "abacus")
            for fname in ["INPUT", "STRU", "KPT"]:
                fpath = os.path.join(abacus_dir, fname)
                assert os.path.exists(fpath), f"Missing: {fpath}"
```

## Acceptance Criteria

- [ ] CeO2 和 Gd2O3 的 ABACUS vs VASP 对比完成
- [ ] 晶格常数、体模量、带隙偏差量化记录
- [ ] Go/No-Go 判定文档产出
