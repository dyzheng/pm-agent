# FE-200: 自适应 Kerker 预处理参数

## Objective

修改 charge_mixing_preconditioner.cpp，实现自适应 mixing_gg0：(1) 根据体系类型（金属/绝缘体/f电子）自动选择初始值，(2) 在 SCF 过程中根据残差变化动态调整，(3) 对 f 电子体系使用更保守的预处理。需要在 input_parameter.h 中添加 mixing_gg0_auto 选项。

## Reference Code

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing_preconditioner.cpp`** (176 lines)
- `Kerker_screen_recip()` — 倒空间 Kerker 预处理
  - Kerker 公式: F(G) = |G|² / (|G|² + gg0²)
  - `gg0` 控制预处理强度: gg0 大→更强预处理（抑制长波长电荷晃动）
- `Keriker_screen_real()` — 实空间 Kerker 预处理（注意拼写）

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.h`** (213 lines)
- `Charge_Mixing` 类
- `mixing_gg0` — Kerker 参数（当前为固定值）
- `mixing_gg0_mag` — 磁性通道的 Kerker 参数
- `mixing_gg0_min` — Kerker 参数下限

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.cpp`** (259 lines)
- `set_mixing()` — 设置 mixing 参数
- `init_mixing()` — 初始化 mixing 数据结构

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing_rho.cpp`** (613 lines)
- `mix_rho()` — 实际执行 mixing，调用 Kerker 预处理

### Prior Art

**VASP**: `AMIX_MAG` 和 `BMIX` 参数，金属体系自动使用更强的 Kerker 预处理。
**QE**: `mixing_beta` 和 `mixing_mode` 参数，`local-TF` 模式对局域电荷使用 Thomas-Fermi 预处理。

## Implementation Guide

### Architecture Decisions

- 新增 `mixing_gg0_auto` 输入参数（bool），默认 false（向后兼容）
- 自适应逻辑在 `Charge_Mixing` 类中实现，不修改 Kerker 核心公式
- 体系类型检测: 通过 `orbital_corr` 数组检测是否含 f 电子（l=3）
- 动态调整: 在 `mix_rho()` 中根据残差变化率调整 gg0

### 自适应策略

| 体系类型 | 检测方法 | 初始 gg0 | 说明 |
|----------|----------|----------|------|
| 绝缘体（无 f） | band gap > 0, 无 orbital_corr | 1.0 | 标准值 |
| 金属（无 f） | smearing > 0 | 1.5 | 更强预处理 |
| f 电子体系 | orbital_corr 含 l=3 | 0.5 | 更保守，避免过度预处理 |
| f 电子 + 金属 | 两者兼有 | 0.8 | 折中 |

### 动态调整算法

```
if mixing_gg0_auto:
    residual_ratio = drho_new / drho_old
    if residual_ratio > 1.5:  # 残差增大，预处理过强
        gg0 *= 0.8  # 减弱预处理
    elif residual_ratio < 0.3:  # 收敛很快，可以加强
        gg0 *= 1.2  # 加强预处理
    gg0 = clamp(gg0, mixing_gg0_min, 3.0)
```

### Critical Implementation Details

- **mixing_gg0_min**: 下限防止 gg0 过小（预处理失效），默认 0.1
- **磁性通道**: `mixing_gg0_mag` 独立于 `mixing_gg0`，f 电子体系的磁性通道需要更保守
- **首步不调整**: 第一步没有历史残差，使用初始值
- **与 mixing_beta 的交互**: gg0 和 beta 共同控制收敛，两者不应同时大幅调整

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(AdaptiveKerkerTest, DetectFElectronSystem) {
    // 含 f 电子的体系应被正确检测
    int orbital_corr[] = {-1, 3, -1};  // 第二个原子类型有 f 轨道
    EXPECT_TRUE(has_f_electrons(orbital_corr, 3));
}

TEST_F(AdaptiveKerkerTest, InitialGg0ForFSystem) {
    // f 电子体系的初始 gg0 应更小
    setup_f_electron_system();
    auto gg0 = get_adaptive_gg0();
    EXPECT_LT(gg0, 1.0);  // 比默认值小
    EXPECT_GT(gg0, 0.1);  // 但不能太小
}

TEST_F(AdaptiveKerkerTest, DynamicAdjustment) {
    // 残差增大时 gg0 应减小
    double gg0_before = get_gg0();
    simulate_residual_increase(2.0);
    double gg0_after = get_gg0();
    EXPECT_LT(gg0_after, gg0_before);
}

TEST_F(AdaptiveKerkerTest, NonFSystemUnaffected) {
    // 非 f 电子体系不受影响（mixing_gg0_auto=false 时）
    setup_si_system();
    EXPECT_NEAR(get_gg0(), default_gg0, 1e-10);
}
```

## Acceptance Criteria

- [ ] 自动检测体系中是否含 f 电子
- [ ] 根据体系类型自动调整 mixing_gg0
- [ ] CeO2 收敛步数减少 >20%
- [ ] 不影响非 f 电子体系性能
