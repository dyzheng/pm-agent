# FE-113: mixing_restart 与 mixing_dftu 协同修复

## Objective

修复 mixing_restart 与 mixing_dftu 的兼容性问题，包括 kpar > 1 时的正确性。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_estate/module_charge/chgmixing.cpp`** (120-172)
- `chgmixing_ks_pw()` — mixing_restart 与 DFT+U/DeltaSpin 的协调
  - 当 U-ramping 更新时触发 mixing_restart
  - 当 DeltaSpin 收敛条件变化时触发 mixing_restart
  - mixing_restart 时需要同时重置 charge mixing 和 locale mixing

**`/root/abacus-zdy-tmp/source/source_lcao/module_dftu/dftu_occup.cpp`**
- `mix_locale()` — mixing_restart 时需要重置 locale_save

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_estate/module_charge/chgmixing.cpp`**
- `chgmixing_ks_pw()` — 需修复 mixing_restart 与 mixing_dftu 的交互

**`/root/abacus-develop/source/source_estate/module_charge/charge_mixing.cpp`** (259 lines)
- `mix_reset()` — 重置 Broyden 历史
- `init_mixing()` — 重新初始化 mixing 数据结构

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 lines)
- `copy_locale()`, `zero_locale()` — locale 操作
- 需添加 `reset_locale_mixing()` 或在 `mix_locale()` 中处理 restart

## Implementation Guide

### Architecture Decisions

- mixing_restart 时同时重置: (1) charge Broyden 历史, (2) locale Broyden 历史, (3) locale_save
- kpar > 1 时 locale 的 MPI 归约需要在 mixing 前完成
- mixing_restart 触发条件: U-ramping 更新、DeltaSpin 收敛变化、用户手动触发

### 问题分析

| 问题 | 原因 | 修复 |
|------|------|------|
| mixing_restart 后 locale 不一致 | locale_save 未重置 | restart 时 `zero_locale(locale_save)` |
| kpar > 1 时 locale 错误 | locale 归约在 mixing 后 | 将归约移到 mixing 前 |
| U-ramping 后 mixing 不稳定 | Broyden 历史包含旧 U 值的信息 | restart 时清空 Broyden 历史 |

### Critical Implementation Details

- **kpar > 1 的 locale 归约**: `Parallel_Reduce::reduce_pool()` 需要在 `mix_locale()` 之前调用
- **mixing_restart 信号**: 通过 `Charge_Mixing::mix_reset()` 传递，需要同步到 `Plus_U::mix_locale()`
- **状态一致性**: restart 后第一步不做 mixing（相当于 iter=1）
- **测试难度**: kpar > 1 需要多进程测试环境

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(MixingRestartTest, LocaleResetOnRestart) {
    // mixing_restart 后 locale_save 应被清零
    Plus_U::get_instance().locale_save = non_zero_locale;
    trigger_mixing_restart();
    EXPECT_TRUE(is_zero(Plus_U::get_instance().locale_save));
}

TEST_F(MixingRestartTest, BroydenHistoryCleared) {
    // mixing_restart 后 Broyden 历史应清空
    run_scf_steps(5);  // 积累 Broyden 历史
    trigger_mixing_restart();
    EXPECT_EQ(get_broyden_history_size(), 0);
}

TEST_F(MixingRestartTest, FirstStepAfterRestartNoMixing) {
    // restart 后第一步不做 locale mixing
    trigger_mixing_restart();
    Plus_U::get_instance().cal_occ_pw(1, psi, wg, cell, 0.7);
    // locale 应等于 SCF 计算值，不是 mixed 值
    EXPECT_EQ(locale, locale_scf);  // no mixing applied
}
```

## Acceptance Criteria

- [ ] mixing_restart 后 mixing_dftu 状态正确
- [ ] kpar > 1 时 mixing_dftu 正确
- [ ] U-ramping 触发 restart 后收敛正常
- [ ] DeltaSpin 收敛变化触发 restart 后收敛正常
