# FE-205: constrained DFT 框架（f 电子数约束）

## Objective

[EPIC][工程追赶] 实现 constrained DFT：(1) 新模块 charge_constraint.cpp，添加惩罚势 V = λ·(n_f - n_target)^2 到哈密顿量，(2) 约束强度 λ 从大到小逐步释放（类似 U-ramping），(3) 支持按原子指定目标 f 电子数，(4) 与 DFT+U 的 omc 协同工作。这是确保 f 电子体系收敛到正确基态的关键手段。

已分解为子任务：FE-205-1（模块骨架与参数）→ FE-205-2（惩罚势与投影）→ FE-205-3（Lambda 调度与 SCF 集成）→ FE-205-4（omc 协同与端到端验证）

## Reference Code

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 lines)
- `Plus_U` 类 — 提供 onsite projector 和占据矩阵基础设施
- `locale[iat][l][n][spin]` — 占据矩阵，constrained DFT 从中提取 n_f
- `eff_pot_pw` — V_U 势数组，constrained DFT 的惩罚势可叠加到此

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_proj_tools.cpp`** (1020 lines)
- `Onsite_Proj_tools` — 提供 becp 计算和势应用的基础设施
- 惩罚势可通过类似 `cal_ps_dftu()` 的方式应用

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `iter_init()`, `iter_finish()` — SCF 循环集成点

### Prior Art

**QE constrained_magnetization**: QE 的 `constrained_magnetization` 在 `v_of_rho.f90` 中实现，使用惩罚势约束局域磁矩。
**VASP LAMBDA**: VASP 的 occupation matrix control 使用类似的惩罚势方法。
**DeltaSpin**: ABACUS 已有的 DeltaSpin 模块（`module_deltaspin`）使用拉格朗日乘子约束磁矩，constrained DFT 可参考其架构。

## Implementation Guide

### Architecture Decisions

- **新模块**: `source/source_lcao/module_constraint/charge_constraint.h/cpp`
- **复用 DFT+U 基础设施**: 使用 `Plus_U::locale` 获取占据矩阵，使用 `Onsite_Proj_tools` 应用势
- **惩罚势叠加**: 将 V_penalty 叠加到 `eff_pot_pw`，与 V_U 共享应用路径
- **Lambda 调度**: 类似 U-ramping 的逐步释放机制

### 物理公式

```
惩罚势:
  V_penalty = λ · (n_f - n_target)²
  E_penalty = λ · (n_f - n_target)²

对 Hamiltonian 的贡献:
  dV/dn_f = 2λ · (n_f - n_target)
  → 叠加到 V_U 势: V_eff = V_U + dV/dn_f · P_f
  其中 P_f 是 f 轨道投影算符

Lambda 调度:
  λ(t) = λ₀ · exp(-t/τ)  (指数衰减)
  或 λ(t) = λ₀ · max(0, 1 - t/T)  (线性衰减)
```

### Critical Implementation Details

- **n_f 计算**: `n_f = Tr(locale[iat][l=3])` — 从 DFT+U 占据矩阵提取 f 电子数
- **势叠加方式**: dV/dn_f 是标量，乘以单位矩阵后叠加到 vu_iat
- **与 V_U 的关系**: V_penalty 和 V_U 是独立的，但通过同一个 `eff_pot_pw` 数组应用
- **Lambda 释放时机**: 在 `iter_init()` 中更新 λ，在 `iter_finish()` 中检查收敛
- **收敛判据**: 需要同时满足 ΔE < thr 和 |n_f - n_target| < 0.05

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(ConstrainedDFTTest, PenaltyPotentialCorrect) {
    // V = λ·(n_f - n_target)²
    double lambda = 10.0, n_f = 1.5, n_target = 1.0;
    double V = lambda * (n_f - n_target) * (n_f - n_target);
    EXPECT_NEAR(V, 2.5, 1e-10);
    double dV = 2 * lambda * (n_f - n_target);
    EXPECT_NEAR(dV, 10.0, 1e-10);
}

TEST_F(ConstrainedDFTTest, LambdaDecay) {
    // 指数衰减
    LambdaScheduler sched(/*lambda0=*/10.0, /*tau=*/50, /*mode=*/"exp");
    EXPECT_NEAR(sched.get(0), 10.0, 1e-10);
    EXPECT_NEAR(sched.get(50), 10.0 * exp(-1.0), 1e-6);
    EXPECT_NEAR(sched.get(200), 10.0 * exp(-4.0), 1e-6);
}
```

## Acceptance Criteria

- [ ] Ce2O3 中 Ce 的 f 电子数可被约束到目标值±0.1
- [ ] 释放约束后保持
- [ ] 实现惩罚势 V_constraint
- [ ] 约束强度逐步释放
- [ ] 与 DFT+U 占据矩阵控制协同
