# FE-102: DFT+U PW nspin=1/2 扩展

## Objective

扩展 PW DFT+U 支持 nspin=1 和 nspin=2。在 dftu_pw.cpp 添加 nspin=1/2 分支，在 esolver_ks_pw.cpp 处理 nspin=2 的 isk 映射。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_lcao/module_dftu/dftu_pw.cpp`**
- `cal_occ_pw()` — nspin=1/2 分支逻辑：
  - nspin=1: 所有 k-point 贡献到同一 locale，权重 ×2（自旋简并）
  - nspin=2: 通过 `isk[ik]` 区分 spin-up/down，分别累加到 locale[spin=0] 和 locale[spin=1]
  - nspin=4: npol=2，becp 有 2*nkb 分量，映射到 4 个自旋分量

**`/root/abacus-zdy-tmp/source/source_esolver/esolver_ks_pw.cpp`**
- `iter_init()` — nspin=2 时传递 `pelec->klist->isk.data()` 给 cal_occ_pw

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_pw.cpp`** (219 lines)
- `cal_occ_pw()` — 需添加 nspin=1/2 的 becp→locale 映射分支
- 关键：nspin=1 时 `locale[iat][l][n][spin=0]` 只有一个自旋通道
- 关键：nspin=2 时需要 isk 数组确定每个 k-point 的自旋通道

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_occup.cpp`** (541 lines)
- `cal_occup_m_k()` — LCAO 版本的 nspin=2 处理，可参考 isk 映射逻辑

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `iter_init()`:190 — 需确保 nspin=2 时正确传递 isk

### Prior Art

**FE-100** (onsite_projector nspin=1/2) — 已实现 `cal_occupations()` 的 npol=1 分支，提供了 nspin=1/2 下 becp 计算的基础设施。

## Implementation Guide

### Architecture Decisions

- nspin=1/2 时 npol=1，becp 只有 nkb 分量（而非 2*nkb）
- nspin=1 的 locale 只有 spin=0 通道，对角元素 ×2 补偿自旋简并
- nspin=2 的 locale 有 spin=0 和 spin=1 两个通道，通过 isk[ik] 路由

### Data Structure Mapping

| nspin | npol | becp 大小 | locale 自旋维度 | isk 映射 |
|-------|------|-----------|----------------|----------|
| 1 | 1 | nkb | 1 (×2 简并) | 全部 → spin=0 |
| 2 | 1 | nkb | 2 | isk[ik]=0→spin=0, isk[ik]=1→spin=1 |
| 4 | 2 | 2*nkb | 4 | 4 分量直接映射 |

### Critical Implementation Details

- **自旋简并因子**: nspin=1 时 wg 已包含 ×2 因子（ABACUS 约定），不需要额外乘 2
- **isk 数组来源**: `pelec->klist->isk` 是 `std::vector<int>`，长度为 nks
- **V_U 势**: nspin=2 时 `cal_VU_pot_pw(spin)` 需要分别对 spin=0 和 spin=1 调用
- **eff_pot_pw 索引**: nspin=2 时 eff_pot_pw 需要两套（spin-up 和 spin-down），索引方式需与 OnsiteProj 算符一致

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(DftuPwTest, CalOccPwNspin2) {
    // NiO nspin=2: spin-up d^8, spin-down d^8, 但 majority/minority 不同
    setup_nio_nspin2();
    Plus_U::get_instance().cal_occ_pw(1, psi, wg, cell, 0.7);
    auto& locale = Plus_U::get_instance().locale;
    double occ_up = trace_locale(iat_Ni, l_d, /*spin=*/0);
    double occ_dn = trace_locale(iat_Ni, l_d, /*spin=*/1);
    EXPECT_NEAR(occ_up + occ_dn, 8.0, 0.5);  // total d electrons
    EXPECT_NE(occ_up, occ_dn);  // 磁性体系 up ≠ down
}

TEST_F(DftuPwTest, CalOccPwNspin1) {
    // Si nspin=1: 非磁性，locale 只有 spin=0
    setup_si_nspin1();
    Plus_U::get_instance().cal_occ_pw(1, psi, wg, cell, 0.7);
    // 不应 crash，locale[spin=0] 应有合理值
}
```

## Acceptance Criteria

- [ ] NiO nspin=2 PW DFT+U SCF 可收敛
- [ ] 能量与 LCAO 一致
- [ ] 新增 100_PW_DFTU_S2（nspin=2）和 101_PW_DFTU_S1（nspin=1）集成测试
