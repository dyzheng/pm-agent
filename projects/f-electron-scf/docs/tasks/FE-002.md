# FE-002: 建立 DFT+U 回归测试套件

## Objective

建立CeO2和GdN的DFT+U回归测试基线。包括LCAO和PW两种基组的参考结果。确保后续代码移植不破坏现有功能。

## Reference Code

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- `ESolver_KS_PW` 类 — PW 基组 Kohn-Sham 求解器
- `before_scf()` — SCF 前初始化（设置势函数、混合参数）
- `iter_init()`:190 — 每步 SCF 迭代初始化
- `iter_finish()` — 迭代结束，检查收敛
- `after_scf()` — SCF 收敛后处理（输出能量、力等）

**`/root/abacus-develop/source/source_esolver/esolver_ks_lcao.cpp`** (572 lines)
- `ESolver_KS_LCAO` 类 — LCAO 基组 Kohn-Sham 求解器
- LCAO 基组下 DFT+U 功能更完善，是 f 电子计算的首选基组
- `before_scf()` — 初始化 LCAO 矩阵、DFT+U 参数

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu.h`** (354 lines)
- `Plus_U` 类 — DFT+U 主接口
- `U[]` — Hubbard U 参数
- `orbital_corr[]` — 关联轨道（Ce: l=3, O: 无）
- `cal_energy_correction()` — E_U 能量修正

**`/root/abacus-develop/source/source_lcao/module_dftu/dftu_io.cpp`** (538 lines)
- `write_occup_m()`:76 — 输出占据矩阵到 `onsite.dm`
- `read_occup_m()`:234 — 读取占据矩阵（用于 omc 和 restart）
- 回归测试需对比占据矩阵输出

### 测试框架参考

**`/root/abacus-test/abacustest/lib_model/model_001_Conv.py`**
- abacustest 收敛测试模型
- 检查 SCF 是否收敛、能量是否在阈值内
- 可直接用于回归测试的自动化运行

## Implementation Guide

### Architecture Decisions

- **两个测试体系**: CeO2（萤石结构，Ce4+ f⁰）和 GdN（岩盐结构，Gd3+ f⁷ 半满）
- **两种基组**: 每个体系分别用 LCAO 和 PW 基组计算
- **参考值来源**: 先用当前 develop 分支运行，记录结果作为基线
- **自动化**: 使用 abacustest 框架管理测试运行和结果对比

### 测试体系参数

**CeO2（萤石结构）**

| 参数 | LCAO | PW |
|------|------|----|
| 结构 | Fm-3m, a=5.411 Å | 同左 |
| k 点 | 4×4×4 Monkhorst-Pack | 同左 |
| 截断能 | — | 60 Ry |
| 基组 | DZP | — |
| 泛函 | PBE | PBE |
| hubbard_u (Ce) | 5.0 eV | 5.0 eV |
| orbital_corr (Ce) | 3 (f 轨道) | 3 |
| nspin | 1 | 1 |

**GdN（岩盐结构）**

| 参数 | LCAO | PW |
|------|------|----|
| 结构 | Fm-3m, a=4.974 Å | 同左 |
| k 点 | 4×4×4 Monkhorst-Pack | 同左 |
| 截断能 | — | 80 Ry |
| 基组 | DZP | — |
| 泛函 | PBE | PBE |
| hubbard_u (Gd) | 6.0 eV | 6.0 eV |
| orbital_corr (Gd) | 3 (f 轨道) | 3 |
| nspin | 2 (磁性) | 2 |

### 参考值记录格式

每个体系的 `reference.json` 包含：

```json
{
  "system": "CeO2",
  "abacus_version": "3.x.x",
  "commit": "abc1234",
  "date": "2026-02-xx",
  "LCAO": {
    "total_energy_eV": -xxx.xxxx,
    "band_gap_eV": x.xx,
    "scf_steps": xx,
    "converged": true,
    "occupation_matrix_trace": x.xx,
    "dftu_energy_eV": x.xxxx
  },
  "PW": {
    "total_energy_eV": -xxx.xxxx,
    "band_gap_eV": x.xx,
    "scf_steps": xx,
    "converged": true
  }
}
```

### 目录结构

```
projects/f-electron-scf/tests/regression/
├── CeO2/
│   ├── reference.json          # 参考值
│   ├── LCAO/
│   │   ├── INPUT               # ABACUS 输入文件
│   │   ├── STRU                # 结构文件
│   │   ├── KPT                 # k 点文件
│   │   └── expected_output/    # 参考输出（onsite.dm 等）
│   └── PW/
│       ├── INPUT
│       ├── STRU
│       └── KPT
├── GdN/
│   ├── reference.json
│   ├── LCAO/
│   │   ├── INPUT
│   │   ├── STRU
│   │   └── KPT
│   └── PW/
│       ├── INPUT
│       ├── STRU
│       └── KPT
├── run_regression.py           # 自动化运行脚本
└── compare_results.py          # 结果对比脚本
```

### 回归测试阈值

| 物理量 | 阈值 | 说明 |
|--------|------|------|
| 总能量 | 1 meV/atom | 绝对偏差 |
| 带隙 | 0.05 eV | 绝对偏差 |
| 磁矩 | 0.01 μB | 绝对偏差（GdN） |
| SCF 步数 | ±5 步 | 允许小幅波动 |
| 占据矩阵 | 0.01 | 矩阵元素最大偏差 |

### Critical Implementation Details

- **CeO2 的 f⁰ 构型**: Ce4+ 的 4f 轨道为空，DFT+U 主要影响带隙大小，是最简单的 f 电子测试
- **GdN 的 f⁷ 构型**: Gd3+ 半满 4f 壳层，nspin=2 磁性计算，测试 DFT+U 对磁矩的影响
- **PW 基组限制**: `dftu_pw.cpp` 的 f 电子支持可能不完善，PW 测试可能需要更高截断能
- **赝势选择**: 需要 FE-000 提供的 f_in_valence 赝势，在 FE-000 完成前可先用 SG15 默认赝势建立框架
- **SCF 收敛**: f 电子体系 SCF 收敛困难，可能需要 mixing_beta=0.3 + mixing_dftu=1
- **abacustest 集成**: `model_001_Conv` 可检查收敛性，但需自定义脚本对比占据矩阵

## TDD Test Plan

### Tests to Write FIRST

```python
# test_regression_baseline.py
import pytest
import json
import os

REG_BASE = "projects/f-electron-scf/tests/regression"

def test_regression_dirs_exist():
    """回归测试目录结构完整"""
    for system in ["CeO2", "GdN"]:
        for basis in ["LCAO", "PW"]:
            path = os.path.join(REG_BASE, system, basis)
            assert os.path.isdir(path), f"Missing: {path}"

def test_reference_values_recorded():
    """参考值文件存在且包含必要字段"""
    for system in ["CeO2", "GdN"]:
        ref_file = os.path.join(REG_BASE, system, "reference.json")
        assert os.path.exists(ref_file), f"Missing: {ref_file}"
        with open(ref_file) as f:
            ref = json.load(f)
        for key in ["total_energy_eV", "band_gap_eV", "scf_steps"]:
            for basis in ["LCAO", "PW"]:
                assert key in ref.get(basis, {}), (
                    f"{system}/{basis}: missing '{key}'"
                )

def test_input_files_complete():
    """每个测试用例包含完整的 ABACUS 输入文件"""
    for system in ["CeO2", "GdN"]:
        for basis in ["LCAO", "PW"]:
            path = os.path.join(REG_BASE, system, basis)
            for fname in ["INPUT", "STRU", "KPT"]:
                fpath = os.path.join(path, fname)
                assert os.path.exists(fpath), f"Missing: {fpath}"

def test_input_has_dftu_params():
    """INPUT 文件包含 DFT+U 参数"""
    for system in ["CeO2", "GdN"]:
        for basis in ["LCAO", "PW"]:
            input_path = os.path.join(REG_BASE, system, basis, "INPUT")
            with open(input_path) as f:
                content = f.read()
            assert "dft_plus_u" in content.lower() or "hubbard_u" in content.lower(), (
                f"{system}/{basis}/INPUT: missing DFT+U parameters"
            )
            assert "orbital_corr" in content, (
                f"{system}/{basis}/INPUT: missing orbital_corr"
            )

def test_gdn_is_magnetic():
    """GdN 测试应为磁性计算 (nspin=2)"""
    for basis in ["LCAO", "PW"]:
        input_path = os.path.join(REG_BASE, "GdN", basis, "INPUT")
        with open(input_path) as f:
            content = f.read()
        assert "nspin" in content and "2" in content, (
            f"GdN/{basis}/INPUT: should have nspin=2"
        )

def test_regression_script_exists():
    """自动化回归测试脚本存在"""
    script = os.path.join(REG_BASE, "run_regression.py")
    assert os.path.exists(script), f"Missing: {script}"
```

## Acceptance Criteria

- [ ] CeO2 LCAO DFT+U 基线结果
- [ ] GdN LCAO DFT+U 基线结果
- [ ] 自动化回归测试脚本
- [ ] 结果对比阈值定义
