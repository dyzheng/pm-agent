# FE-108: DeltaSpin LCAO 算符更新

## Objective

更新 LCAO 下的 DeltaSpin 算符。合并 zdy-tmp 对 dspin_lcao.h/cpp、dspin_force_stress.hpp 的改动。更新 esolver_ks_lcao.cpp 中的 DeltaSpin 集成点。

## Reference Code

### Source Code (zdy-tmp 改动)

**`/root/abacus-zdy-tmp/source/source_lcao/`** — DeltaSpin LCAO 算符相关文件
- `dspin_lcao.h/cpp` — LCAO 下的 DeltaSpin 算符
- `dspin_force_stress.hpp` — DeltaSpin 力和应力的 LCAO 模板实现

**`/root/abacus-zdy-tmp/source/source_esolver/esolver_ks_lcao.cpp`**
- DeltaSpin 在 LCAO ESolver 中的集成点
- `before_scf()`, `iter_init()`, `iter_finish()` 中的 DeltaSpin 调用

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_lcao/module_deltaspin/`** (2400 lines)
- 已有完整的 DeltaSpin LCAO 实现
- 需要合并 zdy-tmp 的增量改动

**`/root/abacus-develop/source/source_esolver/`**
- `esolver_ks_lcao.cpp` — LCAO ESolver，需更新 DeltaSpin 集成

### Prior Art

**FE-107** — 核心移植完成后，LCAO 算符更新才能进行。

## Implementation Guide

### Architecture Decisions

- LCAO DeltaSpin 算符通过 `Hamilt<TK>` 算符链集成
- 力和应力通过 `dspin_force_stress.hpp` 模板实现（同时支持 gamma-only 和 k-point）
- 与 FE-107 的核心移植配合，确保 LCAO 路径完整

### Critical Implementation Details

- **算符链注册**: DeltaSpin 算符在 `Hamilt<TK>` 构建时注册
- **conserve_setting**: 与 FE-111 相关，控制 DeltaSpin+DFT+U 联合行为
- **力/应力模板**: `dspin_force_stress.hpp` 使用模板同时支持 `double`（gamma）和 `complex<double>`（k-point）
- **esolver 集成**: `iter_init()` 中调用 `run_lambda_loop()`，`after_scf()` 中输出约束信息

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(DeltaSpinLcaoTest, OperatorRegistered) {
    setup_lcao_deltaspin("NiO");
    auto* hamilt = get_hamilt();
    EXPECT_TRUE(hamilt->has_operator("dspin"));
}

TEST_F(DeltaSpinLcaoTest, LcaoRegressionUnchanged) {
    auto energy_before = run_reference("NiO_dspin_lcao");
    auto energy_after = run_current("NiO_dspin_lcao");
    EXPECT_NEAR(energy_before, energy_after, 1e-10);
}
```

## Acceptance Criteria

- [ ] LCAO DeltaSpin SCF 正确
- [ ] 力/应力正确
- [ ] 回归测试通过（现有 LCAO DeltaSpin 结果不变）
