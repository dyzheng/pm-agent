# FE-111: DeltaSpin + DFTU 联合 + conserve_setting

## Objective

支持 DeltaSpin 和 DFT+U 同时使用。添加 conserve_setting 参数控制联合计算行为。

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_esolver/esolver_ks_pw.cpp`**
- DFT+U 和 DeltaSpin 同时启用时的 SCF 流程
- `iter_init()` — 先 cal_occ_pw (DFT+U)，再 lambda_loop (DeltaSpin)
- conserve_setting 控制两者的交互方式

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/op_pw_proj.cpp`**
- `OnsiteProj::act()` — 同时应用 V_U 和 λ·σ 到波函数
  - 先 `cal_ps_delta_spin()`，再 `cal_ps_dftu()`

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/spin_constrain.h`**
- `conserve_setting` 参数定义和使用

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_esolver/esolver_ks_pw.cpp`** (447 lines)
- 需添加 DFT+U + DeltaSpin 联合调用逻辑

**`/root/abacus-develop/source/source_pw/module_pwdft/op_pw_proj.cpp`**
- `OnsiteProj::act()` — 需确保两个势同时正确应用

**`/root/abacus-develop/source/source_lcao/module_deltaspin/spin_constrain.h`** (291 lines)
- 需添加 `conserve_setting` 参数

## Implementation Guide

### Architecture Decisions

- DFT+U 和 DeltaSpin 通过同一个 `OnsiteProj` 算符应用，共享 becp 计算
- conserve_setting 控制: 是否在 DeltaSpin lambda loop 中同时更新 DFT+U 占据矩阵
- 力和应力: `forces_onsite.cpp` 和 `stress_onsite.cpp` 已同时调用两者

### conserve_setting 选项

| 值 | 行为 | 适用场景 |
|----|------|----------|
| 0 | DFT+U 和 DeltaSpin 独立更新 | 默认，简单体系 |
| 1 | lambda loop 内同步更新 DFT+U 占据 | 强关联体系 |
| 2 | 交替优化: 先收敛 DFT+U，再收敛 DeltaSpin | 难收敛体系 |

### Critical Implementation Details

- **调用顺序**: OnsiteProj::act() 中 DeltaSpin 在 DFT+U 之前（λ·σ 先于 V_U）
- **能量贡献**: 总能量 = E_KS + E_U + E_constrain，三者独立计算
- **收敛判据**: 需要 DFT+U 和 DeltaSpin 都收敛才算 SCF 收敛
- **mixing 交互**: mixing_dftu 和 DeltaSpin 的 lambda 更新需要协调

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(JointTest, DftuPlusDeltaSpin) {
    setup_nio_dftu_dspin();
    run_scf();
    EXPECT_TRUE(is_converged());
    EXPECT_NE(get_energy_u(), 0.0);
    EXPECT_NE(get_energy_constrain(), 0.0);
}

TEST_F(JointTest, ConserveSettingEffect) {
    auto result_0 = run_with_conserve(0);
    auto result_1 = run_with_conserve(1);
    // 最终能量应相同（不同路径到同一极小值）
    EXPECT_NEAR(result_0.energy, result_1.energy, 1e-6);
}
```

## Acceptance Criteria

- [ ] DeltaSpin + DFT+U 联合计算正确
- [ ] conserve_setting 参数生效
- [ ] 能量包含 E_U 和 E_constrain 两个贡献
- [ ] 力和应力包含两者的贡献
