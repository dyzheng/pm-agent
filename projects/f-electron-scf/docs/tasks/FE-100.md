# FE-100: onsite_projector nspin=1/2 支持

## Objective

扩展 develop 的 onsite_projector 支持 nspin=1/2。当前 develop 仅支持 nspin=4。需要：(1) cal_occupations() 增加 isk_in 参数，(2) cal_becp() 增加 npwx 参数，(3) 适配 Onsite_Proj_tools（develop）vs FS_Nonlocal_tools（zdy-tmp）的 API 差异。

**状态**: IN_REVIEW — 已完成实现，详见 `tasks/PR-1-task-instruction.md`

## Reference Code

### Source Code (zdy-tmp 参考实现)

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/onsite_projector.h`**
- `overlap_proj_psi(npm, ppsi, npwx)` — 添加 npwx 参数
- `cal_occupations(psi, wg_in, isk_in)` — 添加 isk_in 参数

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/onsite_projector.cpp`**
- `overlap_proj_psi()`:567-586 — npol=1 occupation 累加分支
- `cal_occupations()` — sign 变量用于 nspin=2 的 Mz 计算

**`/root/abacus-zdy-tmp/source/source_pw/module_pwdft/fs_nonlocal_tools.h`**
- `cal_becp(ik, npm, becp_in, ppsi_in, npwx)` — zdy-tmp 版本的 becp 计算

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_projector.h`** (158 lines)
- `projectors::OnsiteProjector<T, Device>` — 模板类
- `overlap_proj_psi(npm, ppsi)` — 需添加 npwx 参数
- `cal_occupations(psi, wg_in)` — 需添加 isk_in 参数

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_projector.cpp`** (648 lines)
- `overlap_proj_psi()`:339-406 — 需添加 npwx 默认值逻辑
- `cal_occupations()`:523-643 — 需添加 npol=1 分支

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_proj_tools.h`** (215 lines)
- `hamilt::Onsite_Proj_tools<FPTYPE, Device>` — develop 版本（对应 zdy-tmp 的 FS_Nonlocal_tools）
- `cal_becp(ik, npm, becp_in, ppsi_in)` — 需添加 npwx 参数

**`/root/abacus-develop/source/source_pw/module_pwdft/onsite_proj_tools.cpp`** (1020 lines)
- `cal_becp()`:278 — 需添加 npwx 参数，当 npwx>0 时替代 npwk_max

**`/root/abacus-develop/source/source_io/module_ctrl/ctrl_output_pw.cpp`**
- Line 239-240 — 调用方需传递 `kv.isk.data()` 作为第三个参数

### Prior Art

**`/root/pm-agent/projects/f-electron-scf/tasks/PR-1-task-instruction.md`** (269 lines)
- 完整的逐行修改指南，包含 diff 和验证清单
- 已完成实现，commit `d2364165c`，分支 `zdy/feat/onsite-proj-nspin12`

## Implementation Guide

### Architecture Decisions

- 使用默认参数 `npwx=0` 保持向后兼容，0 表示使用 `npwk_max`
- 使用 `isk_in` 指针而非引用，与 ABACUS 现有 API 风格一致
- npol=1 分支中用 `sign = isk[ik]==0 ? 1 : -1` 计算磁矩方向

### API 差异映射

| zdy-tmp | develop | 说明 |
|---------|---------|------|
| `FS_Nonlocal_tools` | `Onsite_Proj_tools` | 类名不同，接口基本一致 |
| `resmem_complex_op()(this->ctx, ptr, size)` | `resmem_complex_op()(ptr, size)` | develop 不需要 ctx 参数 |
| `syncmem_complex_d2h_op()(this->ctx, ...)` | `syncmem_complex_d2h_op()(...)` | develop 不需要 ctx 参数 |

### Critical Implementation Details

- **npwx 参数的作用**: nspin=1/2 时 psi 的 leading dimension 与 nspin=4 不同（nspin=4 包含 2*npol 空间）
- **sign 变量**: nspin=2 时 isk[ik]=0→spin-up(+1), isk[ik]=1→spin-down(-1)，用于 Mz = n_up - n_down
- **不要修改 init()**: develop 的 init() 结构与 zdy-tmp 有差异，不在此 PR 中修改

## TDD Test Plan

### Tests to Write FIRST

```cpp
// test_onsite_projector_nspin.cpp
TEST_F(OnsiteProjTest, Nspin2OccupationSpinUpDown) {
    // nspin=2: spin-up 和 spin-down 的 occupation 应分别累加
    // isk = {0, 0, 1, 1} for 4 k-points
    int isk[] = {0, 0, 1, 1};
    proj->cal_occupations(psi, wg, isk);
    // charge_mag[0] = total charge, charge_mag[3] = Mz
    EXPECT_GT(charge_mag[0], 0.0);  // total charge > 0
    // Mz = n_up - n_down, sign depends on system
}

TEST_F(OnsiteProjTest, Nspin4RegressionUnchanged) {
    // nspin=4 结果不受影响
    proj->cal_occupations(psi, wg, isk);
    // 与修改前的参考值对比
    EXPECT_NEAR(energy_before, energy_after, 1e-12);
}
```

## Acceptance Criteria

- [x] 编译通过
- [x] 现有 nspin=4 测试不受影响（回归 099_PW_DJ_SO）
- [ ] 新增 nspin=2 单元测试（npol=1 spin-up/down occupation、charge_mag）
- [x] npol=2 回归测试通过
