# FE-107: module_deltaspin 核心移植

## Objective

将 zdy-tmp 新增的 deltaspin 文件移植到 develop。新增 cal_h_lambda.cpp、cal_mw_helper.cpp、sc_parse_json.cpp。更新 spin_constrain.h/cpp（合并 zdy-tmp 增强到 develop 基础版本）。适配 include 路径和 GlobalC 去除。

## Reference Code

### Source Code (zdy-tmp 新增文件)

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/cal_h_lambda.cpp`**
- `SpinConstrain<TK>::calculate_delta_hcc()` — 计算 δH_cc 矩阵（约束哈密顿量修正）
  - 签名: `void calculate_delta_hcc(complex<double>* h_tmp, complex<double>* becp_k, Vector3<double>* delta_lambda, int nbands, int nkb, int* nh_iat)`
  - 将 λ·σ 约束势添加到哈密顿量矩阵元素

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/cal_mw_helper.cpp`**
- `SpinConstrain<TK>::cal_mw_from_lambda()` — 从 λ 计算磁矩
  - 签名: `void cal_mw_from_lambda(int i_step, Vector3<double>* delta_lambda = nullptr)`
  - 调用 `update_psi_charge()` 更新波函数和电荷密度
- `SpinConstrain<TK>::update_psi_charge()` — 更新波函数和电荷
  - 签名: `void update_psi_charge(Vector3<double>* delta_lambda, bool pw_solve = true)`

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/sc_parse_json.cpp`**
- JSON 解析: 读取 DeltaSpin 约束参数文件
  - 解析 per-atom 约束: target_mag, constrain 方向, lambda 初始值

**`/root/abacus-zdy-tmp/source/source_lcao/module_deltaspin/spin_constrain.h`** (291 lines)
- `spinconstrain::SpinConstrain<TK>` — 模板单例类
- 新增方法（相对 develop）:
  - `calculate_delta_hcc()` — PW 约束势
  - `cal_mi_pw()` — PW 磁矩计算
  - `update_psi_charge()` — 波函数/电荷更新

### Target Code (develop 分支)

**`/root/abacus-develop/source/source_lcao/module_deltaspin/`** (2400 lines total)

| 文件 | 行数 | 关键方法 |
|------|------|----------|
| `spin_constrain.cpp` | 606 | 单例实现、getter/setter |
| `cal_mw_from_lambda.cpp` | 543 | `cal_mw_from_lambda()`, `update_psi_charge()` |
| `lambda_loop.cpp` | 282 | `run_lambda_loop()` (2 overloads) |
| `cal_mw.cpp` | 172 | `cal_mi_lcao()`, 需添加 `cal_mi_pw()` |
| `lambda_loop_helper.cpp` | 182 | `print_termination()`, `check_restriction()` |
| `init_sc.cpp` | 43 | `init_sc()` |
| `basic_funcs.cpp` | 148 | 向量数学工具 |
| `template_helpers.cpp` | 65 | 模板实例化 |

### Prior Art

**develop 已有的 DeltaSpin LCAO 实现** — 完整的 LCAO 路径已工作，PW 路径需要新增。

## Implementation Guide

### Architecture Decisions

- **不创建新文件**: zdy-tmp 的 3 个独立文件在 develop 中合并到现有文件
- **单例模式保持**: `SpinConstrain<TK>` 使用 `getScInstance()` 单例
- **命名空间**: develop 使用 `spinconstrain::` 命名空间

### 文件映射

| zdy-tmp 新文件 | develop 目标文件 | 说明 |
|---------------|-----------------|------|
| `cal_h_lambda.cpp` | `cal_mw_from_lambda.cpp` | 合并 `calculate_delta_hcc()` |
| `cal_mw_helper.cpp` | `cal_mw_from_lambda.cpp` | `update_psi_charge()` 等 |
| `sc_parse_json.cpp` | `spin_constrain.cpp` | JSON 解析合并到主文件 |
| `spin_constrain.h` 新声明 | `spin_constrain.h` | 添加新方法声明 |

### Critical Implementation Details

- **模板实例化**: 新方法需要在 `template_helpers.cpp` 中添加显式实例化（double 和 complex<double>）
- **PW vs LCAO 分支**: `cal_mi_pw()` 和 `cal_mi_lcao()` 是独立方法，通过调用方选择
- **include 路径**: develop 使用 `source_*` 而非 `module_*`
- **GlobalC 去除**: zdy-tmp 中的 `GlobalC::ucell` 需改为参数传递

## TDD Test Plan

### Tests to Write FIRST

```cpp
TEST_F(DeltaSpinCoreTest, CalculateDeltaHcc) {
    // δH_cc 应将 λ 约束势添加到哈密顿量
    auto& sc = SpinConstrain<complex<double>>::getScInstance();
    sc.set_target_mag(iat, {0, 0, 1.0});
    sc.set_lambda(iat, {0, 0, 0.1});
    sc.calculate_delta_hcc(h_tmp, becp_k, delta_lambda, nbands, nkb, nh_iat);
    EXPECT_NE(h_tmp[0], complex<double>(0, 0));
}

TEST_F(DeltaSpinCoreTest, ParseJsonConstraints) {
    write_test_json("sc.json", R"({"atoms": [{"mag": [0,0,1], "constrain": [0,0,1]}]})");
    auto& sc = SpinConstrain<complex<double>>::getScInstance();
    sc.parse_json("sc.json");
    auto target = sc.get_target_mag(0);
    EXPECT_NEAR(target.z, 1.0, 1e-10);
}
```

## Acceptance Criteria

- [ ] 所有 deltaspin 单元测试通过
- [ ] 编译通过
- [ ] 新方法模板实例化完整（double 和 complex<double>）
- [ ] JSON 约束文件正确解析
