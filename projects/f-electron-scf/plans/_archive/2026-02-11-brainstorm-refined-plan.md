# 稀土f电子SCF收敛：Brainstorm优化后的任务计划

**日期：** 2026-02-11
**策略：** 风险驱动的延迟执行（defer-by-default）

---

## 核心策略变更

原计划将赝势生成作为阻塞一切的前置任务，AI辅助初猜放在最后。
经过brainstorm分析，采用以下策略：

1. **赝势**：使用现有库（SG15/PseudoDojo/PSlibrary），仅在验证失败时生成自定义赝势
2. **NAO轨道**：使用默认DZP设置，仅在LCAO偏差>3%时优化
3. **AI初猜**：从规则启发式开始（氧化态→f电子数），仅在失败率>20%时引入ML
4. **DFT+U**：增量式实现-验证循环，每个功能验证后再开发下一个
5. **验证范围**：由实际用户需求驱动，而非学术完整性
6. **新增Phase 0**：合并现有PW+LCAO DFT+U代码，重构为可插拔架构

---

## 时间线：5-6个月

| 里程碑 | 时间 | 目标 | 门控条件 |
|---|---|---|---|
| M1 | 月1 | 架构就绪 + 基础收敛改进 | CeO2无需手动调参即可收敛 |
| M2 | 月2 | 占据矩阵策略可用 | CeO2+GdN收敛率>80% |
| M3 | 月3 | 用户场景验证通过 | ABACUS vs VASP结构误差<2% |
| M4 | 月5 | 生产就绪 | 非专家用户可成功运行 |
| M5 | 月6 | 发布 | 文档+工作流完成 |

---

## 活跃任务（立即执行）

### Phase 0: 代码集成与架构（月1，第1-2周）

| ID | 标题 | 依赖 | 风险 |
|---|---|---|---|
| T0-1 | 合并PW+LCAO DFT+U代码到主分支 | 无 | LOW |
| T0-2 | 重构DFT+U架构为可插拔策略 | T0-1 | LOW |
| T0-3 | 建立DFT+U回归测试套件（CeO2, GdN基线） | T0-1 | LOW |
| T0-4 | 收集现有f_in_valence赝势 | 无 | LOW |

**T0-2重构目标：**
- 占据矩阵初始化提取为可插拔策略接口
- Mixing/阻尼提取为可配置策略
- 添加约束势钩子
- 目标：支持快速原型开发新收敛策略

### Phase 1: 基础收敛改进（月1第3周 - 月2）

| ID | 标题 | 依赖 | 风险 |
|---|---|---|---|
| T1-1 | 自适应Kerker预处理器 | T0-2 | LOW |
| T1-2 | 分通道mixing_beta | T0-2 | LOW |
| T1-3 | 能量监控+自动回退 | T0-2 | LOW |
| T1-4 | 规则启发式占据猜测 | T0-2 | LOW |

**T1-1**: 自动检测f电子体系，调整mixing_gg0
**T1-2**: 对f通道使用更小的mixing_beta（更保守更新）
**T1-3**: SCF能量上升时自动减小mixing_beta并回退
**T1-4**: 根据元素+氧化态预设f电子数（简单规则，非ML）

**验证门控**: CeO2使用现有赝势可靠收敛

### Phase 2: DFT+U占据矩阵策略（月2第3周 - 月3）

增量式实现-验证循环：

| ID | 标题 | 依赖 | 风险 | 门控 |
|---|---|---|---|---|
| T2-1 | 随机占据矩阵初始化+多起点探索 | T0-2, T0-3 | MEDIUM | 随机初始化是否找到更低能态？ |
| T2-2 | 占据退火策略 | T2-1验证通过 | MEDIUM | 退火是否改善收敛率？ |
| T2-3 | Constrained DFT框架 | T2-1/T2-2不足时 | MEDIUM | 约束是否帮助仍失败的体系？ |

**关键原则**: 每个任务包含验证门控。如果收敛已可靠，跳过下一个功能。

### Phase 3: 用户场景验证（月3第3周 - 月4）

| ID | 标题 | 依赖 | 风险 |
|---|---|---|---|
| T3-1 | 用户需求调研（收集实际计算需求） | 无 | LOW |
| T3-2 | 选择2-3个代表性验证体系 | T3-1 | LOW |
| T3-3 | 跨代码验证（ABACUS vs VASP） | Phase 1+2, T3-2 | MEDIUM |
| T3-4 | 收敛可靠性测试（10次随机种子） | T3-3 | LOW |

**验收标准**: 结构性质误差<2%, 能量误差<10%, 收敛率>90%

### Phase 4: 生产就绪自动化（月5-6）

| ID | 标题 | 依赖 | 风险 |
|---|---|---|---|
| T4-1 | 自动参数选择 | Phase 3 | LOW |
| T4-2 | 失败诊断+自动重试 | T4-1 | MEDIUM |
| T4-3 | abacustest工作流集成 | T4-1 | LOW |
| T4-4 | 文档与示例 | T4-1 | LOW |

---

## 延迟任务（触发条件满足时执行）

### Category A: 自定义赝势生成

| ID | 标题 | 触发条件 |
|---|---|---|
| D-A1 | ONCVPSP生成环境搭建 | T3-3验证显示>5%系统误差，可追溯到赝势质量 |
| D-A2 | 自定义稀土NC赝势生成 | D-A1完成 |
| D-A3 | 新赝势全面验证 | D-A2完成 |

### Category B: NAO轨道优化

| ID | 标题 | 触发条件 |
|---|---|---|
| D-B1 | NAO多zeta轨道生成与测试 | LCAO结果偏离PW参考>3% |
| D-B2 | Spillage算法f轨道调优 | D-B1显示spillage问题 |

### Category C: 机器学习模型

| ID | 标题 | 触发条件 |
|---|---|---|
| D-C1 | ML训练数据收集 | T1-4规则启发式失败率>20% |
| D-C2 | GNN占据矩阵模型训练 | D-C1完成 |
| D-C3 | ABACUS ML集成 | D-C2完成 |

---

## 与Brainstorm系统的映射

活跃任务使用 `TaskStatus.PENDING`，延迟任务使用 `TaskStatus.DEFERRED`。
每个延迟任务的 `defer_trigger` 字段记录触发条件。
当里程碑门控失败时，`check_deferred_triggers` 自动提升相关延迟任务。

**触发格式示例：**
- `T3-3:accuracy_below_threshold` — 验证精度不足时触发赝势生成
- `T1-4:failure_rate_above_20pct` — 启发式失败率过高时触发ML
- `D-A1:completed` — 前置延迟任务完成时触发后续

---

## 与原计划的对比

| 方面 | 原计划 | 优化后 |
|---|---|---|
| 赝势 | Phase 1阻塞一切 | 使用现有库，按需生成 |
| NAO | Phase 1串行依赖 | 默认DZP，按需优化 |
| AI初猜 | Phase 3（月7-9） | 规则启发式在Phase 1，ML延迟 |
| DFT+U | 6个功能全部实现 | 增量验证，按需开发 |
| 验证 | 6个场景全覆盖 | 用户需求驱动 |
| 时间线 | 7-9个月 | 5-6个月 |
| 新增 | 无 | Phase 0代码合并+重构 |
