<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>f-electron-scf é¡¹ç›®çœ‹æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header .stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #ecf0f1;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Kanban Board */
        .kanban {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .column {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .column-header {
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-count {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .task-card {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-card.risk-low { border-left-color: #2ecc71; }
        .task-card.risk-medium { border-left-color: #f39c12; }
        .task-card.risk-high { border-left-color: #e74c3c; }

        .task-id {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .task-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .badge.phase { background: #e8f4f8; color: #3498db; }
        .badge.layer { background: #fef5e7; color: #f39c12; }
        .badge.risk { background: #fadbd8; color: #e74c3c; }

        /* Timeline View */
        .timeline {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .phase-section {
            margin-bottom: 30px;
        }

        .phase-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 6px;
        }

        .phase-tasks {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-left: 20px;
        }

        /* Dependency Graph */
        .graph-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        #dependency-graph {
            width: 100%;
            height: 600px;
            border: 1px solid #ecf0f1;
            border-radius: 4px;
        }

        /* Risk Matrix */
        .risk-matrix {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .risk-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .risk-category {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .risk-category.low {
            background: #d5f4e6;
            border: 2px solid #2ecc71;
        }

        .risk-category.medium {
            background: #fef5e7;
            border: 2px solid #f39c12;
        }

        .risk-category.high {
            background: #fadbd8;
            border: 2px solid #e74c3c;
        }

        .risk-category h3 {
            margin-bottom: 10px;
        }

        .risk-count {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        /* Deferred Tasks */
        .deferred-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .deferred-card {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .trigger-info {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .trigger-label {
            font-weight: bold;
            color: #e67e22;
            margin-bottom: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h4 {
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
        }

        .dependency-list {
            list-style: none;
            padding-left: 0;
        }

        .dependency-list li {
            padding: 5px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ª f-electron-scf é¡¹ç›®çœ‹æ¿</h1>
        <p>ç¨€åœŸfç”µå­æ¨¡å®ˆæ’èµåŠ¿SCFæ”¶æ•›é—®é¢˜ â€” ç»Ÿä¸€ä»»åŠ¡ä½“ç³» (FE ID)</p>
        <div class="stats">
            <div class="stat">
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                <div class="stat-value" id="total-tasks">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">å¾…æ‰§è¡Œ</div>
                <div class="stat-value" style="color: #3498db;" id="pending-tasks">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">å®¡æ ¸ä¸­</div>
                <div class="stat-value" style="color: #9b59b6;" id="review-tasks">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">å·²å®Œæˆ</div>
                <div class="stat-value" style="color: #2ecc71;" id="done-tasks">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">å»¶è¿Ÿä»»åŠ¡</div>
                <div class="stat-value" style="color: #f39c12;" id="deferred-tasks">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">é¢„è®¡æ—¶é—´</div>
                <div class="stat-value" style="color: #95a5a6;">5-6æœˆ</div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchView('kanban')">ğŸ“‹ çœ‹æ¿è§†å›¾</button>
        <button class="tab" onclick="switchView('timeline')">ğŸ“… æ—¶é—´çº¿</button>
        <button class="tab" onclick="switchView('graph')">ğŸ”— ä¾èµ–å›¾</button>
        <button class="tab" onclick="switchView('risk')">âš ï¸ é£é™©çŸ©é˜µ</button>
        <button class="tab" onclick="switchView('deferred')">â¸ï¸ å»¶è¿Ÿä»»åŠ¡</button>
    </div>

    <div id="kanban-view" class="view active">
        <div class="kanban" id="kanban-board"></div>
    </div>

    <div id="timeline-view" class="view">
        <div class="timeline" id="timeline-content"></div>
    </div>

    <div id="graph-view" class="view">
        <div class="graph-container">
            <h2>ä»»åŠ¡ä¾èµ–å…³ç³»å›¾</h2>
            <div id="dependency-graph"></div>
        </div>
    </div>

    <div id="risk-view" class="view">
        <div class="risk-matrix">
            <h2>é£é™©åˆ†å¸ƒçŸ©é˜µ</h2>
            <div class="risk-grid" id="risk-grid"></div>
        </div>
    </div>

    <div id="deferred-view" class="view">
        <div class="deferred-section" id="deferred-content"></div>
    </div>

    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <div id="modal-title"></div>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let projectState = null;

        // Load project state
        async function loadProjectState() {
            try {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetch(`state/project_state.json?v=${timestamp}`);
                projectState = await response.json();
                console.log(`Loaded ${projectState.tasks.length} tasks from project_state.json`);
                renderDashboard();
            } catch (error) {
                console.error('Failed to load project state:', error);
                document.body.innerHTML = '<div class="loading">âŒ æ— æ³•åŠ è½½é¡¹ç›®æ•°æ®ã€‚è¯·ç¡®ä¿ state/project_state.json æ–‡ä»¶å­˜åœ¨ã€‚</div>';
            }
        }

        function renderDashboard() {
            updateStats();
            renderKanban();
            renderTimeline();
            renderRiskMatrix();
            renderDeferred();
        }

        function updateStats() {
            const tasks = projectState.tasks || [];
            const pending = tasks.filter(t => t.status === 'pending').length;
            const inReview = tasks.filter(t => t.status === 'in_review').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const done = tasks.filter(t => t.status === 'done').length;
            const deferred = tasks.filter(t => t.status === 'deferred').length;

            document.getElementById('total-tasks').textContent = tasks.length;
            document.getElementById('pending-tasks').textContent = pending;
            document.getElementById('review-tasks').textContent = inReview + inProgress;
            document.getElementById('done-tasks').textContent = done;
            document.getElementById('deferred-tasks').textContent = deferred;
        }

        function renderKanban() {
            const board = document.getElementById('kanban-board');
            const tasks = projectState.tasks || [];

            // FE unified ID grouping
            const phases = {
                'Phase 0: åŸºç¡€è®¾æ–½': tasks.filter(t => t.id.match(/^FE-00/)),
                'Phase 1: ä»£ç ç§»æ¤': tasks.filter(t => t.id.match(/^FE-1\d/) && t.status !== 'deferred'),
                'Phase 2: SCFç®—æ³•': tasks.filter(t => t.id.match(/^FE-2\d/)),
                'Phase 3: éªŒè¯': tasks.filter(t => t.id.match(/^FE-3\d/)),
                'Phase 4: è‡ªåŠ¨åŒ–': tasks.filter(t => t.id.match(/^FE-4\d/)),
                'å»¶è¿Ÿä»»åŠ¡': tasks.filter(t => t.status === 'deferred')
            };

            board.innerHTML = '';
            for (const [phase, phaseTasks] of Object.entries(phases)) {
                const column = document.createElement('div');
                column.className = 'column';
                column.innerHTML = `
                    <div class="column-header">
                        <span>${phase}</span>
                        <span class="column-count">${phaseTasks.length}</span>
                    </div>
                `;

                phaseTasks.forEach(task => {
                    const card = createTaskCard(task);
                    column.appendChild(card);
                });

                board.appendChild(column);
            }
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card risk-${task.risk_level || 'low'}`;
            card.onclick = () => showTaskDetails(task);

            const statusEmoji = {
                'pending': 'â³',
                'in_progress': 'ğŸ”„',
                'in_review': 'ğŸ”',
                'done': 'âœ…',
                'failed': 'âŒ',
                'deferred': 'â¸ï¸'
            }[task.status] || 'ğŸ“';

            card.innerHTML = `
                <div class="task-id">${statusEmoji} ${task.id}</div>
                <div class="task-title">${task.title}</div>
                <div class="task-meta">
                    <span class="badge layer">${task.layer}</span>
                    ${task.risk_level ? `<span class="badge risk">${task.risk_level}</span>` : ''}
                    ${task.defer_trigger ? '<span class="badge">ğŸ”” æœ‰è§¦å‘æ¡ä»¶</span>' : ''}
                </div>
            `;

            return card;
        }

        function renderTimeline() {
            const content = document.getElementById('timeline-content');
            const tasks = projectState.tasks || [];

            const phases = [
                { name: 'Phase 0: åŸºç¡€è®¾æ–½ä¸è°ƒç ”', filter: t => t.id.match(/^FE-00/) },
                { name: 'Phase 1: ä»£ç ç§»æ¤ zdy-tmp â†’ develop', filter: t => t.id.match(/^FE-1\d/) },
                { name: 'Phase 2: SCF æ”¶æ•›ç®—æ³•æ”¹è¿›', filter: t => t.id.match(/^FE-2\d/) },
                { name: 'Phase 3: éªŒè¯ä¸ç”¨æˆ·åœºæ™¯', filter: t => t.id.match(/^FE-3\d/) },
                { name: 'Phase 4: ç”Ÿäº§å°±ç»ªè‡ªåŠ¨åŒ–', filter: t => t.id.match(/^FE-4\d/) }
            ];

            content.innerHTML = '';
            phases.forEach(phase => {
                const phaseTasks = tasks.filter(t => phase.filter(t) && t.status !== 'deferred');
                if (phaseTasks.length === 0) return;

                const section = document.createElement('div');
                section.className = 'phase-section';
                section.innerHTML = `<div class="phase-header">${phase.name} (${phaseTasks.length}ä¸ªä»»åŠ¡)</div>`;

                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'phase-tasks';
                phaseTasks.forEach(task => {
                    tasksContainer.appendChild(createTaskCard(task));
                });

                section.appendChild(tasksContainer);
                content.appendChild(section);
            });
        }

        function renderRiskMatrix() {
            const grid = document.getElementById('risk-grid');
            const tasks = projectState.tasks || [];

            const riskCounts = {
                low: tasks.filter(t => t.risk_level === 'low' || !t.risk_level).length,
                medium: tasks.filter(t => t.risk_level === 'medium').length,
                high: tasks.filter(t => t.risk_level === 'high').length
            };

            grid.innerHTML = `
                <div class="risk-category low">
                    <h3>ğŸŸ¢ ä½é£é™©</h3>
                    <div class="risk-count">${riskCounts.low}</div>
                    <p>å¯ç«‹å³æ‰§è¡Œ</p>
                </div>
                <div class="risk-category medium">
                    <h3>ğŸŸ¡ ä¸­é£é™©</h3>
                    <div class="risk-count">${riskCounts.medium}</div>
                    <p>éœ€è¦éªŒè¯</p>
                </div>
                <div class="risk-category high">
                    <h3>ğŸ”´ é«˜é£é™©</h3>
                    <div class="risk-count">${riskCounts.high}</div>
                    <p>å·²å»¶è¿Ÿ</p>
                </div>
            `;
        }

        function renderDeferred() {
            const content = document.getElementById('deferred-content');
            const tasks = projectState.tasks || [];
            const deferred = tasks.filter(t => t.status === 'deferred');

            content.innerHTML = '<h2>â¸ï¸ å»¶è¿Ÿä»»åŠ¡åŠè§¦å‘æ¡ä»¶</h2>';

            if (deferred.length === 0) {
                content.innerHTML += '<p style="text-align: center; padding: 40px; color: #7f8c8d;">æš‚æ— å»¶è¿Ÿä»»åŠ¡</p>';
                return;
            }

            deferred.forEach(task => {
                const card = document.createElement('div');
                card.className = 'deferred-card';
                card.innerHTML = `
                    <div class="task-id">${task.id}</div>
                    <div class="task-title" style="font-size: 16px; margin: 10px 0;">${task.title}</div>
                    <div class="task-meta">
                        <span class="badge risk">${task.risk_level}</span>
                        <span class="badge layer">${task.layer}</span>
                    </div>
                    ${task.defer_trigger ? `
                        <div class="trigger-info">
                            <div class="trigger-label">ğŸ”” è§¦å‘æ¡ä»¶:</div>
                            <div>${task.defer_trigger}</div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px; font-size: 13px; color: #7f8c8d;">
                        ${task.description}
                    </div>
                `;
                card.onclick = () => showTaskDetails(task);
                content.appendChild(card);
            });
        }

        function showTaskDetails(task) {
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.innerHTML = `${task.id}: ${task.title}`;

            const deps = task.dependencies || [];
            const criteria = task.acceptance_criteria || [];
            const files = task.files_to_touch || [];

            body.innerHTML = `
                <div class="modal-section">
                    <h4>æè¿°</h4>
                    <p>${task.description}</p>
                </div>

                <div class="modal-section">
                    <h4>å…ƒæ•°æ®</h4>
                    <p><strong>çŠ¶æ€:</strong> ${{
                        'pending': 'â³ å¾…æ‰§è¡Œ',
                        'in_progress': 'ğŸ”„ è¿›è¡Œä¸­',
                        'in_review': 'ğŸ” å®¡æ ¸ä¸­',
                        'done': 'âœ… å·²å®Œæˆ',
                        'deferred': 'â¸ï¸ å·²å»¶è¿Ÿ'
                    }[task.status] || task.status}</p>
                    <p><strong>å±‚çº§:</strong> ${task.layer}</p>
                    <p><strong>ç±»å‹:</strong> ${task.type}</p>
                    <p><strong>é£é™©:</strong> ${task.risk_level || 'low'}</p>
                    <p><strong>è´Ÿè´£äºº:</strong> ${task.specialist}</p>
                </div>

                ${task.defer_trigger ? `
                    <div class="modal-section">
                        <h4>è§¦å‘æ¡ä»¶</h4>
                        <p style="background: #fff3cd; padding: 10px; border-radius: 4px;">
                            ${task.defer_trigger}
                        </p>
                    </div>
                ` : ''}

                ${deps.length > 0 ? `
                    <div class="modal-section">
                        <h4>ä¾èµ–ä»»åŠ¡ (${deps.length})</h4>
                        <ul class="dependency-list">
                            ${deps.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${criteria.length > 0 ? `
                    <div class="modal-section">
                        <h4>éªŒæ”¶æ ‡å‡†</h4>
                        <ul>
                            ${criteria.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${files.length > 0 ? `
                    <div class="modal-section">
                        <h4>æ¶‰åŠæ–‡ä»¶</h4>
                        <ul>
                            ${files.map(f => `<li><code>${f}</code></li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('task-modal').classList.remove('active');
        }

        function switchView(viewName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
        }

        // Close modal on outside click
        document.getElementById('task-modal').addEventListener('click', (e) => {
            if (e.target.id === 'task-modal') {
                closeModal();
            }
        });

        // Load data on page load
        loadProjectState();
    </script>
</body>
</html>
