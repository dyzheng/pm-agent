{
  "revision_note": "2026-02-12: 重新评估后大幅精简。force/stress/mixing_dftu/oscillation detection 已在 develop 中存在，无需移植。原 14-PR 计划缩减为 7 PR。",
  "phase0_tasks": [
    {
      "id": "PR-1",
      "title": "onsite_projector nspin=1/2 支持",
      "layer": "infra",
      "type": "extend",
      "description": "扩展 develop 的 onsite_projector 支持 nspin=1/2。",
      "dependencies": [],
      "status": "code_committed_unverified",
      "commit": "d2364165c",
      "task_instruction": "tasks/PR-1-task-instruction.md",
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port"
    },
    {
      "id": "PR-2",
      "title": "DFT+U PW SCF nspin=1/2/4 全支持",
      "layer": "infra",
      "type": "extend",
      "description": "将 zdy-tmp 的 cal_occ_pw() nspin=1/2 支持移植到 develop，使 DFT+U PW SCF 支持 nspin=1/2/4。包含占据矩阵计算、能量/有效势、initialed_locale 守卫、uom_array 机制。吸收了原 PR-2（nspin=4）和原 PR-3（nspin=1/2 扩展）。",
      "dependencies": ["PR-1"],
      "status": "wip_uncommitted",
      "task_instruction": "tasks/PR-2-task-instruction.md",
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port"
    },
    {
      "id": "PR-3",
      "title": "DeltaSpin 缺失文件移植",
      "layer": "infra",
      "type": "port",
      "description": "移植 zdy-tmp 中 3 个 DeltaSpin 文件到 develop：cal_h_lambda.cpp、cal_mw_helper.cpp、sc_parse_json.cpp，以及对应的 3 个测试文件。",
      "dependencies": [],
      "status": "pending",
      "task_instruction": "tasks/PR-3-task-instruction.md",
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port"
    },
    {
      "id": "PR-4",
      "title": "DeltaSpin PW 集成",
      "layer": "infra",
      "type": "extend",
      "description": "在 esolver_ks_pw.cpp 中集成 DeltaSpin PW 调用（cal_mi_pw），使 PW 基组下 DeltaSpin 功能完整。",
      "dependencies": ["PR-1", "PR-3"],
      "status": "pending",
      "task_instruction": null,
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port"
    },
    {
      "id": "PR-5",
      "title": "DeltaSpin + DFT+U 联合计算",
      "layer": "infra",
      "type": "extend",
      "description": "支持 DeltaSpin 和 DFT+U 同时使用，添加 conserve_setting 参数。",
      "dependencies": ["PR-2", "PR-3"],
      "status": "pending",
      "task_instruction": null,
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port",
      "reference_code": "zdy-tmp commit: a9d881c95"
    },
    {
      "id": "PR-6",
      "title": "GPU DFT+U kernels",
      "layer": "infra",
      "type": "new",
      "description": "实现 DFT+U force/stress 的 GPU/CUDA kernel。当前两个代码库都只有 CPU 实现和 GPU 声明，缺少 .cu 实现。",
      "dependencies": ["PR-2"],
      "status": "pending",
      "task_instruction": null,
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port"
    },
    {
      "id": "PR-7",
      "title": "mixing_restart 与 mixing_dftu 协同修复",
      "layer": "algorithm",
      "type": "fix",
      "description": "修复 mixing_restart 与 mixing_dftu 的兼容性问题，包括 kpar > 1 时的正确性。需要对比 zdy-tmp 和 develop 的 charge_mixing.cpp 确认是否仍有差异。",
      "dependencies": ["PR-2"],
      "status": "pending",
      "task_instruction": null,
      "worktree": "/root/abacus-dftu-pw-port",
      "branch": "feat/dftu-pw-port",
      "reference_code": "zdy-tmp commits: 96f72ca00, caf450953",
      "note": "需要先确认 develop 是否已包含此修复"
    }
  ],
  "cancelled_tasks": [
    {
      "original_id": "PR-3 (old)",
      "title": "DFT+U PW nspin=1/2 扩展",
      "reason": "吸收进新 PR-2"
    },
    {
      "original_id": "PR-4 (old)",
      "title": "DFT+U PW force",
      "reason": "develop 已有完整实现，无需移植"
    },
    {
      "original_id": "PR-5 (old)",
      "title": "DFT+U PW stress",
      "reason": "develop 已有完整实现，无需移植"
    },
    {
      "original_id": "PR-6 (old)",
      "title": "mixing_dftu（占据矩阵 mixing）",
      "reason": "develop 已有 mixing_dftu 参数和 mix_uom/allocate_mixing_uom 基础设施"
    },
    {
      "original_id": "PR-8 (old)",
      "title": "module_deltaspin 核心移植",
      "reason": "develop 已有大部分文件，缩减为新 PR-3（仅移植 3 个缺失文件）"
    },
    {
      "original_id": "PR-9 (old)",
      "title": "DeltaSpin LCAO 算符更新",
      "reason": "需要重新评估 develop 中 dspin_lcao 的完整度"
    },
    {
      "original_id": "PR-10 (old)",
      "title": "DeltaSpin PW 支持",
      "reason": "缩减为新 PR-4（仅补 esolver_ks_pw 中的 cal_mi_pw 调用）"
    },
    {
      "original_id": "PR-11 (old)",
      "title": "DeltaSpin force/stress",
      "reason": "develop 已有完整实现，无需移植"
    },
    {
      "original_id": "PR-13 (old)",
      "title": "SCF 震荡检测 + 自动回退",
      "reason": "develop 已有 oscillate_esolver 和 if_scf_oscillate 基础设施"
    }
  ],
  "execution_plan": {
    "parallel_opportunities": [
      "PR-1 || PR-3 (无依赖关系)",
      "PR-4 || PR-2 (PR-4 依赖 PR-1+PR-3, PR-2 依赖 PR-1, 互不依赖)"
    ],
    "critical_path": "PR-1 → PR-2 → PR-5",
    "worktree": "/root/abacus-dftu-pw-port",
    "base_branch": "origin/develop (c039e9275)"
  },
  "phase1_tasks": "保持不变，见原文件",
  "phase2_tasks": "保持不变，见原文件"
}
