{
  "task_id": "FE-100",
  "title": "稀土NC赝势生成（Ce, Gd, Nd, Sm, Eu, Tb, La）",
  "specialist": "algorithm_agent",

  "goal": "为7种优先稀土元素生成f_in_valence模守恒赝势，通过ghost state检测和基本可迁移性检查，输出ABACUS可用的UPF文件。",

  "context": {
    "problem": "现有赝势库对稀土f_in_valence覆盖不完整。PseudoDojo可能有部分元素，但需要逐一验证。对于缺失的元素，必须用ONCVPSP自行生成。",
    "key_challenge": "f通道赝势生成的核心难点：(1) 4f轨道极度局域，截断半径太小会产生ghost state，太大会损失可迁移性；(2) 参考构型选择影响赝势在不同氧化态下的表现；(3) 需要同时处理4f/5s/5p/5d/6s多个壳层，通道间正交性约束复杂。"
  },

  "elements": {
    "La": {
      "Z": 57,
      "ground_state": "[Xe] 5d1 6s2",
      "f_electrons": 0,
      "valence_config": "5s2 5p6 5d1 6s2",
      "notes": "无4f电子，最简单的稀土。但赝势需要包含空的4f通道以支持DFT+U。",
      "reference_configs": ["[Xe]5d1 6s2", "[Xe]5d2 6s1"],
      "expected_difficulty": "LOW"
    },
    "Ce": {
      "Z": 58,
      "ground_state": "[Xe] 4f1 5d1 6s2",
      "f_electrons": 1,
      "valence_config": "4f1 5s2 5p6 5d1 6s2",
      "notes": "最重要的测试元素。Ce4+(f^0)和Ce3+(f^1)两种氧化态都很常见。赝势必须在两种氧化态下都可迁移。",
      "reference_configs": ["[Xe]4f1 5d1 6s2", "[Xe]4f0 5d2 6s2", "[Xe]4f1 5d0 6s2 6p1"],
      "expected_difficulty": "HIGH"
    },
    "Nd": {
      "Z": 60,
      "ground_state": "[Xe] 4f4 6s2",
      "f_electrons": 4,
      "valence_config": "4f4 5s2 5p6 6s2",
      "notes": "NdFeB永磁体的关键元素。Nd3+(f^3)是主要氧化态。",
      "reference_configs": ["[Xe]4f4 6s2", "[Xe]4f3 5d1 6s2"],
      "expected_difficulty": "HIGH"
    },
    "Sm": {
      "Z": 62,
      "ground_state": "[Xe] 4f6 6s2",
      "f_electrons": 6,
      "valence_config": "4f6 5s2 5p6 6s2",
      "notes": "SmCo5永磁体。Sm3+(f^5)和Sm2+(f^6)。半满f壳层附近，多重态密集。",
      "reference_configs": ["[Xe]4f6 6s2", "[Xe]4f5 5d1 6s2"],
      "expected_difficulty": "VERY HIGH"
    },
    "Eu": {
      "Z": 63,
      "ground_state": "[Xe] 4f7 6s2",
      "f_electrons": 7,
      "valence_config": "4f7 5s2 5p6 6s2",
      "notes": "半满f壳层（f^7），磁矩最大。Eu2+(f^7)和Eu3+(f^6)混合价态常见。EuO是模型磁性半导体。",
      "reference_configs": ["[Xe]4f7 6s2", "[Xe]4f6 5d1 6s2"],
      "expected_difficulty": "VERY HIGH"
    },
    "Gd": {
      "Z": 64,
      "ground_state": "[Xe] 4f7 5d1 6s2",
      "f_electrons": 7,
      "valence_config": "4f7 5s2 5p6 5d1 6s2",
      "notes": "半满f壳层+1个d电子。Gd3+(f^7)非常稳定。GdN是重要的磁性化合物。与Eu同为f^7但化学性质不同。",
      "reference_configs": ["[Xe]4f7 5d1 6s2", "[Xe]4f7 5d0 6s2 6p1"],
      "expected_difficulty": "HIGH"
    },
    "Tb": {
      "Z": 65,
      "ground_state": "[Xe] 4f9 6s2",
      "f_electrons": 9,
      "valence_config": "4f9 5s2 5p6 6s2",
      "notes": "Tb3+(f^8)和Tb4+(f^7)。TbMnO3多铁性材料。超过半满的f壳层。",
      "reference_configs": ["[Xe]4f9 6s2", "[Xe]4f8 5d1 6s2"],
      "expected_difficulty": "HIGH"
    }
  },

  "oncvpsp_input_template": {
    "description": "ONCVPSP输入文件模板（以Ce为例）",
    "template_lines": [
      "# Ce f_in_valence NC pseudopotential",
      "# atsym  z  nc  nv  iexc  psfile",
      "  Ce  58  5  5  4  upf",
      "#",
      "# n  l  f  (reference configuration)",
      "  5  0  2.0    # 5s",
      "  5  1  6.0    # 5p",
      "  4  2  0.0    # 4f (as l=2 placeholder — actual f is l=3)",
      "  5  2  1.0    # 5d",
      "  6  0  2.0    # 6s",
      "#",
      "# NOTE: ONCVPSP uses sequential l values. For f_in_valence,",
      "# the 4f channel must be explicitly included with l=3.",
      "# The exact input format depends on ONCVPSP version.",
      "#",
      "# lmax",
      "  3",
      "#",
      "# l  rc  ep  ncon  nbas  qcut",
      "  0  2.20  0.0  4  8  5.0    # s channel",
      "  1  2.30  0.0  4  8  5.5    # p channel",
      "  2  2.50  0.0  4  8  5.0    # d channel",
      "  3  1.80  0.0  4  8  7.0    # f channel — small rc, high qcut"
    ],
    "critical_parameters": {
      "rc_f": "f通道截断半径。典型范围1.5-2.0 au。太小→硬赝势需要高ecutwfc，太大→ghost state风险。建议从1.8开始，根据对数导数测试调整。",
      "qcut_f": "f通道动量截断。需要较高值（6-8）以准确描述局域化f轨道。",
      "reference_energy_f": "f通道参考能量ep。设为0.0（自动选择）或手动设为接近4f能级的值。",
      "nc": "冻芯层数。对Ce：nc=5表示冻结1s-4d（即[Kr]4d10），价电子从5s开始。"
    }
  },

  "ghost_state_detection": {
    "method": "对数导数测试",
    "procedure": [
      "1. 用ONCVPSP生成赝势后，检查输出中的对数导数图",
      "2. 对每个l通道，比较赝势对数导数与全电子对数导数",
      "3. 在能量范围[-2, 2] Ry内，两者应该一致（无额外零点）",
      "4. 额外零点 = ghost state，必须调整rc或参考构型消除",
      "5. 特别注意f通道：ghost state最容易出现在这里"
    ],
    "automated_check": "ONCVPSP输出文件中搜索'GHOST'关键字。如果出现，该赝势不可用。"
  },

  "acceptance_criteria": [
    "7种元素各至少1个UPF赝势文件",
    "所有赝势通过ghost state检测（ONCVPSP输出无GHOST警告）",
    "所有赝势可被ABACUS正确读取（lmax=3, f通道信息正确）",
    "对数导数图存档（用于后续分析）",
    "每个赝势的ONCVPSP输入文件存档（可复现）"
  ],

  "output_directory": "projects/f-electron-scf/data/pseudopotentials/",

  "scope_guard": [
    "质量验证（晶格常数等）是FE-101的任务，这里只做ghost state检测",
    "如果PseudoDojo已有高质量赝势，直接采用，不重新生成",
    "对于VERY HIGH难度的元素（Sm, Eu），如果多次尝试仍有ghost state，记录问题并标记为需要进一步研究"
  ]
}
