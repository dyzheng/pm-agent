{
  "task_id": "FE-201",
  "title": "分通道mixing_beta实现",
  "specialist": "algorithm_agent",
  "repo": "/root/abacus-develop",

  "goal": "在ABACUS的charge mixing中实现按角动量通道分别设置mixing_beta的能力，使f电子通道使用更保守的更新步长，避免SCF震荡。",

  "context": {
    "problem": "f电子极度局域化，其电荷密度对mixing步长极其敏感。统一的mixing_beta对s/p/d通道可能合适（0.3-0.7），但对f通道太激进，导致电荷震荡。需要对f通道使用更小的mixing_beta（0.05-0.1）。",
    "current_code": "charge_mixing_rho.cpp处理实空间电荷密度mixing（PW基组），charge_mixing_dmr.cpp处理密度矩阵mixing（LCAO基组）。两者都使用统一的mixing_beta。",
    "approach_lcao": "LCAO基组天然按轨道分解——密度矩阵元素D_{μν}中μ和ν对应特定的原子轨道（含l量子数）。可以在mixing_dmr中对涉及f轨道的矩阵元素使用更小的mixing_beta。",
    "approach_pw": "PW基组的电荷密度在实空间/倒空间，没有直接的角动量分解。需要先投影到原子轨道分量，分别mixing后再合成。这比较复杂，初始版本可以只支持LCAO。"
  },

  "deliverables": [
    {
      "action": "modify",
      "path": "source/source_estate/module_charge/charge_mixing.h",
      "spec": "添加成员：\n1. std::vector<double> mixing_beta_per_l — 按l通道的mixing_beta，长度=lmax+1\n2. bool mixing_beta_channel = false — 是否启用分通道mixing\n3. 方法：double get_mixing_beta_for_orbital(int l) — 返回指定l通道的mixing_beta"
    },
    {
      "action": "modify",
      "path": "source/source_estate/module_charge/charge_mixing_dmr.cpp",
      "spec": "在LCAO密度矩阵mixing中：\n1. 遍历密度矩阵元素D_{μν}时，查询μ和ν对应的l量子数\n2. 取两者中较大的l作为该矩阵元素的有效l\n3. 使用get_mixing_beta_for_orbital(l_eff)作为该元素的mixing_beta\n4. 如果mixing_beta_channel=false，回退到统一mixing_beta（保持向后兼容）"
    },
    {
      "action": "modify",
      "path": "source/source_io/module_parameter/input_parameter.h",
      "spec": "添加：\n1. bool mixing_beta_channel = false\n2. double mixing_beta_f = -1.0 — f通道mixing_beta，-1表示使用全局值\n3. double mixing_beta_d = -1.0 — d通道mixing_beta（可选）"
    },
    {
      "action": "modify",
      "path": "source/source_io/module_parameter/read_input_item_system.cpp",
      "spec": "添加mixing_beta_channel, mixing_beta_f, mixing_beta_d的读取逻辑。当mixing_beta_f > 0时自动启用mixing_beta_channel。"
    }
  ],

  "test_plan": [
    "单元测试：get_mixing_beta_for_orbital()对l=0,1,2,3返回正确值",
    "集成测试：CeO2 LCAO with mixing_beta_f=0.05，SCF收敛步数减少",
    "回归测试：mixing_beta_channel=false时行为完全不变",
    "对比测试：分通道mixing vs 统一小mixing_beta，验证分通道更高效"
  ],

  "acceptance_criteria": [
    "LCAO基组下分通道mixing正常工作",
    "CeO2 DFT+U的SCF收敛性改善（步数减少或成功率提升）",
    "不影响PW基组计算（PW下自动忽略分通道设置）",
    "不影响无f电子体系的计算"
  ],

  "scope_guard": [
    "初始版本只支持LCAO基组的密度矩阵mixing",
    "PW基组的分通道mixing留作后续工作",
    "不修改Broyden/Pulay mixing算法本身，只修改输入的mixing_beta"
  ]
}
