{
  "task_id": "FE-302",
  "title": "AI模型与ABACUS接口集成",
  "specialist": "infra_agent",

  "goal": "将训练好的AI占据矩阵预测模型集成到ABACUS计算工作流中，实现结构文件→模型推理→initial_onsite.dm→SCF收敛的端到端自动化。",

  "integration_approaches": [
    {
      "name": "方案A：预处理脚本（短期，推荐）",
      "description": "独立Python脚本，在ABACUS计算前运行",
      "workflow": "STRU → predict_occup.py → initial_onsite.dm → ABACUS (omc=1)",
      "pros": ["零C++改动", "易于调试和更新模型", "可独立于ABACUS版本"],
      "cons": ["需要用户手动运行或通过wrapper脚本"],
      "implementation": [
        "1. predict_occup.py：读取STRU文件，提取结构信息",
        "2. 用ASE计算近邻环境特征",
        "3. 加载模型（pickle/ONNX），推理得到占据矩阵",
        "4. 按ABACUS的initial_onsite.dm格式输出",
        "5. 设置INPUT中omc=1"
      ]
    },
    {
      "name": "方案B：PyABACUS集成（中期）",
      "description": "通过PyABACUS的Python接口注入初始占据矩阵",
      "workflow": "Python script → model.predict() → pyabacus.set_occup_matrix() → SCF",
      "pros": ["无缝集成", "可在Python层面做更复杂的逻辑"],
      "cons": ["依赖PyABACUS接口完善度", "需要PB-100等任务先完成"],
      "implementation": [
        "1. 在PyABACUS中暴露set_initial_occup_matrix() API",
        "2. 在LCAOWorkflow中添加from_ai_guess()工厂方法",
        "3. 内部调用模型推理+设置占据矩阵"
      ]
    },
    {
      "name": "方案C：ABACUS原生集成（长期）",
      "description": "在ABACUS C++中嵌入模型推理",
      "workflow": "ABACUS读取STRU → 调用嵌入的模型 → 设置占据矩阵 → SCF",
      "pros": ["用户完全透明", "init_chg='ai'一个参数搞定"],
      "cons": ["C++中嵌入ML推理复杂", "模型更新需要重新编译"],
      "implementation": [
        "1. 用ONNX Runtime C++ API加载模型",
        "2. 在dftu.cpp的初始化流程中添加AI推理分支",
        "3. 新增init_chg='ai'选项"
      ]
    }
  ],

  "initial_onsite_dm_format": {
    "description": "ABACUS的initial_onsite.dm文件格式（从dftu_io.cpp分析）",
    "format": "文本文件，按原子和自旋通道排列的占据矩阵元素",
    "notes": "具体格式需要从FE-002的代码审计中确认"
  },

  "deliverables": [
    "predict_occup.py脚本（方案A）",
    "run_with_ai_guess.sh wrapper脚本",
    "模型文件（pickle或ONNX格式）",
    "使用文档（如何配置和运行）"
  ],

  "acceptance_criteria": [
    "端到端工作流可运行：STRU → AI预测 → initial_onsite.dm → ABACUS SCF收敛",
    "在CeO2/GdN测试体系上，AI初猜的SCF步数少于atomic初猜",
    "脚本有清晰的错误处理（模型文件缺失、不支持的元素等）"
  ]
}
