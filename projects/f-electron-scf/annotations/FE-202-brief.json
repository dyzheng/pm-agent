{
  "task_id": "FE-202",
  "title": "占据矩阵随机初始化 + 多起点探索",
  "specialist": "algorithm_agent",
  "repo": "/root/abacus-develop",

  "goal": "在ABACUS DFT+U中实现占据矩阵的随机初始化和多起点探索策略，使f电子体系能系统搜索多个SCF极小值并选择真正的基态。",

  "context": {
    "problem": "稀土f电子体系的DFT+U计算存在多个SCF局域极小值（不同的f电子占据模式），能量差可达0.1-1.0 eV。当前ABACUS只支持从固定初始猜测（atomic或omc文件）出发，无法探索其他极小值。用户无法知道是否收敛到了真正的基态。",
    "current_omc": "omc=0(不控制), omc=1(从initial_onsite.dm读取初始占据矩阵并在第一步后释放), omc=2(持续约束到initial_onsite.dm的值)",
    "approach": "扩展omc机制：(1) 新增随机初始化模式，(2) 新增基于化学直觉的初始化，(3) 实现多起点并行探索的外层调度"
  },

  "deliverables": [
    {
      "action": "modify",
      "path": "source/source_lcao/module_dftu/dftu.h",
      "spec": "在DFTU类中添加：\n1. 随机初始化方法声明：void init_occup_random(int seed)\n2. 化学直觉初始化方法：void init_occup_by_oxidation_state()\n3. 新成员变量：int omc_random_seed, int omc_nstart, bool omc_random_enabled\n4. 多起点结果存储：std::vector<double> multistart_energies, std::vector<占据矩阵类型> multistart_occup"
    },
    {
      "action": "modify",
      "path": "source/source_lcao/module_dftu/dftu.cpp",
      "spec": "实现随机初始化逻辑：\n1. init_occup_random(seed)：对每个DFT+U原子，生成随机占据矩阵。约束条件：(a) 占据数之和等于该原子的f电子数（由赝势决定），(b) 每个轨道占据数在[0,1]范围内，(c) 占据矩阵是Hermitian的。实现方式：随机生成对角占据数（满足约束），然后用随机酉变换旋转。\n2. init_occup_by_oxidation_state()：根据元素和化学环境预设f电子数。内置表：Ce4+(f^0), Ce3+(f^1), Gd3+(f^7), Eu2+(f^7), Eu3+(f^6), Nd3+(f^3), Sm3+(f^5), Tb3+(f^8), La3+(f^0)。氧化态从STRU文件的电荷标注或自动推断（基于配位环境）。\n3. 在现有omc初始化流程中添加分支：omc=3(随机), omc=4(化学直觉)"
    },
    {
      "action": "modify",
      "path": "source/source_lcao/module_dftu/dftu_io.cpp",
      "spec": "添加多起点结果的I/O：\n1. 输出每次起点的最终能量和占据矩阵到onsite_occup_multistart.dat\n2. 输出最优起点的占据矩阵为initial_onsite.dm（可用于后续计算的初始猜测）"
    },
    {
      "action": "modify",
      "path": "source/source_io/module_parameter/read_input_item_exx_dftu.cpp",
      "spec": "添加新输入参数：\n1. omc_random (int, default 0)：0=关闭, 1=随机初始化\n2. omc_nstart (int, default 1)：多起点探索的起点数\n3. omc_seed (int, default -1)：随机种子，-1=使用时间戳\n4. omc_oxidation (int, default 0)：0=关闭, 1=启用化学直觉初始化"
    },
    {
      "action": "modify",
      "path": "source/source_io/module_parameter/input_parameter.h",
      "spec": "在Input_para结构体中添加对应成员变量"
    }
  ],

  "implementation_notes": {
    "random_occup_algorithm": "对于l=3的f轨道，占据矩阵是(2l+1)x(2l+1)=7x7的Hermitian矩阵。随机生成步骤：(1) 生成7个随机占据数n_i ∈ [0,1]，归一化使sum(n_i)=N_f（目标f电子数），(2) 构造对角矩阵D=diag(n_1,...,n_7)，(3) 生成随机酉矩阵U（QR分解随机矩阵），(4) 占据矩阵 = U^† D U。对于自旋极化(nspin=2)，分别对spin-up和spin-down生成，约束总f电子数。",
    "multistart_strategy": "多起点探索的外层调度不在C++中实现（太重），而是：(1) C++层面只实现单次随机初始化，(2) 多起点通过Python脚本或abacustest调度多次计算，(3) 每次计算用不同seed，(4) 最后比较能量选最低。这样避免大规模C++改动。",
    "oxidation_state_table": "内置一个简单的查找表，key=(element, coordination_number)，value=most_likely_oxidation_state。对于无法自动判断的情况，回退到中性原子构型。"
  },

  "test_plan": [
    "单元测试：随机占据矩阵满足约束条件（Hermitian、迹=N_f、本征值∈[0,1]）",
    "单元测试：化学直觉初始化对Ce/Gd/Eu给出正确的f电子数",
    "集成测试：CeO2 DFT+U with omc=3, 不同seed给出不同初始占据但都能收敛",
    "集成测试：多起点（5个seed）中最低能量与VASP参考一致"
  ],

  "acceptance_criteria": [
    "omc=3(随机)模式可正常运行，不crash",
    "omc=4(化学直觉)对CeO2正确初始化Ce为f^0(Ce4+)",
    "多起点探索（通过外部脚本）能找到CeO2 DFT+U的正确基态",
    "不影响现有omc=0/1/2的行为（回归测试通过）"
  ],

  "scope_guard": [
    "多起点的外层调度用Python脚本实现，不在C++中做循环",
    "不修改SCF主循环逻辑",
    "不修改DFT+U哈密顿量构造",
    "化学直觉表只覆盖7种优先元素，其他元素回退到默认"
  ]
}
