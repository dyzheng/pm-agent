{
  "task_id": "FE-204",
  "title": "能量监控 + SCF自动回退机制",
  "specialist": "algorithm_agent",
  "repo": "/root/abacus-develop",

  "goal": "在SCF主循环中实现能量监控和自动回退机制：当检测到能量上升或震荡时，自动调整mixing参数并回退到上一个低能量状态，避免SCF发散。",

  "context": {
    "problem": "f电子体系的SCF经常出现：(1) 能量单调上升（mixing太激进），(2) 能量周期性震荡（在两个电子态之间跳跃），(3) 能量缓慢震荡衰减但不收敛（mixing策略不匹配）。当前ABACUS没有自动检测和应对这些情况的机制。",
    "current_scf": "SCF主循环在source/source_pw/module_pwdft/esolver_ks_pw.cpp和source/source_lcao/esolver_ks_lcao.cpp中。每步计算总能量并检查收敛（drho < scf_thr）。不收敛时简单继续迭代直到nscf_max。",
    "approach": "在charge_mixing层面实现监控和回退，不修改SCF主循环结构。charge_mixing已经在每步被调用，可以在其中添加能量历史分析和参数自适应逻辑。"
  },

  "deliverables": [
    {
      "action": "modify",
      "path": "source/source_estate/module_charge/charge_mixing.h",
      "spec": "添加成员：\n1. std::vector<double> energy_history — 最近N步的总能量\n2. std::vector<double> drho_history — 最近N步的电荷残差\n3. int history_size = 10 — 历史窗口大小\n4. bool auto_recover = false — 是否启用自动回退\n5. int recover_count = 0 — 已回退次数\n6. int max_recover = 3 — 最大回退次数\n7. 保存的电荷密度快照（用于回退）\n8. 方法：enum SCFTrend { CONVERGING, RISING, OSCILLATING, STAGNATING }\n9. 方法：SCFTrend analyze_trend() — 分析最近N步的趋势\n10. 方法：void try_recover() — 执行回退操作"
    },
    {
      "action": "modify",
      "path": "source/source_estate/module_charge/charge_mixing.cpp",
      "spec": "在mix_rho()或mix_dmr()的入口处添加监控逻辑：\n1. 记录当前步的能量和残差到history\n2. 调用analyze_trend()判断趋势\n3. 根据趋势采取行动：\n   - CONVERGING: 无操作\n   - RISING（连续3步能量上升）: mixing_beta *= 0.5，如果有快照则回退\n   - OSCILLATING（能量交替升降，振幅>阈值）: mixing_beta *= 0.7，mixing_gg0 *= 1.3\n   - STAGNATING（残差不再下降但未收敛）: 尝试切换mixing方法（broyden→pulay）\n4. 每次调整后输出日志：'SCF auto-recover: detected [trend], adjusting mixing_beta to [value]'\n5. 在残差足够小时（如drho < 10*scf_thr），保存电荷密度快照用于后续回退"
    },
    {
      "action": "modify",
      "path": "source/source_io/module_parameter/input_parameter.h",
      "spec": "添加：\n1. bool scf_auto_recover = false\n2. int scf_recover_max = 3\n3. double scf_oscillation_threshold = 0.01 — 震荡检测阈值(eV)"
    }
  ],

  "implementation_notes": {
    "trend_detection": "analyze_trend()算法：\n1. RISING: energy[i] > energy[i-1] for last 3 steps\n2. OSCILLATING: sign(energy[i]-energy[i-1]) alternates for last 4 steps, AND max amplitude > threshold\n3. STAGNATING: drho[i]/drho[i-3] > 0.9 (残差几乎不变) for last 5 steps\n4. CONVERGING: none of the above",
    "charge_snapshot": "保存电荷密度快照的内存开销：对于100原子体系约100MB。只保存1个快照（最近的低能量状态）。回退时恢复该快照并重新开始mixing。",
    "mixing_method_switch": "切换mixing方法需要重置mixing历史（Broyden的子空间向量）。这是一个较大的操作，只在STAGNATING时使用。"
  },

  "test_plan": [
    "单元测试：analyze_trend()对各种能量序列正确分类",
    "单元测试：try_recover()正确调整mixing_beta",
    "集成测试：人工构造一个会震荡的体系，验证自动回退能挽救收敛",
    "回归测试：scf_auto_recover=false时行为完全不变"
  ],

  "acceptance_criteria": [
    "自动回退机制能检测到能量上升和震荡",
    "原本不收敛的f电子体系中>50%可通过自动回退收敛",
    "自动回退的日志输出清晰，用户可理解发生了什么",
    "不影响已经能正常收敛的体系"
  ]
}
